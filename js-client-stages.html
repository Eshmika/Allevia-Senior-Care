<script>
  function toggleClientStage(stageId) {
    const content = document.getElementById(`content-${stageId}`);
    const icon = document.getElementById(`icon-${stageId}`);
    if (content) {
      content.classList.toggle("hidden");
    }
    if (icon) {
      icon.classList.toggle("ph-caret-down");
      icon.classList.toggle("ph-caret-up");
    }
  }

  let allClientsData = [];

  function loadClientStages() {
    google.script.run
      .withSuccessHandler((clients) => {
        allClientsData = clients;
        renderClientStages(clients);
      })
      .getClientList();
  }

  function filterArchives() {
    const search = document
      .getElementById("archiveSearch")
      ?.value.toLowerCase();
    if (!search) {
      renderClientStages(allClientsData);
      return;
    }
    const filtered = allClientsData.filter((c) => {
      const isArchived = c.stage === "Archived";
      const matchesSearch =
        c.name.toLowerCase().includes(search) ||
        c.id.toLowerCase().includes(search);
      return isArchived && matchesSearch;
    });

    // We only want to update the ARCHIVES list here if we are filtering
    const archiveList = document.getElementById("list-stage-archives");
    if (archiveList) {
      archiveList.innerHTML = "";
      // Re-use logic or just call render with a modified set?
      // For simplicity, let's keep renderClientStages as the source of truth but allow it to take a partial list?
      // Actually, easier to just update the UI here for the archives specifically.
      if (filtered.length === 0) {
        archiveList.innerHTML =
          '<tr><td colspan="3" class="py-8 text-center text-gray-400">No matching archived records.</td></tr>';
      }
      // I'll need to reach into the rendering logic.
      // Better approach: make renderClientStages handle the search term.
    }
  }

  function renderClientStages(clients) {
    const searchTerm = document
      .getElementById("archiveSearch")
      ?.value.toLowerCase();

    const stages = {
      "New leads": document.getElementById("list-stage-new-leads"),
      Assessment: document.getElementById("list-stage-assessment"),
      "Insurance Verification": document.getElementById("list-stage-insurance"),
      "Client Agreements": document.getElementById("list-stage-agreements"),
      "Convert Clients": document.getElementById("list-stage-converted"),
      Archived: document.getElementById("list-stage-archives"),
    };

    const counts = {
      "New leads": 0,
      Assessment: 0,
      "Insurance Verification": 0,
      "Client Agreements": 0,
      "Convert Clients": 0,
      Archived: 0,
    };

    // Clear existing content
    Object.values(stages).forEach((stage) => {
      if (stage) stage.innerHTML = "";
    });

    clients.forEach((client) => {
      const stage = client.stage || "New leads";
      if (!stages[stage]) return;

      // Increment count for stats card
      counts[stage]++;

      // Filter archives if search term exists
      if (stage === "Archived" && searchTerm) {
        const matchesSearch =
          client.name.toLowerCase().includes(searchTerm) ||
          client.id.toLowerCase().includes(searchTerm);
        if (!matchesSearch) return;
      }

      const row = document.createElement("tr");
      const isArchiveView = stage === "Archived";
      const tdClass = isArchiveView ? "px-6 py-4" : "py-2";

      let actionHtml = `
                    <button onclick="loadClientProfile('${client.id}')" class="text-blue-500 hover:underline">View</button>
                `;

      if (stage === "New leads") {
        if (client.status === "Cancelled service") {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <span class="text-xs text-red-600 font-bold mr-2">Failed</span>
                            <button onclick="undoFailClient('${client.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 flex items-center gap-1">
                                <i class="ph ph-arrow-u-up-left"></i> Undo
                            </button>
                        </div>
                    `;
        } else {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <button onclick="passClient('${client.id}')" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200">Pass</button>
                            <button onclick="failClient('${client.id}')" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200">Fail</button>
                        </div>
                    `;
        }
      } else if (stage === "Assessment") {
        if (client.status === "Cancelled service") {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <span class="text-xs text-red-600 font-bold mr-2">Failed</span>
                            <button onclick="undoFailClient('${client.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 flex items-center gap-1">
                                <i class="ph ph-arrow-u-up-left"></i> Undo
                            </button>
                        </div>
                    `;
        } else if (client.assessmentFilled) {
          actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="passAssessment('${client.id}')" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200">Pass</button>
                        <button onclick="failAssessment('${client.id}')" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200">Fail</button>
                        <button onclick="openAssessmentForm('${client.id}')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-bold hover:bg-gray-200">Edit</button>
                    </div>
                `;
        } else {
          actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="openAssessmentForm('${client.id}')" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold hover:bg-purple-200 flex items-center gap-1">
                            <i class="ph ph-plus-circle"></i> Add Details
                        </button>
                    </div>
                `;
        }
      } else if (stage === "Insurance Verification") {
        if (client.status === "Archived") {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <span class="text-xs text-gray-600 font-bold mr-2">Archived</span>
                            <button onclick="undoArchiveClient('${client.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 flex items-center gap-1">
                                <i class="ph ph-arrow-u-up-left"></i> Undo
                            </button>
                        </div>
                    `;
        } else if (client.paymentFilled) {
          actionHtml = `
                    <div class="flex flex-wrap items-center justify-end gap-2 px-4">
                        <button onclick="openInsurancePendingDialog('${client.id}')" class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-200 flex items-center gap-1">
                            <i class="ph ph-clock"></i> Pending
                        </button>
                        <button onclick="openInsuranceDeniedDialog('${client.id}')" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200 flex items-center gap-1">
                            <i class="ph ph-x-circle"></i> Denied
                        </button>
                        <button onclick="approveInsurance('${client.id}')" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200 flex items-center gap-1">
                            <i class="ph ph-check-circle"></i> Approval
                        </button>
                        <button onclick="openPaymentForm('${client.id}')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-bold hover:bg-gray-200 flex items-center gap-1">
                            <i class="ph ph-pencil"></i> Edit
                        </button>
                    </div>
                `;
        } else {
          actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="openPaymentForm('${client.id}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold hover:bg-blue-200 flex items-center gap-1">
                            <i class="ph ph-credit-card"></i> Add Payment
                        </button>
                    </div>
                `;
        }
      } else if (stage === "Archived") {
        actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="undoArchiveClient('${client.id}')" class="flex items-center gap-2 px-3 py-1.5 bg-white text-gray-700 rounded-lg text-xs font-bold hover:bg-blue-50 hover:text-blue-600 transition-all border border-gray-200 shadow-sm">
                            <i class="ph-bold ph-arrow-u-up-left"></i> Restore Client
                        </button>
                    </div>
                `;
      }

      const statusHtml = `
                    <div class="flex flex-col gap-1">
                        <span class="inline-block w-fit px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-600">${
                          client.status
                        }</span>
                        ${
                          client.insuranceNote
                            ? `<div class="text-[10px] text-gray-400 italic whitespace-pre-wrap break-words mt-1 leading-relaxed">${client.insuranceNote}</div>`
                            : ""
                        }
                    </div>
                `;

      row.innerHTML = `
                    <td class="${tdClass}">
                        <div class="font-medium text-gray-800">${client.name}</div>
                        <div class="text-[10px] text-gray-400">${client.id}</div>
                    </td>
                    <td class="${tdClass}">
                        ${statusHtml}
                    </td>
                    <td class="${tdClass} text-right">
                        ${actionHtml}
                    </td>
                `;
      stages[stage].appendChild(row);
    });

    document.getElementById("count-stage-new-leads").textContent =
      counts["New leads"];
    document.getElementById("count-stage-assessment").textContent =
      counts["Assessment"];
    document.getElementById("count-stage-insurance").textContent =
      counts["Insurance Verification"];
    document.getElementById("count-stage-agreements").textContent =
      counts["Client Agreements"];
    document.getElementById("count-stage-converted").textContent =
      counts["Convert Clients"];
    document.getElementById("count-stage-archives").textContent =
      counts["Archived"];
  }

  function passClient(clientId) {
    Swal.fire({
      title: "Pass Lead?",
      text: "Move this lead to the Assessment stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Pass",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Passed!", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Assessment");
      }
    });
  }

  function failClient(clientId) {
    Swal.fire({
      title: "Fail Lead?",
      text: "Mark this lead as failed? (Status will be set to Cancelled)",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Yes, Fail",
    }).then((result) => {
      if (result.isConfirmed) {
        // First update status to Cancelled
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Archived",
                "Lead has been moved to archives.",
                "success",
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .archiveClient(clientId, "Lead generation failed");
      }
    });
  }

  function undoFailClient(clientId) {
    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) {
          Swal.fire("Reverted", "Lead status has been restored.", "success");
          loadClientStages();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClientStatus(clientId, "Active");
  }

  function passAssessment(clientId) {
    Swal.fire({
      title: "Pass Assessment?",
      text: "Move this client to the Insurance Verification stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Pass",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Passed!", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Insurance Verification");
      }
    });
  }

  function failAssessment(clientId) {
    Swal.fire({
      title: "Fail Assessment?",
      text: "Mark this assessment as failed? (Status will be set to Cancelled)",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Yes, Fail",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Archived",
                "Assessment has been moved to archives.",
                "success",
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .archiveClient(clientId, "Assessment failed");
      }
    });
  }

  function passInsurance(clientId) {
    Swal.fire({
      title: "Pass Insurance Verification?",
      text: "Move this client to the Client Agreements stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Pass",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Passed!", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Client Agreements");
      }
    });
  }

  function openInsurancePendingDialog(clientId) {
    Swal.fire({
      title: "Mark as Pending",
      html: `
        <div class="text-left space-y-4">
          <p class="text-gray-700 text-sm font-semibold mb-3">What is the pending reason?</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
              <input type="radio" name="pendingReason" value="Verify Coverage" class="w-4 h-4 text-blue-600" />
              <span class="text-sm text-gray-700">Verify Coverage</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
              <input type="radio" name="pendingReason" value="Eligibility" class="w-4 h-4 text-blue-600" />
              <span class="text-sm text-gray-700">Eligibility</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
              <input type="radio" name="pendingReason" value="Financial Approval" class="w-4 h-4 text-blue-600" />
              <span class="text-sm text-gray-700">Financial Approval</span>
            </label>
          </div>
          <div class="mt-4">
            <label class="text-sm font-semibold text-gray-700 block mb-2">Add Note (Optional):</label>
            <textarea id="pendingNote" class="w-full p-3 border border-gray-300 rounded-lg text-sm" placeholder="Add any additional details..." rows="3" style="font-family: inherit;"></textarea>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonColor: "#f59e0b",
      confirmButtonText: "Mark Pending",
      cancelButtonText: "Cancel",
      didOpen: () => {
        // Set the first option as selected by default
        document.querySelector('input[name="pendingReason"]').checked = true;
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const reason = document.querySelector(
          'input[name="pendingReason"]:checked',
        )?.value;
        const note = document.getElementById("pendingNote").value;

        if (!reason) {
          Swal.fire("Error", "Please select a reason", "error");
          return;
        }

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Pending",
                `Status updated to Pending - ${reason}`,
                "success",
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientInsurancePending(clientId, reason, note);
      }
    });
  }

  function openInsuranceDeniedDialog(clientId) {
    Swal.fire({
      title: "Mark as Denied",
      html: `
        <div class="text-left space-y-4">
          <p class="text-gray-700 text-sm font-semibold mb-3">What is the reason for denial?</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Insurance Declined" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Insurance Declined</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Financial Ineligibility" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Financial Ineligibility</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Cancel Service" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Cancel Service</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Other" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Other</span>
            </label>
          </div>
          <div class="mt-4">
            <label class="text-sm font-semibold text-gray-700 block mb-2">Add Note (Required):</label>
            <textarea id="denialNote" class="w-full p-3 border border-gray-300 rounded-lg text-sm" placeholder="Explain the reason for denial..." rows="3" style="font-family: inherit;"></textarea>
          </div>
          <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
            <p class="text-xs text-orange-800"><strong>Note:</strong> This client will be moved to Archive.</p>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Mark Denied & Archive",
      cancelButtonText: "Cancel",
      didOpen: () => {
        document.querySelector('input[name="denialReason"]').checked = true;
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const reason = document.querySelector(
          'input[name="denialReason"]:checked',
        )?.value;
        const note = document.getElementById("denialNote").value;

        if (!reason) {
          Swal.fire("Error", "Please select a reason", "error");
          return;
        }

        if (!note.trim()) {
          Swal.fire(
            "Error",
            "Please add a note explaining the denial",
            "error",
          );
          return;
        }

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Denied",
                "Client has been marked as Denied and archived.",
                "success",
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientInsuranceDenied(clientId, reason, note);
      }
    });
  }

  function approveInsurance(clientId) {
    Swal.fire({
      title: "Approve Insurance Verification?",
      html: `
        <div class="space-y-4">
          <p class="text-gray-700">Move this client to the Client Agreements stage?</p>
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-800"><i class="ph ph-check-circle"></i> <strong>Insurance verification approved.</strong> Client is ready for next stage.</p>
          </div>
        </div>
      `,
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Approve",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Approved!",
                "Client moved to Client Agreements stage.",
                "success",
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Client Agreements");
      }
    });
  }

  function undoArchiveClient(clientId) {
    Swal.fire({
      title: "Undo Archive?",
      text: "Restore this client back to Insurance Verification stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#3b82f6",
      confirmButtonText: "Yes, Restore",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Restored",
                "Client has been restored to Insurance Verification.",
                "success",
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .restoreClientFromArchive(clientId);
      }
    });
  }
</script>
