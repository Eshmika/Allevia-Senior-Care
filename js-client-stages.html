<script>
  function toggleClientStage(stageId) {
    const content = document.getElementById(`content-${stageId}`);
    const icon = document.getElementById(`icon-${stageId}`);
    if (content) {
      content.classList.toggle("hidden");
    }
    if (icon) {
      icon.classList.toggle("ph-caret-down");
      icon.classList.toggle("ph-caret-up");
    }
  }

  let allClientsData = [];

  function loadClientStages() {
    google.script.run
      .withSuccessHandler((clients) => {
        allClientsData = clients;
        renderClientStages(clients);
      })
      .getClientList();
  }

  function filterArchives() {
    renderClientStages(allClientsData);
  }

  function renderClientStages(clients) {
    const searchTerm = document
      .getElementById("archiveSearch")
      ?.value.toLowerCase();

    const stages = {
      "New leads": document.getElementById("list-stage-new-leads"),
      Assessment: document.getElementById("list-stage-assessment"),
      "Insurance Verification": document.getElementById("list-stage-insurance"),
      "Client Agreements": document.getElementById("list-stage-agreements"),
      "Convert Clients": document.getElementById("list-stage-converted"),
      Archived: document.getElementById("list-stage-archives"),
    };

    const counts = {
      "New leads": 0,
      Assessment: 0,
      "Insurance Verification": 0,
      "Client Agreements": 0,
      "Convert Clients": 0,
      Archived: 0,
    };

    // Clear existing content
    Object.values(stages).forEach((stage) => {
      if (stage) stage.innerHTML = "";
    });

    clients.forEach((client) => {
      const stage = client.stage || "New leads";
      if (!stages[stage]) return;

      // Increment count for stats card
      counts[stage]++;

      // Filter archives if search term exists
      if (stage === "Archived" && searchTerm) {
        const matchesSearch =
          client.name.toLowerCase().includes(searchTerm) ||
          client.id.toLowerCase().includes(searchTerm);
        if (!matchesSearch) return;
      }

      const row = document.createElement("tr");
      const isArchiveView = stage === "Archived";
      const tdClass = isArchiveView ? "px-6 py-4" : "py-2";

      let actionHtml = `
                    <button onclick="loadClientProfile('${client.id}')" class="text-blue-500 hover:underline">View</button>
                `;

      if (stage === "New leads") {
        if (client.status === "Cancelled service") {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <span class="text-xs text-red-600 font-bold mr-2">Failed</span>
                            <button onclick="undoFailClient('${client.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 flex items-center gap-1">
                                <i class="ph ph-arrow-u-up-left"></i> Undo
                            </button>
                        </div>
                    `;
        } else {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <button onclick="passClient('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #1ABC9C;">Approve</button>
                            <button onclick="failClient('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #E74C3C;">Deny</button>
                        </div>
                    `;
        }
      } else if (stage === "Assessment") {
        if (client.status === "Cancelled service") {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <span class="text-xs text-red-600 font-bold mr-2">Failed</span>
                            <button onclick="undoFailClient('${client.id}')" class="text-xs text-white px-3 py-1 rounded-full hover:opacity-90 font-bold border border-0 flex items-center gap-1" style="background-color: #5C6BC0;">
                                <i class="ph ph-arrow-u-up-left"></i> Undo
                            </button>
                        </div>
                    `;
        } else if (client.assessmentFilled) {
          actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="passAssessment('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #1ABC9C;">Approve</button>
                        <button onclick="failAssessment('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #E74C3C;">Deny</button>
                        <button onclick="openAssessmentForm('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #9B59B6;">Edit</button>
                        <button onclick="undoAssessment('${client.id}')" title="Return to New Leads" class="w-8 h-8 flex items-center justify-center text-white rounded-lg hover:opacity-90 border border-0 transition-colors" style="background-color: #5C6BC0;">
                            <i class="ph-bold ph-arrow-u-up-left"></i>
                        </button>
                    </div>
                `;
        } else {
          actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="openAssessmentForm('${client.id}')" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold hover:bg-purple-200 flex items-center gap-1">
                            <i class="ph ph-plus-circle"></i> Add Details
                        </button>
                    </div>
                `;
        }
      } else if (stage === "Insurance Verification") {
        if (client.status === "Archived") {
          actionHtml = `
                        <div class="flex items-center justify-end gap-2 px-4">
                            <span class="text-xs text-gray-600 font-bold mr-2">Archived</span>
                            <button onclick="undoArchiveClient('${client.id}')" class="text-xs text-white px-3 py-1 rounded-full hover:opacity-90 font-bold border border-0 flex items-center gap-1" style="background-color: #5C6BC0;">
                                <i class="ph ph-arrow-u-up-left"></i> Undo
                            </button>
                        </div>
                    `;
        } else if (client.paymentFilled) {
          actionHtml = `
                    <div class="flex flex-wrap items-center justify-end gap-2 px-4">
                        <button onclick="openInsurancePendingDialog('${client.id}')" class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-200 flex items-center gap-1">
                            <i class="ph ph-clock"></i> Pending
                        </button>
                        <button onclick="openInsuranceDeniedDialog('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90 flex items-center gap-1" style="background-color: #E74C3C;">
                            <i class="ph ph-x-circle"></i> Deny
                        </button>
                        <button onclick="approveInsurance('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90 flex items-center gap-1" style="background-color: #1ABC9C;">
                            <i class="ph ph-check-circle"></i> Approve
                        </button>
                        <button onclick="openPaymentForm('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90 flex items-center gap-1" style="background-color: #9B59B6;">
                            <i class="ph ph-pencil"></i> Edit
                        </button>
                    </div>
                `;
        } else {
          actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="openPaymentForm('${client.id}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold hover:bg-blue-200 flex items-center gap-1">
                            <i class="ph ph-credit-card"></i> Add Payment
                        </button>
                        <button onclick="undoInsuranceVerification('${client.id}')" title="Return to Assessment" class="w-8 h-8 flex items-center justify-center text-white rounded-lg hover:opacity-90 border border-0 transition-colors" style="background-color: #5C6BC0;">
                            <i class="ph-bold ph-arrow-u-up-left"></i>
                        </button>
                    </div>
                `;
        }
      } else if (stage === "Client Agreements") {
        const docs = [
          {
            link: client.agreementLink,
            name: "Agreement",
            icon: "handshake",
            color: "blue",
          },
          {
            link: client.exhibitALink,
            name: "Ex. A",
            icon: "list-checks",
            color: "purple",
          },
          {
            link: client.exhibitBLink,
            name: "Ex. B",
            icon: "clipboard-text",
            color: "purple",
          },
          {
            link: client.billOfRightsLink,
            name: "Rights",
            icon: "scroll",
            color: "indigo",
          },
          {
            link: client.hipaaLink,
            name: "HIPAA",
            icon: "shield-check",
            color: "rose",
          },
          {
            link: client.privacyLink,
            name: "Privacy",
            icon: "lock-key",
            color: "emerald",
          },
        ];

        let docButtons = docs
          .filter((doc) => doc.link)
          .map(
            (doc) => `
            <a href="${doc.link}" target="_blank" title="View ${doc.name}" 
               class="flex items-center justify-center w-8 h-8 rounded-lg bg-${doc.color}-50 text-${doc.color}-600 border border-${doc.color}-100 hover:bg-${doc.color}-100 hover:scale-105 transition-all shadow-sm">
                <i class="ph-bold ph-${doc.icon}"></i>
            </a>
            `
          )
          .join("");

        if (!docButtons) {
          docButtons = `<span class="text-xs text-gray-400 italic">No docs signed</span>`;
        }

        // Check if all documents are signed (have a link)
        const signedCount = docs.filter(
          (doc) => doc.link && doc.link.trim() !== ""
        ).length;
        const allSigned = signedCount === 6;

        let passFailButtons = "";
        if (allSigned) {
          passFailButtons = `
                <div class="h-6 w-px bg-gray-300"></div>
                <button onclick="passClientAgreement('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #1ABC9C;">Approve</button>
                <button onclick="failClientAgreement('${client.id}')" class="px-2 py-1 text-white rounded text-xs font-bold hover:opacity-90" style="background-color: #E74C3C;">Deny</button>
            `;
        }

        actionHtml = `
            <div class="flex items-center justify-end gap-3 px-4">
                <div class="flex items-center gap-1 bg-gray-50 p-1 rounded-lg border border-gray-100">
                    ${docButtons}
                </div>
                ${passFailButtons}
                <div class="h-6 w-px bg-gray-300"></div>
                <button onclick="resendIntakeEmail('${client.id}')" title="Resend Intake Email" class="w-8 h-8 flex items-center justify-center bg-orange-50 text-orange-600 rounded-lg hover:bg-orange-100 border border-orange-100 transition-colors">
                    <i class="ph-bold ph-envelope-simple"></i>
                </button>
                <button onclick="undoClientAgreement('${client.id}')" title="Return to Insurance Stage" class="w-8 h-8 flex items-center justify-center text-white rounded-lg hover:opacity-90 border border-0 transition-colors" style="background-color: #5C6BC0;">
                    <i class="ph-bold ph-arrow-u-up-left"></i>
                </button>
            </div>
        `;
      } else if (stage === "Convert Clients") {
        actionHtml = `
            <div class="flex items-center justify-end gap-2 px-4">
                <button onclick="resendWelcomeEmail('${client.id}')" class="flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded text-xs font-bold hover:bg-green-100 transition-colors border border-green-100">
                    <i class="ph-bold ph-envelope-simple"></i> Resend Welcome Email
                </button>
            </div>
        `;
      } else if (stage === "Archived") {
        actionHtml = `
                    <div class="flex items-center justify-end gap-2 px-4">
                        <button onclick="undoArchiveClient('${client.id}')" class="flex items-center gap-2 px-3 py-1.5 text-white rounded-lg text-xs font-bold hover:opacity-90 transition-all border border-0 shadow-sm" style="background-color: #5C6BC0;">
                            <i class="ph-bold ph-arrow-u-up-left"></i> Restore Client
                        </button>
                    </div>
                `;
      }

      const statusHtml = `
                    <div class="flex flex-col gap-1">
                        <span class="inline-block w-fit px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-600">${
                          client.status
                        }</span>
                        ${
                          client.insuranceNote
                            ? `<div class="text-[10px] text-gray-400 italic whitespace-pre-wrap break-words mt-1 leading-relaxed">${client.insuranceNote}</div>`
                            : ""
                        }
                    </div>
                `;

      row.innerHTML = `
                    <td class="${tdClass}">
                        <div class="font-medium text-gray-800">${client.name}</div>
                        <div class="text-[10px] text-gray-400">${client.id}</div>
                    </td>
                    <td class="${tdClass}">
                        ${statusHtml}
                    </td>
                    <td class="${tdClass} text-right">
                        ${actionHtml}
                    </td>
                `;
      stages[stage].appendChild(row);
    });

    document.getElementById("count-stage-new-leads").textContent =
      counts["New leads"];
    document.getElementById("count-stage-assessment").textContent =
      counts["Assessment"];
    document.getElementById("count-stage-insurance").textContent =
      counts["Insurance Verification"];
    document.getElementById("count-stage-agreements").textContent =
      counts["Client Agreements"];
    document.getElementById("count-stage-converted").textContent =
      counts["Convert Clients"];
    document.getElementById("count-stage-archives").textContent =
      counts["Archived"];

    // Handle empty search results for archives
    if (
      searchTerm &&
      stages["Archived"] &&
      stages["Archived"].innerHTML === ""
    ) {
      stages["Archived"].innerHTML = `
        <tr>
          <td colspan="3" class="px-6 py-10 text-center text-gray-400">
            <div class="flex flex-col items-center gap-2">
              <i class="ph ph-magnifying-glass text-2xl"></i>
              <span>No archived records found matching "${searchTerm}"</span>
            </div>
          </td>
        </tr>
      `;
    }
  }

  function passClient(clientId) {
    Swal.fire({
      title: "Pass Lead?",
      text: "Move this lead to the Assessment stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Pass",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Passed!", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Assessment");
      }
    });
  }

  function failClient(clientId) {
    Swal.fire({
      title: "Fail Lead?",
      text: "Mark this lead as failed? This will move the client to the Archived list.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Yes, Fail",
    }).then((result) => {
      if (result.isConfirmed) {
        // First update status to Cancelled
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Archived",
                "Lead has been moved to archives.",
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .archiveClient(clientId, "Lead generation failed");
      }
    });
  }

  function undoFailClient(clientId) {
    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) {
          Swal.fire("Reverted", "Lead status has been restored.", "success");
          loadClientStages();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClientStatus(clientId, "In progress");
  }

  function passAssessment(clientId) {
    Swal.fire({
      title: "Pass Assessment?",
      text: "Move this client to the Insurance Verification stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Pass",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Passed!", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Insurance Verification");
      }
    });
  }

  function failAssessment(clientId) {
    Swal.fire({
      title: "Fail Assessment?",
      text: "Mark this assessment as failed? This will move the client to the Archived list.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Yes, Fail",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Archived",
                "Assessment has been moved to archives.",
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .archiveClient(clientId, "Assessment failed");
      }
    });
  }

  function passInsurance(clientId) {
    Swal.fire({
      title: "Pass Insurance Verification?",
      text: "Move this client to the Client Agreements stage?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Pass",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Passed!", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Client Agreements");
      }
    });
  }

  function openInsurancePendingDialog(clientId) {
    Swal.fire({
      title: "Mark as Pending",
      html: `
        <div class="text-left space-y-4">
          <p class="text-gray-700 text-sm font-semibold mb-3">What is the pending reason?</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
              <input type="radio" name="pendingReason" value="Verify Coverage" class="w-4 h-4 text-blue-600" />
              <span class="text-sm text-gray-700">Verify Coverage</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
              <input type="radio" name="pendingReason" value="Eligibility" class="w-4 h-4 text-blue-600" />
              <span class="text-sm text-gray-700">Eligibility</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
              <input type="radio" name="pendingReason" value="Financial Approval" class="w-4 h-4 text-blue-600" />
              <span class="text-sm text-gray-700">Financial Approval</span>
            </label>
          </div>
          <div class="mt-4">
            <label class="text-sm font-semibold text-gray-700 block mb-2">Add Note (Optional):</label>
            <textarea id="pendingNote" class="w-full p-3 border border-gray-300 rounded-lg text-sm" placeholder="Add any additional details..." rows="3" style="font-family: inherit;"></textarea>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonColor: "#f59e0b",
      confirmButtonText: "Mark Pending",
      cancelButtonText: "Cancel",
      didOpen: () => {
        // Set the first option as selected by default
        document.querySelector('input[name="pendingReason"]').checked = true;
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const reason = document.querySelector(
          'input[name="pendingReason"]:checked'
        )?.value;
        const note = document.getElementById("pendingNote").value;

        if (!reason) {
          Swal.fire("Error", "Please select a reason", "error");
          return;
        }

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Pending",
                `Status updated to Pending - ${reason}`,
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientInsurancePending(clientId, reason, note);
      }
    });
  }

  function openInsuranceDeniedDialog(clientId) {
    Swal.fire({
      title: "Mark as Denied",
      html: `
        <div class="text-left space-y-4">
          <p class="text-gray-700 text-sm font-semibold mb-3">What is the reason for denial?</p>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Insurance Declined" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Insurance Declined</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Financial Ineligibility" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Financial Ineligibility</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Cancel Service" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Cancel Service</span>
            </label>
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 transition">
              <input type="radio" name="denialReason" value="Other" class="w-4 h-4 text-red-600" />
              <span class="text-sm text-gray-700">Other</span>
            </label>
          </div>
          <div class="mt-4">
            <label class="text-sm font-semibold text-gray-700 block mb-2">Add Note (Required):</label>
            <textarea id="denialNote" class="w-full p-3 border border-gray-300 rounded-lg text-sm" placeholder="Explain the reason for denial..." rows="3" style="font-family: inherit;"></textarea>
          </div>
          <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
            <p class="text-xs text-orange-800"><strong>Note:</strong> This client will be moved to Archive.</p>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Mark Denied & Archive",
      cancelButtonText: "Cancel",
      didOpen: () => {
        document.querySelector('input[name="denialReason"]').checked = true;
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const reason = document.querySelector(
          'input[name="denialReason"]:checked'
        )?.value;
        const note = document.getElementById("denialNote").value;

        if (!reason) {
          Swal.fire("Error", "Please select a reason", "error");
          return;
        }

        if (!note.trim()) {
          Swal.fire(
            "Error",
            "Please add a note explaining the denial",
            "error"
          );
          return;
        }

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Denied",
                "Client has been marked as Denied and archived.",
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientInsuranceDenied(clientId, reason, note);
      }
    });
  }

  function approveInsurance(clientId) {
    Swal.fire({
      title: "Approve Insurance Verification?",
      html: `
        <div class="space-y-4">
          <p class="text-gray-700">Move this client to the Client Agreements stage?</p>
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-800"><i class="ph ph-check-circle"></i> <strong>Insurance verification approved.</strong> Client is ready for next stage.</p>
            <p class="text-xs text-green-600 mt-2">An email with the Intake Packet will be sent to the client.</p>
          </div>
        </div>
      `,
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#65c027",
      confirmButtonText: "Yes, Approve & Send Email",
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: "Processing",
          text: "Updating stage and sending email...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              // Now send the email
              google.script.run
                .withSuccessHandler((emailRes) => {
                  Swal.fire(
                    "Approved!",
                    "Client moved to Client Agreements stage. " +
                      (emailRes.success
                        ? "Email sent!"
                        : "Warning: Email failed to send."),
                    "success"
                  );
                  loadClientStages();
                })
                .sendIntakePacketEmail(clientId);
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Client Agreements");
      }
    });
  }

  function resendIntakeEmail(clientId) {
    Swal.fire({
      title: "Sending Email",
      text: "Please wait...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) {
          Swal.fire(
            "Sent!",
            "Intake packet email has been re-sent.",
            "success"
          );
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .sendIntakePacketEmail(clientId);
  }

  function undoAssessment(clientId) {
    Swal.fire({
      title: "Undo Stage?",
      text: "Move this client back to New Leads?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#5C6BC0",
      confirmButtonText: "Yes, Undo",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Restored",
                "Client moved back to New Leads.",
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "New leads");
      }
    });
  }

  function undoInsuranceVerification(clientId) {
    Swal.fire({
      title: "Undo Stage?",
      text: "Move this client back to Assessment?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#5C6BC0",
      confirmButtonText: "Yes, Undo",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Restored",
                "Client moved back to Assessment.",
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Assessment");
      }
    });
  }

  function undoClientAgreement(clientId) {
    Swal.fire({
      title: "Undo Stage?",
      text: "Move this client back to Insurance Verification?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#5C6BC0",
      confirmButtonText: "Yes, Undo",
    }).then((result) => {
      if (result.isConfirmed) {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Restored",
                "Client moved back to Insurance Verification.",
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClientStage(clientId, "Insurance Verification");
      }
    });
  }

  function undoArchiveClient(clientId) {
    Swal.fire({
      title: "Restore Client",
      text: "Select the stage to restore this client to:",
      input: "select",
      inputOptions: {
        "New leads": "New leads",
        Assessment: "Assessment",
        "Insurance Verification": "Insurance Verification",
        "Client Agreements": "Client Agreements",
        "Convert Clients": "Convert Clients",
      },
      inputValue: "New leads",
      showCancelButton: true,
      confirmButtonColor: "#3b82f6",
      confirmButtonText: "Yes, Restore",
    }).then((result) => {
      if (result.isConfirmed) {
        const targetStage = result.value;
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Restored",
                `Client has been restored to ${targetStage}.`,
                "success"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .restoreClientFromArchive(clientId, targetStage);
      }
    });
  }

  function passClientAgreement(clientId) {
    Swal.fire({
      title: "Pass Agreement Stage",
      text: "Are you sure you want to move this client to 'Convert Clients'?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#22c55e",
      confirmButtonText: "Yes, Pass & Send Email",
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: "Processing",
          text: "Updating stage and sending welcome email...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Success", res.message, "success");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .processClientConversion(clientId);
      }
    });
  }

  function resendWelcomeEmail(clientId) {
    Swal.fire({
      title: "Resend Email",
      text: "Sending welcome email to client...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) {
          Swal.fire("Sent!", "Welcome email has been sent.", "success");
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .sendWelcomeClientEmail(clientId);
  }

  function failClientAgreement(clientId) {
    Swal.fire({
      title: "Fail Client Agreement",
      text: "Please enter a reason for failing this client (will be archived):",
      input: "textarea",
      inputPlaceholder: "Enter note...",
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      confirmButtonText: "Fail & Archive",
      inputValidator: (value) => {
        if (!value) {
          return "You need to write something!";
        }
      },
    }).then((result) => {
      if (result.isConfirmed) {
        const note = result.value;
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire(
                "Archived",
                "Client failed agreements and archived.",
                "info"
              );
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .archiveClient(clientId, note);
      }
    });
  }
</script>
