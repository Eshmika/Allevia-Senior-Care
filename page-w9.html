<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      /* Tailwind Polyfill for PDF Generation */
      .text-center { text-align: center; }
      .text-justify { text-align: justify; }
      .font-bold { font-weight: 700; }
      .font-semibold { font-weight: 600; }
      .text-2xl { font-size: 1.5rem; line-height: 2rem; }
      .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
      .underline { text-decoration: underline; }
      .italic { font-style: italic; }
      .mb-6 { margin-bottom: 1.5rem; }
      .mb-4 { margin-bottom: 1rem; }
      .mt-2 { margin-top: 0.5rem; }
      .mt-4 { margin-top: 1rem; }
      .p-8 { padding: 2rem; }
      .px-8 { padding-left: 2rem; padding-right: 2rem; }
      .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
      .space-y-2 > * + * { margin-top: 0.5rem; }
      .space-y-6 > * + * { margin-top: 1.5rem; }
      .w-full { width: 100%; }
      .border { border-width: 1px; border-style: solid; }
      .border-gray-300 { border-color: #d1d5db; }
      .border-black { border-color: #000; }
      .border-r { border-right-width: 1px; }
      .border-b { border-bottom-width: 1px; }
      .rounded-md { border-radius: 0.375rem; }
      .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
      .p-2 { padding: 0.5rem; }
      .block { display: block; }
      .flex { display: flex; }
      .grid { display: grid; }
      .grid-cols-12 { grid-template-columns: repeat(12, minmax(0, 1fr)); }
      .col-span-3 { grid-column: span 3 / span 3; }
      .col-span-6 { grid-column: span 6 / span 6; }
      .gap-4 { gap: 1rem; }
      .items-stretch { align-items: stretch; }
      .text-red-500 { color: #ef4444; }

      /* PDF Specific Overrides */
      <? if (isPdf) { ?>
        body { background-color: white !important; padding: 0 !important; }
        .shadow-lg { box-shadow: none !important; }
        .rounded-xl { border-radius: 0 !important; }
        .no-pdf { display: none !important; }
        /* Ensure inputs look like text in PDF */
        .pdf-value {
            border: none;
            border-bottom: 1px solid #000;
            padding: 4px 0;
            width: 100%;
            display: block;
            font-family: 'Courier New', Courier, monospace;
            min-height: 24px;
        }
        .pdf-check {
            font-size: 18px;
            line-height: 1;
            display: inline-block;
            width: 20px;
        }
      <? } ?>
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen py-10 px-4">
    <div
      class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden"
    >
      <div class="px-8 border-b border-black">
        <div class="grid grid-cols-12 gap-4 items-stretch">
          <div class="col-span-3 text-sm pr-4 border-r border-black">
            <p>
              Form <span class="text-2xl font-bold">W-9</span> (Rev. March 2024)
            </p>
            <p>Department of the Treasury<br />Internal Revenue Service</p>
          </div>
          <div class="col-span-6 text-center px-4 border-r border-black">
            <h1 class="text-2xl font-bold leading-tight">
              Request for Taxpayer
              <span class="block">Identification Number and Certification</span>
            </h1>
            <p class="font-bold text-sm mt-2">
              Go to www.irs.gov/FormW9 for instructions and the latest
              information.
            </p>
          </div>
          <div class="col-span-3 pl-4">
            <p class="font-bold">
              Give form to the requester. Do not send to the IRS.
            </p>
          </div>
        </div>
      </div>

      <div class="p-8">
        <p>
          <b>Before you begin.</b> For guidance related to the purpose of Form
          W-9, see Purpose of Form, below.
        </p>

        <form id="w9Form" class="space-y-6">
          <input type="hidden" name="caregiverId" value="<?= caregiverId ?>" />
          <div class="grid grid-cols-1 gap-6 text-justify">
            <div>
              <label class="input-label block font-semibold mt-2">
                1. Name of entity/individual. An entry is required. (For a sole
                proprietor or disregarded entity, enter the owner’s name on line
                1, and enter the business/disregarded entity’s name on line
                2.)<span class="text-red-500 no-pdf">*</span></label
              >
              <? if (isPdf) { ?>
              <div class="w-full border-b border-gray-400 py-2 mb-4">
                <?= caregiverData['First Name'] ?>
                <?= caregiverData['Middle Int'] ?>
                <?= caregiverData['Last Name'] ?>
              </div>
              <? } else { ?>
              <input
                type="text"
                name="name"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
                value="<?= caregiverData['First Name'] ?> <?= caregiverData['Middle Int'] ?> <?= caregiverData['Last Name'] ?>"
                required
                readonly
              />
              <? } ?>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                2. Business name/disregarded entity name, if different from
                above.</label
              >
              <? if (isPdf) { ?>
              <div class="pdf-value"><?= caregiverData.W9_BusinessName ?></div>
              <? } else { ?>
              <input
                type="text"
                name="businessName"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
              />
              <? } ?>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                3a. Check the appropriate box for federal tax classification of
                the entity/individual whose name is entered on line 1. Check
                only one of the following seven boxes.<span
                  class="text-red-500 no-pdf"
                  >*</span
                ></label
              >
              <div class="mt-2">
                <? if (isPdf) { ?>
                <!-- PDF View for Radio Buttons -->
                <div class="space-y-2">
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 'Individual/sole_proprietor' ? '☑' : '☐' ?></span
                    >
                    Individual/sole proprietor
                  </div>
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 'c_corporation' ? '☑' : '☐' ?></span
                    >
                    C corporation
                  </div>
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 's_corporation' ? '☑' : '☐' ?></span
                    >
                    S Corporation
                  </div>
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 'partnership' ? '☑' : '☐' ?></span
                    >
                    Partnership
                  </div>
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 'trust_estate' ? '☑' : '☐' ?></span
                    >
                    Trust/estate
                  </div>
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 'llc' ? '☑' : '☐' ?></span
                    >
                    LLC.
                    <? if (caregiverData.W9_TaxClassification === 'llc') { ?>
                    (Code:
                    <?= caregiverData.W9_TaxLlcClass ?>)
                    <? } ?>
                  </div>
                  <div>
                    <span class="pdf-check"
                      ><?= caregiverData.W9_TaxClassification === 'other' ? '☑' : '☐' ?></span
                    >
                    Other
                    <? if (caregiverData.W9_TaxClassification === 'other') { ?>
                    (<?= caregiverData.W9_TaxOtherText ?>)
                    <? } ?>
                  </div>
                </div>
                <? } else { ?>
                <!-- Web Form View for Radio Buttons -->
                <label class="flex items-start space-x-2">
                  <input
                    type="radio"
                    name="taxClassification"
                    value="Individual/sole_proprietor"
                    required
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm">Individual/sole proprietor</span>
                </label>

                <label class="flex items-start space-x-2">
                  <input
                    type="radio"
                    name="taxClassification"
                    value="c_corporation"
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm">C corporation</span>
                </label>

                <label class="flex items-start space-x-2">
                  <input
                    type="radio"
                    name="taxClassification"
                    value="s_corporation"
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm">S Corporation</span>
                </label>

                <label class="flex items-start space-x-2">
                  <input
                    type="radio"
                    name="taxClassification"
                    value="partnership"
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm">Partnership</span>
                </label>

                <label class="flex items-start space-x-2">
                  <input
                    type="radio"
                    name="taxClassification"
                    value="trust_estate"
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm">Trust/estate</span>
                </label>

                <label class="flex items-start space-x-2">
                  <input
                    id="tax-llc"
                    type="radio"
                    name="taxClassification"
                    value="llc"
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm"
                    >LLC. Enter the tax classification (C = C corporation, S = S
                    corporation, P = Partnership) <br /><b>Note:</b> Check the
                    “LLC” box above and, in the entry space, enter the
                    appropriate code (C, S, or P) for the tax classification of
                    the LLC, unless it is a disregarded entity. A disregarded
                    entity should instead check the appropriate box for the tax
                    classification of its owner.</span
                  >
                  <input
                    id="tax-llc-class"
                    type="text"
                    name="taxLlcClass"
                    placeholder="C, S, or P"
                    class="ml-2 flex-1 border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-1 text-sm"
                    disabled
                  />
                </label>

                <label class="flex items-start space-x-2 sm:col-span-2">
                  <input
                    id="tax-other"
                    type="radio"
                    name="taxClassification"
                    value="other"
                    class="mt-1 h-4 w-4 text-green-600 border-gray-300"
                  />
                  <span class="text-sm">Other (see instructions)</span>
                  <input
                    id="tax-other-text"
                    type="text"
                    name="taxOtherText"
                    placeholder="Specify"
                    class="ml-2 flex-1 border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-1 text-sm"
                    disabled
                  />
                </label>
                <? } ?>
              </div>

              <? if (!isPdf) { ?>
              <script>
                (function () {
                  const radios = document.querySelectorAll(
                    'input[name="taxClassification"]'
                  );
                  const otherRadio = document.getElementById("tax-other");
                  const otherText = document.getElementById("tax-other-text");
                  const llcRadio = document.getElementById("tax-llc");
                  const llcClass = document.getElementById("tax-llc-class");

                  function update() {
                    const isOther = !!(otherRadio && otherRadio.checked);
                    const isLLC = !!(llcRadio && llcRadio.checked);

                    if (otherText) {
                      otherText.disabled = !isOther;
                      otherText.required = isOther;
                    }

                    if (llcClass) {
                      llcClass.disabled = !isLLC;
                      llcClass.required = isLLC;
                    }
                  }

                  radios.forEach((r) => r.addEventListener("change", update));
                  update();
                })();
              </script>
              <? } ?>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                3b. If on line 3a you checked “Partnership” or “Trust/estate,”
                or checked “LLC” and entered “P” as its tax classification, and
                you are providing this form to a partnership, trust, or estate
                in which you have an ownership interest, check this box if you
                have any foreign partners, owners, or beneficiaries. See
                instructions.
              </label>
              <div class="flex items-start mt-2">
                <? if (isPdf) { ?>
                <span class="pdf-check"
                  ><?= caregiverData.W9_HasForeignOwners === 'Yes' ? '☑' : '☐' ?></span
                >
                <span class="ml-3 text-sm">Check this box if applicable.</span>
                <? } else { ?>
                <input
                  id="hasForeignOwners"
                  name="hasForeignOwners"
                  type="checkbox"
                  class="mt-1 h-4 w-4 text-green-600 border-gray-300 rounded"
                />
                <label for="hasForeignOwners" class="ml-3 text-sm">
                  Check this box if applicable.
                </label>
                <? } ?>
              </div>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                4. Exemptions (codes apply only to certain entities, not
                individuals; see instructions on page 3):</label
              >
              <div class="mt-2">
                <div>
                  <label class="block text-sm font-medium">
                    Exempt payee code (if any)
                  </label>
                  <? if (isPdf) { ?>
                  <div class="pdf-value">
                    <?= caregiverData.W9_ExemptPayeeCode ?>
                  </div>
                  <? } else { ?>
                  <input
                    type="text"
                    name="exemptPayeeCode"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
                  />
                  <? } ?>
                </div>
                <div>
                  <label class="block text-sm font-medium">
                    Exemption from Foreign Account Tax Compliance Act (FATCA)
                    reporting code (if any)
                  </label>
                  <? if (isPdf) { ?>
                  <div class="pdf-value"><?= caregiverData.W9_FatcaCode ?></div>
                  <? } else { ?>
                  <input
                    type="text"
                    name="fatcaCode"
                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
                  />
                  <? } ?>
                </div>
              </div>
              <p class="text-sm">
                <i
                  >(Applies to accounts maintained outside the United
                  States.)</i
                >
              </p>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                Requester’s name and address (optional)</label
              >
              <? if (isPdf) { ?>
              <div class="pdf-value"><?= caregiverData.W9_RequesterInfo ?></div>
              <? } else { ?>
              <input
                type="text"
                name="requesterInfo"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
              />
              <? } ?>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                5. Address (number, street, and apt. or suite no.). See
                instructions.<span class="text-red-500 no-pdf">*</span></label
              >
              <? if (isPdf) { ?>
              <div class="pdf-value"><?= caregiverData.W9_Address ?></div>
              <? } else { ?>
              <input
                type="text"
                name="address"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
                required
              />
              <? } ?>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                6. City, state, and ZIP code<span class="text-red-500 no-pdf"
                  >*</span
                ></label
              >
              <? if (isPdf) { ?>
              <div class="pdf-value"><?= caregiverData.W9_CityStateZip ?></div>
              <? } else { ?>
              <input
                type="text"
                name="cityStateZip"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
                required
              />
              <? } ?>
            </div>

            <div>
              <label class="input-label block font-semibold mt-2">
                7. List account number(s) here (optional)</label
              >
              <? if (isPdf) { ?>
              <div class="pdf-value">
                <?= caregiverData.W9_AccountNumbers ?>
              </div>
              <? } else { ?>
              <input
                type="text"
                name="accountNumbers"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
              />
              <? } ?>
            </div>

            <p><b>Part I</b> Taxpayer Identification Number (TIN)</p>
            <p>
              Enter your TIN in the appropriate box. The TIN provided must match
              the name given on line 1 to avoid backup withholding. For
              individuals, this is generally your social security number (SSN).
              However, for a resident alien, sole proprietor, or disregarded
              entity, see the instructions for Part I, later. For other
              entities, it is your employer identification number (EIN). If you
              do not have a number, see How to get a TIN, later. <br />Note: If
              the account is in more than one name, see the instructions for
              line 1. See also What Name and Number To Give the Requester for
              guidelines on whose number to enter.
            </p>

            <div>
              <label class="input-label block font-semibold mt-2">
                Social security number</label
              >
              <? if (isPdf) { ?>
              <div class="pdf-value"><?= caregiverData.W9_SSN ?></div>
              <? } else { ?>
              <input
                type="text"
                name="ssn"
                inputmode="numeric"
                placeholder="XXX-XX-XXXX"
                maxlength="11"
                pattern="^\d{3}-\d{2}-\d{4}$"
                title="Enter SSN as XXX-XX-XXXX"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 border p-2"
                oninput="this.value = this.value.replace(/[^0-9]/g,'').slice(0,9).replace(/(\d{3})(\d{2})(\d{0,4})/, (_,a,b,c) => c ? `${a}-${b}-${c}` : b ? `${a}-${b}` : a);"
              />
              <? } ?>
            </div>

            <p><b>Part II</b> Certification</p>
            <p>
              Under penalties of perjury, I certify that: <br />1. The number
              shown on this form is my correct taxpayer identification number
              (or I am waiting for a number to be issued to me); and <br />2. I
              am not subject to backup withholding because (a) I am exempt from
              backup withholding, or (b) I have not been notified by the
              Internal Revenue Service (IRS) that I am subject to backup
              withholding as a result of a failure to report all interest or
              dividends, or (c) the IRS has notified me that I am no longer
              subject to backup withholding; and <br />3. I am a U.S. citizen or
              other U.S. person (defined below); and <br />4. The FATCA code(s)
              entered on this form (if any) indicating that I am exempt from
              FATCA reporting is correct. <br /><b
                >Certification instructions.</b
              >You must cross out item 2 above if you have been notified by the
              IRS that you are currently subject to backup withholding because
              you have failed to report all interest and dividends on your tax
              return. For real estate transactions, item 2 does not apply. For
              mortgage interest paid, acquisition or abandonment of secured
              property, cancellation of debt, contributions to an individual
              retirement arrangement (IRA), and, generally, payments other than
              interest and dividends, you are not required to sign the
              certification, but you must provide your correct TIN. See the
              instructions for Part II, later.
            </p>

            <label class="flex gap-3 items-start cursor-pointer">
              <? if (isPdf) { ?>
              <span class="pdf-check">☑</span>
              <? } else { ?>
              <input
                type="checkbox"
                name="agreeEsign"
                required
                class="mt-0.5 accent-[#65c027] w-4 h-4 shrink-0"
              />
              <? } ?>
              <span class="italic">
                By electronically typing or signing my name below, I acknowledge
                and agree that this electronic representation of my name
                constitutes my legal signature. This electronic signature has
                the same validity, force, and effect as a handwritten signature
                under applicable state and federal law, including the ESIGN Act
                and the Uniform Electronic Transactions Act.
              </span>
            </label>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="input-label font-semibold block mb-1">
                  Digital Signature (Type Full Name)<span
                    class="text-red-500 no-pdf"
                    >*</span
                  >
                </label>
                <? if (isPdf) { ?>
                <div
                  class="pdf-value"
                  style="
                    font-family: 'Brush Script MT', cursive;
                    font-size: 1.2em;
                  "
                >
                  <?= caregiverData.Signature ?>
                </div>
                <? } else { ?>
                <input
                  type="text"
                  name="signature"
                  required
                  placeholder="Type your full name"
                  class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
                />
                <? } ?>
              </div>
              <div>
                <label class="input-label font-semibold block mb-1">
                  Date <span class="text-red-500 no-pdf">*</span>
                </label>
                <? if (isPdf) { ?>
                <div class="pdf-value"><?= caregiverData.SignDate ?></div>
                <? } else { ?>
                <input
                  type="date"
                  name="signDate"
                  required
                  class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
                  id="signDate"
                />
                <script>
                  (function () {
                    const el = document.getElementById("signDate");
                    if (el && !el.value) {
                      const d = new Date();
                      const localISO = new Date(
                        d.getTime() - d.getTimezoneOffset() * 60000
                      )
                        .toISOString()
                        .split("T")[0];
                      el.value = localISO;
                    }
                  })();
                </script>
                <? } ?>
              </div>
            </div>

            <? if (!isPdf) { ?>
            <div class="pt-4">
              <button
                type="submit"
                class="mt-4 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
              >
                Submit W-9
              </button>
            </div>
            <? } ?>
          </div>
        </form>
      </div>
    </div>
    <script>
      // Get caregiverId from URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      const caregiverId = getQueryParam("caregiverId");
      if (caregiverId) {
        document.querySelector('input[name="caregiverId"]').value = caregiverId;
      } else {
        console.warn("No caregiverId found in URL");
        // Optional: alert("Error: No Caregiver ID found. Please return to the dashboard.");
      }

      document
        .getElementById("w9Form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const form = this;
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.innerText;

          // Validate Signature
          const name = form
            .querySelector('input[name="name"]')
            .value.trim()
            .toLowerCase();
          const signature = form
            .querySelector('input[name="signature"]')
            .value.trim()
            .toLowerCase();

          if (name !== signature) {
            alert("Signature must match the Name provided in line 1.");
            return;
          }

          submitBtn.disabled = true;
          submitBtn.innerText = "Submitting...";

          google.script.run
            .withSuccessHandler(function (response) {
              if (response && response.success) {
                alert("W-9 Form submitted successfully!");
                window.location.reload();
              } else {
                alert(
                  "Error submitting form: " +
                    (response ? response.message : "Unknown error")
                );
              }
              submitBtn.disabled = false;
              submitBtn.innerText = originalBtnText;
            })
            .withFailureHandler(function (error) {
              alert("Error: " + error.message);
              submitBtn.disabled = false;
              submitBtn.innerText = originalBtnText;
            })
            .submitW9(form);
        });
    </script>
  </body>
</html>
