<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>Exhibit B - Plan of Care</title>
    <style>
      body { font-family: "Inter", sans-serif; }

      /* Tailwind Polyfill for PDF Generation */
      .text-center { text-align: center; }
      .text-justify { text-align: justify; }
      .font-bold { font-weight: 700; }
      .font-semibold { font-weight: 600; }
      .text-2xl { font-size: 1.5rem; line-height: 2rem; }
      .underline { text-decoration: underline; }
      .italic { font-style: italic; }
      .mb-6 { margin-bottom: 1.5rem; }
      .mb-4 { margin-bottom: 1rem; }
      .mt-2 { margin-top: 0.5rem; }
      .mt-4 { margin-top: 1rem; }
      .p-8 { padding: 2rem; }
      .px-8 { padding-left: 2rem; padding-right: 2rem; }
      .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
      .w-full { width: 100%; }
      .border { border-width: 1px; border-style: solid; }
      .border-gray-300 { border-color: #d1d5db; }
      .rounded-md { border-radius: 0.375rem; }
      .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
      .p-2 { padding: 0.5rem; }
      .block { display: block; }
      .flex { display: flex; }
      .gap-3 { gap: 0.75rem; }
      .items-start { align-items: flex-start; }
      .text-red-500 { color: #ef4444; }

      /* Custom styles for Exhibit A Elements */
      table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
      td { border: 1px solid #d1d5db; padding: 0.75rem; vertical-align: top; }
      .field { border-bottom: 1px solid #000; min-height: 1.5em; margin-top: 5px; }
      .checkbox { display: inline-block; width: 1rem; height: 1rem; border: 1px solid #000; margin-right: 0.25rem; vertical-align: middle; }

      /* PDF Specific Overrides */
      <? if (isPdf) { ?>
        body { background-color: white !important; padding: 0 !important; }
        .shadow-lg { box-shadow: none !important; }
        .rounded-xl { border-radius: 0 !important; }
        .no-pdf { display: none !important; }
        .container-box { border: none !important; max-width: 100% !important; box-shadow: none !important; }
      <? } ?>
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen py-10 px-4">
    <div
      class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden container-box"
    >
      <div class="px-8 py-6">
        <h1 class="text-2xl font-bold text-center">EXHIBIT B - PLAN OF CARE</h1>
      </div>

      <div class="p-8">
        <p class="text-justify mb-6">
          <b>THIS</b> Exhibit B - Plan of Care, shall be incorporated into and
          considered part of the Client Services Agreement ("<b>Agreement</b>")
          by and between Allevia Senior Care and the CLIENT and/or Financially
          Responsible Party by this reference.
        </p>

        <!-- Plan of Care Details -->
        <div class="space-y-6 mt-6 mb-8">
          <!-- DAILY LIVING SKILLS -->
          <div class="border border-gray-300 rounded-lg p-5 bg-white">
            <h4
              class="font-bold text-gray-800 border-b pb-2 mb-3 text-sm uppercase tracking-wide"
            >
              Daily Living Skills
            </h4>
            <div class="grid grid-cols-2 gap-3">
              <? var dls = clientData.dailyLivingSkills || ''; ?>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Companionship and Conversation') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Companionship and Conversation
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('General care and Supervision') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> General care and Supervision
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Bathing and Showering') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Bathing and Showering
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Dressing assistance') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Dressing assistance
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Incontinence care and Toileting') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Incontinence care and Toileting
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Walking and Transferring') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Walking and Transferring
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Personal grooming and Skin care') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Personal grooming and Skin care
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= dls.indexOf('Medication reminders') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Medication reminders
              </label>
            </div>
          </div>

          <!-- TRANSPORTATION -->
          <div class="border border-gray-300 rounded-lg p-5 bg-white">
            <h4
              class="font-bold text-gray-800 border-b pb-2 mb-3 text-sm uppercase tracking-wide"
            >
              Transportation
            </h4>
            <div class="grid grid-cols-2 gap-3">
              <? var trans = clientData.transportation || ''; ?>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= trans.indexOf('Doctor Appointments') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Doctor Appointments
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= trans.indexOf('Visiting family and friends') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Visiting family and friends
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= trans.indexOf('Shopping and Entertainment') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Shopping and Entertainment
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= trans.indexOf('Personal Appointments') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Personal Appointments
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= trans.indexOf('Hair and Beauty salons') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Hair and Beauty salons
              </label>
            </div>
          </div>

          <!-- MEAL PREPARATION -->
          <div class="border border-gray-300 rounded-lg p-5 bg-white">
            <h4
              class="font-bold text-gray-800 border-b pb-2 mb-3 text-sm uppercase tracking-wide"
            >
              Meal Preparation
            </h4>
            <div class="grid grid-cols-2 gap-3">
              <? var meals = clientData.mealPreparation || ''; ?>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= meals.indexOf('Menu planning') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Menu planning
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= meals.indexOf('Meal preparation') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Meal preparation
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= meals.indexOf('Eating Assistance') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Eating Assistance
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= meals.indexOf('Adapting to dietary restrictions') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Adapting to dietary restrictions
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= meals.indexOf('Grocery shopping') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Grocery shopping
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= meals.indexOf('Cleaning and maintenance of the kitchen area') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Cleaning and maintenance of the
                kitchen area
              </label>
            </div>
          </div>

          <!-- LIGHT HOUSEKEEPING -->
          <div class="border border-gray-300 rounded-lg p-5 bg-white">
            <h4
              class="font-bold text-gray-800 border-b pb-2 mb-3 text-sm uppercase tracking-wide"
            >
              Light Housekeeping
            </h4>
            <div class="grid grid-cols-2 gap-3">
              <? var house = clientData.lightHousekeeping || ''; ?>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= house.indexOf('Sweeping and Vacuuming') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Sweeping and Vacuuming
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= house.indexOf('Dusting and Tidying rooms') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Dusting and Tidying rooms
                (client room only)
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= house.indexOf('Washing and Drying dishes') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Washing and Drying dishes
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= house.indexOf('Light cleaning and Laundry') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Light cleaning and Laundry
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= house.indexOf('Changing bed linens') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Changing bed linens
              </label>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <input type="checkbox" disabled
                <?= house.indexOf('Maintaining a clean') >
                -1 ? 'checked' : '' ?> class="rounded text-green-600 w-4 h-4
                bg-gray-100 border-gray-300" /> Maintaining a clean, comfortable
                and homey atmosphere
              </label>
            </div>
          </div>
        </div>
        <p class="mt-8 italic">
          Executed and applicable as of the Effective Date of the Agreement.
        </p>

        <!-- Signing Form Section (Same as Agreement) -->
        <form id="clientAgreementForm" class="space-y-6 mt-8 border-t pt-6">
          <div class="space-y-2 mt-2 pt-4">
            <? if (isPdf) { ?>
            <div class="flex gap-3 items-start">
              <span style="font-size: 18px; line-height: 1">â˜‘</span>
              <span class="italic"
                >By electronically typing or signing my name below, I
                acknowledge and agree that this electronic representation of my
                name constitutes my legal signature. This electronic signature
                has the same validity, force, and effect as a handwritten
                signature under applicable state and federal law, including the
                ESIGN Act and the Uniform Electronic Transactions Act.</span
              >
            </div>
            <? } else { ?>
            <label class="flex gap-3 items-start cursor-pointer">
              <input
                type="checkbox"
                name="agreeEsign"
                required
                class="mt-0.5 accent-[#65c027] w-4 h-4 shrink-0"
              />
              <span class="italic"
                >By electronically typing or signing my name below, I
                acknowledge and agree that this electronic representation of my
                name constitutes my legal signature. This electronic signature
                has the same validity, force, and effect as a handwritten
                signature under applicable state and federal law, including the
                ESIGN Act and the Uniform Electronic Transactions Act.</span
              >
            </label>
            <? } ?>
          </div>

          <div>
            <input type="hidden" name="clientId" value="<?= clientId ?>" />
            <label class="input-label font-semibold block mb-1"
              >Full Name <span class="text-red-500 no-pdf">*</span></label
            >
            <? if (isPdf) { ?>
            <div class="w-full border-b border-gray-400 py-2 mb-4">
              <?= [clientData.firstName, clientData.middleName, clientData.lastName].filter(Boolean).join(' ') ?>
            </div>
            <? } else { ?>
            <input
              type="text"
              name="fullName"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border mb-4"
              placeholder="Given Name"
              value="<?= [clientData.firstName, clientData.middleName, clientData.lastName].filter(Boolean).join(' ') ?>"
              readonly
              required
            />
            <? } ?>

            <label class="input-label font-semibold block mb-1"
              >Digital Signature (Type Full Name)<span
                class="text-red-500 no-pdf"
                >*</span
              ></label
            >
            <? if (isPdf) { ?>
            <div
              class="w-full border-b border-gray-400 py-2 mb-4"
              style="font-family: 'Courier New', Courier, monospace"
            >
              <?= clientData.Signature || '' ?>
            </div>
            <? } else { ?>
            <input
              type="text"
              name="signature"
              required
              placeholder="Type your full name"
              value="<?= clientData.Signature || '' ?>"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
            />
            <? } ?>

            <label class="input-label mt-4 block font-semibold mb-1"
              >Date & Time <span class="text-red-500 no-pdf">*</span></label
            >
            <? if (isPdf) { ?>
            <div class="w-full border-b border-gray-400 py-2 mb-1">
              <?= clientData.SignDate || '' ?>
            </div>
            <? } else { ?>
            <div class="mb-4">
              <input
                type="datetime-local"
                name="signDateLocal"
                required
                class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
              />
              <input type="hidden" name="signDate" />
            </div>
            <? } ?>
          </div>

          <!-- Allevia Senior Care Signature -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="mb-4">
              <p class="font-semibold text-lg">
                ALLEVIA SENIOR CARE (Allevia llc)
              </p>
            </div>
            <div>
              <label class="input-label block font-semibold mb-2"
                >SIGNATURE:</label
              >
              <? if (isPdf) { ?>
              <div
                style="
                  width: 150px;
                  height: 60px;
                  border-bottom: 1px solid #000;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <img
                  src="https://lh3.googleusercontent.com/d/11Oxbip4bK0lI_uZMtuKj3_pa7f3YZknW"
                  alt="Allevia Senior Care Signature"
                  style="
                    max-width: 150px;
                    max-height: 60px;
                    width: auto;
                    height: auto;
                  "
                />
              </div>
              <? } else { ?>
              <div style="width: 150px">
                <img
                  src="https://drive.google.com/uc?export=download&id=11Oxbip4bK0lI_uZMtuKj3_pa7f3YZknW"
                  alt="Allevia Senior Care Signature"
                  class="w-full h-auto"
                  onerror="this.src='https://lh3.googleusercontent.com/d/11Oxbip4bK0lI_uZMtuKj3_pa7f3YZknW'"
                />
              </div>
              <? } ?>
            </div>
          </div>

          <div class="pt-4 no-pdf">
            <button
              type="submit"
              class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              Sign Agreement
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Set default local date-time to now (for user convenience)
      (function setDefaultDateTimeLocal() {
        const dtInput = document.querySelector('input[name="signDateLocal"]');
        if (dtInput && !dtInput.value) {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          const y = d.getFullYear();
          const m = pad(d.getMonth() + 1);
          const day = pad(d.getDate());
          const hh = pad(d.getHours());
          const mm = pad(d.getMinutes());
          dtInput.value = `${y}-${m}-${day}T${hh}:${mm}`;
        }
      })();

      document
        .getElementById("clientAgreementForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const fullNameLower = document
            .querySelector('input[name="fullName"]')
            .value.trim()
            .replace(/\s+/g, " ")
            .toLowerCase();
          const signatureInput = document.querySelector(
            'input[name="signature"]'
          );
          const signatureRaw = signatureInput.value.trim().replace(/\s+/g, " "); // Keep original case
          const signatureLower = signatureRaw.toLowerCase();

          if (fullNameLower !== signatureLower) {
            alert("Digital Signature must match the Full Name exactly.");
            return;
          }

          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerText;
          btn.innerText = "Signing & Uploading...";
          btn.disabled = true;

          // Build Sign Date string in Eastern Time (New York) for storage/display
          const dtLocalInput = document.querySelector(
            'input[name="signDateLocal"]'
          );
          let signDateEt = "";
          if (dtLocalInput && dtLocalInput.value) {
            const localDate = new Date(dtLocalInput.value);
            const parts = new Intl.DateTimeFormat("en-US", {
              timeZone: "America/New_York",
              weekday: "long",
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            }).formatToParts(localDate);
            const get = (t) => parts.find((p) => p.type === t)?.value || "";
            const weekday = get("weekday");
            const month = get("month");
            const day = get("day");
            const year = get("year");
            const hour = get("hour");
            const minute = get("minute");
            const dayPeriod = get("dayPeriod").toLowerCase();
            signDateEt = `${weekday} ${month} ${day}, ${year} ${hour}:${minute} ${dayPeriod}`;
          }

          // Store ET string in hidden field `signDate`
          const hiddenSignDate = document.querySelector(
            'input[name="signDate"]'
          );
          if (hiddenSignDate) hiddenSignDate.value = signDateEt;

          const formData = {
            clientId: document.querySelector('input[name="clientId"]').value,
            fullName: document.querySelector('input[name="fullName"]').value,
            signature: signatureRaw, // Send original case
            signDate: document.querySelector('input[name="signDate"]').value,
          };

          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                const clientId = document.querySelector(
                  'input[name="clientId"]'
                ).value;
                const targetUrl =
                  "<?= scriptUrl ?>?page=client-intake-steps&id=" + clientId;

                const container = document.querySelector(".container-box");
                container.innerHTML = `
                <div class="p-10 text-center">
                  <div style="width: 64px; height: 64px; margin: 0 auto 16px; border-radius: 50%; background-color: #dcfce7; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <h2 class="text-xl font-bold mb-2">Agreement Signed</h2>
                  <p class="text-gray-600 mb-6">Thank you for signing Exhibit A.</p>
                  <a href="${targetUrl}" style="display: inline-flex; align-items: center; padding: 12px 24px; border: none; border-radius: 6px; background-color: #16a34a; color: white; text-decoration: none; font-weight: 500;">Return to Intake Steps</a>
                </div>`;
                window.scrollTo(0, 0);
              } else {
                alert("Error: " + response.message);
                btn.innerText = originalText;
                btn.disabled = false;
              }
            })
            .withFailureHandler(function (err) {
              alert("Error: " + err);
              btn.innerText = originalText;
              btn.disabled = false;
            })
            .submitClientExhibitB(formData);
        });
    </script>
  </body>
</html>
