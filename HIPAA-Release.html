<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>HIPAA Authorization - Allevia Senior Care</title>
    <style>
      body { font-family: "Inter", sans-serif; }

      /* Tailwind Polyfill for PDF Generation */
      .text-center { text-align: center; }
      .text-justify { text-align: justify; }
      .font-bold { font-weight: 700; }
      .font-semibold { font-weight: 600; }
      .text-2xl { font-size: 1.5rem; line-height: 2rem; }
      .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
      .underline { text-decoration: underline; }
      .italic { font-style: italic; }
      .mb-6 { margin-bottom: 1.5rem; }
      .mb-4 { margin-bottom: 1rem; }
      .mb-2 { margin-bottom: 0.5rem; }
      .mt-2 { margin-top: 0.5rem; }
      .mt-4 { margin-top: 1rem; }
      .mt-6 { margin-top: 1.5rem; }
      .p-8 { padding-left: 2rem; padding-right: 2rem; padding-bottom: 0.5rem; }
      .px-8 { padding-left: 2rem; padding-right: 2rem; }
      .space-y-2 > * + * { margin-top: 0.2rem; }
      .list-none { list-style: none; padding: 0; margin: 0; }
      .w-full { width: 100%; }
      .border { border-width: 1px; border-style: solid; }
      .border-gray-300 { border-color: #d1d5db; }
      .rounded-md { border-radius: 0.375rem; }
      .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
      .p-2 { padding: 0.5rem; }
      .block { display: block; }
      .flex { display: flex; }
      .gap-3 { gap: 0.2rem; }
      .items-start { align-items: flex-start; }
      .text-red-500 { color: #ef4444; }
      .rounded-xl { border-radius: 0.75rem; }
      .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
      .min-h-screen { min-height: 100vh; }
      .bg-gray-50 { background-color: #f9fafb; }
      .py-10 { padding-top: 1.5rem; }
      .px-4 { padding-left: 1rem; padding-right: 1rem; }
      .mx-auto { margin-left: auto; margin-right: auto; }
      .max-w-3xl { max-width: 48rem; }
      .bg-white { background-color: #ffffff; }
      .overflow-hidden { overflow: hidden; }
      .ml-4 { margin-left: 1rem; }
      .ml-6 { margin-left: 1.5rem; }
      .space-y-1 > * + * { margin-top: 0.25rem; }
      .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
      .border-t-2 { border-top-width: 2px; }
      .shrink-0 { flex-shrink: 0; }
      .mt-8 { margin-top: 0.1rem; }

      /* PDF Specific Overrides */
      <? if (isPdf) { ?>
        body { background-color: white !important; padding: 0 !important; min-height: auto !important; }
        .shadow-lg { box-shadow: none !important; }
        .rounded-xl { border-radius: 0 !important; }
        .no-pdf { display: none !important; }
        .pdf-value {
            border: none;
            border-bottom: 1px solid #000;
            padding: 4px 0;
            width: 100%;
            display: block;
            font-family: 'Courier New', Courier, monospace;
        }
      <? } ?>
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen py-10 px-4">
    <div
      class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden"
    >
      <!-- Header -->
      <div class="px-8 py-6">
        <h1 class="text-2xl font-bold text-center uppercase leading-tight">
          HIPAA Authorization for Release of<br />Health Information
        </h1>
      </div>

      <div class="p-8">
        <!-- Content -->
        <div class="mb-6 space-y-4 text-justify">
          <p>
            I understand that the use and disclosure of my protected health
            information is governed by the Health Insurance Portability and
            Accountability Act (HIPAA), as summarized in Allevia llc bda Allevia
            Senior Care NOTICE OF PRIVACY PRACTICES. By signing below I hereby
            authorize Allevia to disclose my complete health records (except as
            otherwise indicate) to the following designated individuals:
          </p>

          <ol class="list-decimal ml-6 space-y-2">
            <li>
              Emergency Transport, Hospital emergency Room, Residential
              Facility, and Hospice personnel
            </li>
            <li>My then current primary care provider</li>
            <li>Applicable billing services and insurers</li>
            <li>
              The following family member(s), friend(s) or significant other(s).
            </li>
          </ol>

          <p>
            I Understand that I may change or revoke this Authorization at any
            time by providing written notification to Allevia Senior Care. Such
            revocation will have no effect to the extent that Allevia Senior
            Care has taken action in reliance on this Authorization. The
            disclosures being authorized by this Authorization are at my
            request. This Authorization shall remain in effect until the earlier
            of (i) Allevia Senior Care's receipt of my written revocation of the
            Authorization, or (ii) the date on which I cease receiving services
            provided by a caregiver referred to me by Allevia Senior Care.
          </p>

          <p>
            I understand that my right to receive services from Allevia Senior
            Care, including but not limited to its caregiver-referral services,
            and my right to receive services from referred caregivers, is not in
            any way conditioned on whether I sign this Authorization. I
            understand that information disclosed pursuant to the Authorization
            may be subject to re-disclosure by the recipient and no longer be
            protected by HIPAA.
          </p>

          <div class="mt-8 mb-4">
            <h3 class="font-bold text-center underline uppercase">
              Client Certification of Receipt of Important Information & Release
            </h3>
          </div>

          <p>
            In consideration of Allevia Senior Care proper use and release of my
            protected health information, I release this office, its director,
            employees, and agents and Allevia Senior Care its officers,
            directors, employees, and agents, from any and all liability
            whatsoever in connection with the release of this information. I
            understand that this release shall be binding upon me, my heirs,
            executors, administrators, and assigns, and I enter into this
            release this Authorization and Release. The written revocation of
            any authorization contained in this document shall have no effect on
            the release contained in this paragraph.
          </p>
        </div>

        <!-- Signing Form -->
        <form id="hipaaReleaseForm" class="space-y-6 mt-8 pt-6 border-t-2">
          <div class="space-y-2">
            <? if (isPdf) { ?>
            <div class="flex gap-3 items-start">
              <span style="font-size: 18px; line-height: 1">â˜‘</span>
              <span class="italic text-sm"
                >By electronically typing or signing my name below, I
                acknowledge and agree that this electronic representation of my
                name constitutes my legal signature. This electronic signature
                has the same validity, force, and effect as a handwritten
                signature under applicable state and federal law, including the
                ESIGN Act and the Uniform Electronic Transactions Act.</span
              >
            </div>
            <? } else { ?>
            <label class="flex gap-3 items-start cursor-pointer">
              <input
                type="checkbox"
                name="agreeEsign"
                required
                class="mt-0.5 accent-[#65c027] w-4 h-4 shrink-0"
              />
              <span class="italic text-sm"
                >By electronically typing or signing my name below, I
                acknowledge and agree that this electronic representation of my
                name constitutes my legal signature. This electronic signature
                has the same validity, force, and effect as a handwritten
                signature under applicable state and federal law, including the
                ESIGN Act and the Uniform Electronic Transactions Act.</span
              >
            </label>
            <? } ?>
          </div>

          <div>
            <input type="hidden" name="clientId" value="<?= clientId ?>" />
            <label class="input-label font-semibold block mb-1"
              >Full Name <span class="text-red-500 no-pdf">*</span></label
            >
            <? if (isPdf) { ?>
            <div class="w-full border-b border-gray-400 py-2 mb-4">
              <?= [clientData.firstName, clientData.middleName, clientData.lastName].filter(Boolean).join(' ') ?>
            </div>
            <? } else { ?>
            <input
              type="text"
              name="fullName"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border mb-4"
              placeholder="Given Name"
              value="<?= [clientData.firstName, clientData.middleName, clientData.lastName].filter(Boolean).join(' ') ?>"
              readonly
              required
            />
            <? } ?>

            <label class="input-label font-semibold block mb-1"
              >Digital Signature (Type Full Name)<span
                class="text-red-500 no-pdf"
                >*</span
              ></label
            >
            <? if (isPdf) { ?>
            <div
              class="w-full border-b border-gray-400 py-2 mb-4"
              style="font-family: 'Courier New', Courier, monospace"
            >
              <?= clientData.Signature || '' ?>
            </div>
            <? } else { ?>
            <input
              type="text"
              name="signature"
              required
              placeholder="Type your full name"
              value="<?= clientData.Signature || '' ?>"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
            />
            <? } ?>

            <label class="input-label mt-4 block font-semibold mb-1"
              >Date & Time <span class="text-red-500 no-pdf">*</span></label
            >
            <? if (isPdf) { ?>
            <div class="w-full border-b border-gray-400 py-2 mb-1">
              <?= clientData.SignDate || '' ?>
            </div>
            <? } else { ?>
            <div class="mb-4">
              <input
                type="datetime-local"
                name="signDateLocal"
                required
                class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
              />
              <input type="hidden" name="signDate" />
            </div>
            <? } ?>
          </div>

          <div class="pt-4 no-pdf">
            <button
              type="submit"
              class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              Sign Agreement
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Set default local date-time to now (for user convenience)
      (function setDefaultDateTimeLocal() {
        const dtInput = document.querySelector('input[name="signDateLocal"]');
        if (dtInput && !dtInput.value) {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          const y = d.getFullYear();
          const m = pad(d.getMonth() + 1);
          const day = pad(d.getDate());
          const hh = pad(d.getHours());
          const mm = pad(d.getMinutes());
          dtInput.value = `${y}-${m}-${day}T${hh}:${mm}`;
        }
      })();

      document
        .getElementById("hipaaReleaseForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const fullNameLower = document
            .querySelector('input[name="fullName"]')
            .value.trim()
            .replace(/\s+/g, " ")
            .toLowerCase();
          const signatureInput = document.querySelector(
            'input[name="signature"]'
          );
          const signatureRaw = signatureInput.value.trim().replace(/\s+/g, " "); // Keep original case
          const signatureLower = signatureRaw.toLowerCase();

          if (fullNameLower !== signatureLower) {
            alert("Digital Signature must match the Full Name exactly.");
            return;
          }

          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerText;
          btn.innerText = "Signing & Uploading...";
          btn.disabled = true;

          // Build Sign Date string in Eastern Time (New York) for storage/display
          const dtLocalInput = document.querySelector(
            'input[name="signDateLocal"]'
          );
          let signDateEt = "";
          if (dtLocalInput && dtLocalInput.value) {
            const localDate = new Date(dtLocalInput.value);
            const parts = new Intl.DateTimeFormat("en-US", {
              timeZone: "America/New_York",
              weekday: "long",
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            }).formatToParts(localDate);
            const get = (t) => parts.find((p) => p.type === t)?.value || "";
            const weekday = get("weekday");
            const month = get("month");
            const day = get("day");
            const year = get("year");
            const hour = get("hour");
            const minute = get("minute");
            const dayPeriod = get("dayPeriod").toLowerCase();
            signDateEt = `${weekday} ${month} ${day}, ${year} ${hour}:${minute} ${dayPeriod}`;
          }

          // Store ET string in hidden field `signDate`
          const hiddenSignDate = document.querySelector(
            'input[name="signDate"]'
          );
          if (hiddenSignDate) hiddenSignDate.value = signDateEt;

          const formData = {
            clientId: document.querySelector('input[name="clientId"]').value,
            fullName: document.querySelector('input[name="fullName"]').value,
            signature: signatureRaw, // Send original case
            signDate: document.querySelector('input[name="signDate"]').value,
          };

          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                const clientId = document.querySelector(
                  'input[name="clientId"]'
                ).value;
                const targetUrl =
                  "<?= scriptUrl ?>?page=client-intake-steps&id=" + clientId;

                const container = document.querySelector(".max-w-3xl");
                container.innerHTML = `
                <div class="p-10 text-center">
                  <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <h2 class="text-xl font-bold mb-2">HIPAA Authorization Signed</h2>
                  <p class="text-gray-600 mb-6">Thank you for signing the HIPAA Authorization.</p>
                  <a href="${targetUrl}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Return to Intake Steps</a>
                </div>`;
                window.scrollTo(0, 0);
              } else {
                alert("Error: " + response.message);
                btn.innerText = originalText;
                btn.disabled = false;
              }
            })
            .withFailureHandler(function (err) {
              alert("Error: " + err);
              btn.innerText = originalText;
              btn.disabled = false;
            })
            .submitHipaaRelease(formData);
        });
    </script>
  </body>
</html>
