<script>
  // Globals (currentClientData, clData, etc) are defined in js-utils.html

  function switchClView(subView) {
    const list = document.getElementById("cl-subview-list");
    const add = document.getElementById("cl-subview-add");
    const profile = document.getElementById("cl-subview-profile");
    const edit = document.getElementById("cl-subview-edit");

    if (list) list.classList.add("hidden");
    if (add) add.classList.add("hidden");
    if (profile) profile.classList.add("hidden");
    if (edit) edit.classList.add("hidden");

    const target = document.getElementById("cl-subview-" + subView);
    if (target) target.classList.remove("hidden");

    // Set today's date when switching to add view
    if (subView === "add" && typeof setTodayDate === "function") {
      setTodayDate();
    }
  }

  // Format phone number as (XXX) XXX-XXXX
  function formatPhone(input) {
    // Save selection start to restore cursor position
    const selectionStart = input.selectionStart;
    const oldLength = input.value.length;

    let value = input.value.replace(/\D/g, ""); // Remove non-digits

    if (value.length > 10) {
      value = value.substring(0, 10); // Limit to 10 digits
    }

    let formattedValue = "";
    if (value.length > 0) {
      formattedValue = "(" + value.substring(0, 3);
      if (value.length > 3) {
        formattedValue += ") " + value.substring(3, 6);
      }
      if (value.length > 6) {
        formattedValue += "-" + value.substring(6, 10);
      }
    }

    input.value = formattedValue;

    // Restore cursor position logically
    const newLength = formattedValue.length;
    let newCursorPos = selectionStart + (newLength - oldLength);

    // Ensure cursor doesn't jump weirdly after formatting
    if (newCursorPos < 0) newCursorPos = 0;
    input.setSelectionRange(newCursorPos, newCursorPos);
  }

  // Format EIN as XX-XXXXXXX
  function formatEIN(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 9) value = value.substring(0, 9);

    if (value.length > 2) {
      input.value = value.substring(0, 2) + "-" + value.substring(2);
    } else {
      input.value = value;
    }
  }

  function toggleClientOtherLang(checkbox) {
    const otherInput = document.getElementById("ce-otherLangInput");
    if (checkbox.checked) {
      otherInput.classList.remove("hidden");
    } else {
      otherInput.classList.add("hidden");
      otherInput.value = "";
    }
  }

  function calculateEditClientCosts() {
    const hours =
      parseFloat(document.getElementById("ce-projectHours").value) || 0;
    const rate =
      parseFloat(document.getElementById("ce-hourlyRate").value) || 0;

    const weekly = hours * rate;
    const monthly = weekly * 4.33; // Avg weeks/month

    document.getElementById("ce-weeklyCost").value = weekly.toFixed(2);
    document.getElementById("ce-monthlyCost").value = monthly.toFixed(2);
  }

  function loadClientList() {
    const tbody = document.getElementById("clTableBody");
    if (tbody)
      tbody.innerHTML =
        '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        clData = data;
        renderClTable();
      })
      .getClientList();
  }

  function renderClTable() {
    const searchEl = document.getElementById("clSearch");
    const typeFilterEl = document.getElementById("clTypeFilter");
    const statusFilterEl = document.getElementById("clStatusFilter");

    if (!searchEl) return;

    const search = searchEl.value.toLowerCase();
    const typeFilter = typeFilterEl ? typeFilterEl.value : "";
    const statusFilter = statusFilterEl ? statusFilterEl.value : "";

    const filtered = clData.filter((item) => {
      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search) ||
        String(item.id).toLowerCase().includes(search);

      const isClientStage = item.stage === "Convert Clients";
      const matchType =
        typeFilter === "" || (item.type && item.type.includes(typeFilter));
      const matchStatus = statusFilter === "" || item.status === statusFilter;

      return matchSearch && isClientStage && matchType && matchStatus;
    });

    const totalPages = Math.ceil(filtered.length / clRowsPerPage);
    if (clCurrentPage > totalPages) clCurrentPage = 1;

    const start = (clCurrentPage - 1) * clRowsPerPage;
    const end = start + clRowsPerPage;
    const pageData = filtered.slice(start, end);

    const tbody = document.getElementById("clTableBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No clients found.</td></tr>';
    } else {
      pageData.forEach((row) => {
        let statusColor = "text-white";
        let statusStyle = "";

        if (row.status === "Active") {
          statusColor = "text-white";
          statusStyle = "background-color: #2ECC71;";
        }
        if (row.status === "Inactive") {
          statusColor = "text-white";
          statusStyle = "background-color: #95A5A6;";
        }
        if (row.status === "Cancelled service") {
          statusColor = "text-white";
          statusStyle = "background-color: #8E2A2A;";
        }
        if (row.status === "Temporary hospital stay") {
          statusColor = "text-white";
          statusStyle = "background-color: #1A5276;";
        }

        let codeStatusStyle = "";
        let codeStatusClass =
          "px-2 py-1 rounded-full text-xs font-bold inline-block";
        const cs = (row.codeStatus || "").trim();

        if (cs === "Full code") {
          codeStatusStyle = "background-color: #1E8449; color: white;";
        } else if (cs === "Comfort care") {
          codeStatusStyle = "background-color: #AF7AC5; color: white;";
        } else if (cs === "DNR") {
          codeStatusStyle = "background-color: #7B241C; color: white;";
        } else {
          codeStatusStyle = "background-color: #E5E7EB; color: #374151;";
        }

        tbody.innerHTML += `
        <tr class="hover:bg-gray-50 border-b border-gray-50">
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4 text-sm text-gray-600">${row.type}</td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip || ""}</p>
            </div>
          </td>
          <td class="p-4">
            <span class="${codeStatusClass}" style="${codeStatusStyle}">${
          row.codeStatus || "--"
        }</span>
          </td>
          <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}" style="${statusStyle}">${
          row.status
        }</span></td>
          <td class="p-4 text-right">
             <button onclick="loadClientProfile('${
               row.id
             }')" class="text-xs text-white px-3 py-1 rounded-full hover:opacity-90 font-bold transition-colors" style="background-color: #00BCD4;">Details</button>
          </td>
        </tr>
      `;
      });
    }

    const infoEl = document.getElementById("clPageInfo");
    if (infoEl) {
      infoEl.textContent = `Showing ${
        pageData.length > 0 ? start + 1 : 0
      }-${Math.min(end, filtered.length)} of ${filtered.length}`;
    }
    const btnPrev = document.getElementById("clBtnPrev");
    const btnNext = document.getElementById("clBtnNext");
    if (btnPrev) btnPrev.disabled = clCurrentPage === 1;
    if (btnNext)
      btnNext.disabled = clCurrentPage >= totalPages || totalPages === 0;
  }

  function changeClPage(dir) {
    clCurrentPage += dir;
    renderClTable();
  }

  function submitClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveClientBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("clientForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Save Client Information";
        if (res.success) {
          Swal.fire("Success", "Client Information Saved!", "success");
          form.reset();
          // Reset today's date after form reset
          setTodayDate();
          switchClView("list");
          loadClientList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleClientSubmission(data);
  }

  // Function to set today's date
  function setTodayDate() {
    const dateInput = document.getElementById("contactDate");
    if (dateInput) {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${year}-${month}-${day}`;
    }
  }

  // Initialize date when page loads or when switching to add view
  document.addEventListener("DOMContentLoaded", setTodayDate);

  function loadClientProfile(id) {
    switchClView("profile");
    document.getElementById("clProfileLoading").classList.remove("hidden");
    document.getElementById("clProfileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        currentClientData = data;
        renderClientProfile(data);
      })
      .getClientDetails(id);
  }

  function renderClientProfile(data) {
    if (!data) return;

    // Helper to set text content safely
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el)
        el.textContent =
          val === undefined || val === null || val === "" ? "--" : val;
    };

    // Helper to format address
    const fmtAddr = (addr, apt, city, state, zip) => {
      return [addr, apt ? "Apt " + apt : "", city, state, zip]
        .filter(Boolean)
        .join(", ");
    };

    // 1. Identity Header
    const fName = data.firstName || "";
    const mName = data.middleName || "";
    const lName = data.lastName || "";
    const fullName = [fName, mName, lName].filter(Boolean).join(" ");

    set("cp-name", fullName);
    set("cp-initials", (fName[0] || "") + (lName[0] || fName[0] || "?"));
    set("cp-id", data.id);
    set("cp-status", data.status);
    const statusEl = document.getElementById("cp-status");
    if (statusEl) {
      if (data.status === "Active") {
        statusEl.style.backgroundColor = "#2ECC71";
        statusEl.style.color = "white";
      } else if (data.status === "Inactive") {
        statusEl.style.backgroundColor = "#95A5A6";
        statusEl.style.color = "white";
      } else if (data.status === "Cancelled service") {
        statusEl.style.backgroundColor = "#8E2A2A";
        statusEl.style.color = "white";
      } else if (data.status === "Temporary hospital stay") {
        statusEl.style.backgroundColor = "#1A5276";
        statusEl.style.color = "white";
      } else {
        statusEl.style.backgroundColor = "";
        statusEl.style.color = "";
      }
    }
    set("cp-type", data.serviceTypes || "Client");
    set("cp-username", data.username);

    // 2. Personal Info
    set("cp-dob", data.dob);
    set("cp-gender", data.gender);
    set("cp-ssn", data.ssn);
    set("cp-ein", data.ein);
    set("cp-maritalStatus", data.maritalStatus);
    set("cp-codeStatus", data.codeStatus);
    // Apply code status color badge
    const codeStatusEl = document.getElementById("cp-codeStatus");
    if (codeStatusEl) {
      const val = (data.codeStatus || "").trim();
      codeStatusEl.style.padding = "4px 8px";
      codeStatusEl.style.borderRadius = "999px";
      codeStatusEl.style.fontWeight = "700";
      codeStatusEl.style.display = "inline-block";

      let bg = "#E5E7EB"; // gray-200
      let fg = "#374151"; // gray-700
      if (val === "Full code") {
        bg = "#1E8449";
        fg = "#FFFFFF";
      } else if (val === "Comfort care") {
        bg = "#AF7AC5";
        fg = "#FFFFFF";
      } else if (val === "DNR") {
        bg = "#7B241C";
        fg = "#FFFFFF";
      }

      codeStatusEl.style.backgroundColor = bg;
      codeStatusEl.style.color = fg;
    }
    set("cp-spouseName", data.spouseName);
    set("cp-languages", data.languages);

    // 3. Contact Info
    set("cp-clientPhone", data.clientPhone);
    set("cp-email", data.email);
    set("cp-referredBy", data.referredBy);
    set(
      "cp-clientAddressFull",
      fmtAddr(
        data.clientAddress,
        data.clientApt,
        data.clientCity,
        data.clientState,
        data.clientZip
      )
    );
    set(
      "cp-billingAddressFull",
      fmtAddr(
        data.billingAddress,
        data.billingApt,
        data.billingCity,
        data.billingState,
        data.billingZip
      )
    );

    // 4. Key Contacts
    // Representative
    set("cp-repName", data.repName);
    set("cp-repRelationship", data.repRelationship);
    set("cp-repPhone", data.repPhone);

    // Emergency
    set("cp-emergencyName", data.emergencyName);
    set("cp-emergencyPhone", data.emergencyPhone);
    set("cp-emergencyRelationship", data.emergencyRelationship);
    set("cp-emergencyEmail", data.emergencyEmail);
    set(
      "cp-emergencyAddressFull",
      fmtAddr(
        data.emergencyAddress,
        data.emergencyApt,
        data.emergencyCity,
        data.emergencyState,
        data.emergencyZip
      )
    );

    // Authorization
    set("cp-authName", data.authName);
    set("cp-authPhone", data.authPhone);
    set("cp-authEmail", data.authEmail);
    set("cp-authRelationship", data.authRelationship);
    set(
      "cp-authAddressFull",
      fmtAddr(
        data.authAddress,
        data.authApt,
        data.authCity,
        data.authState,
        data.authZip
      )
    );

    // 5. Medical Status
    set("cp-height", data.height);
    set("cp-weight", data.weight);
    set("cp-mentalStatus", data.mentalStatus);
    set("cp-diagnosis", data.diagnosis);
    set(
      "cp-allergies",
      data.allergies +
        (data.allergiesDetail ? ` (${data.allergiesDetail})` : "")
    );
    set(
      "cp-covidVaccine",
      data.covidVaccine +
        (data.covidVaccineDetail ? ` (${data.covidVaccineDetail})` : "")
    );
    set(
      "cp-fluVaccine",
      data.fluVaccine +
        (data.fluVaccineDetail ? ` (${data.fluVaccineDetail})` : "")
    );

    // Aids
    let aids = [];
    if (data.blind === "Yes") aids.push("Blind");
    if (data.glasses === "Yes") aids.push("Glasses");
    if (data.dentures === "Yes") aids.push("Dentures");
    if (data.medicalAids) aids.push(data.medicalAids);
    set("cp-physicalAids", aids.join(", ") || "--");

    // Continence
    let cont = [];
    if (data.continentInfo) cont.push(`Continent: ${data.continentInfo}`);
    if (data.incontinentInfo) cont.push(`Incontinent: ${data.incontinentInfo}`);
    set("cp-continence", cont.join(" | ") || "--");

    set("cp-medicalHistory", data.medicalHistory);

    // Medications
    set("cp-medReminder", data.medReminder);
    set("cp-selfAdminMed", data.selfAdminMed);
    set("cp-takingMed", data.takingMed);
    set("cp-medOverseer", data.medOverseer);
    set("cp-medList", data.medList);
    set(
      "cp-assistDirections",
      data.assistDirections +
        (data.assistDirectionsDetail
          ? `\nDetails: ${data.assistDirectionsDetail}`
          : "")
    );

    // Healthcare Providers
    set("cp-primaryDrName", data.primaryDrName);
    set("cp-drOfficeName", data.drOfficeName);
    set("cp-drPhone", data.drPhone);
    set("cp-drAddress", data.drAddress);

    set("cp-hospitalName", data.hospitalName);
    set("cp-hospitalPhone", data.hospitalPhone);
    set("cp-hospitalAddress", data.hospitalAddress);

    set("cp-pharmacyName", data.pharmacyName);
    set("cp-pharmacyPhone", data.pharmacyPhone);
    set("cp-pharmacyAddress", data.pharmacyAddress);

    // 6. Care Needs
    set("cp-mobility", data.mobility);
    set("cp-dailyLivingSkills", data.dailyLivingSkills);
    set("cp-dietaryInfo", data.dietaryInfo);
    set("cp-careNeeds", data.careNeeds);
    set("cp-mealPreparation", data.mealPreparation);
    set("cp-lightHousekeeping", data.lightHousekeeping);
    set("cp-transportation", data.transportation);
    set("cp-goals", data.goals);

    // Caregiver Prefs
    set("cp-careGender", data.careGender);
    set("cp-careCertifications", data.careCertifications);
    set(
      "cp-careSmokePremises",
      data.careSmokePremises +
        (data.careSmokeNote ? ` (${data.careSmokeNote})` : "")
    );
    set(
      "cp-careLiveIn",
      data.careLiveIn +
        (data.careAccommodation ? ` - Accom: ${data.careAccommodation}` : "")
    );
    set("cp-careSkills", data.careSkills);

    // 8. Service Plan
    set("cp-levelOfCare", data.levelOfCare);
    set("cp-projectHours", data.projectHours);
    set("cp-hourlyRate", data.hourlyRate ? `$${data.hourlyRate}` : "");
    set("cp-weeklyCost", data.weeklyCost ? `$${data.weeklyCost}` : "");
    set("cp-overtime", data.overtime);
    set("cp-monthlyCost", data.monthlyCost ? `$${data.monthlyCost}` : "");
    set("cp-serviceTypes", data.serviceTypes);

    // 9. Schedule
    set("cp-schMO", data.schMO);
    set("cp-schT", data.schT);
    set("cp-schW", data.schW);
    set("cp-schTH", data.schTH);
    set("cp-schFR", data.schFR);
    set("cp-schSA", data.schSA);
    set("cp-schSU", data.schSU);

    // 10. Living Environment
    set("cp-smoke", data.smoke);
    set("cp-drink", data.drink);
    set("cp-pets", data.pets);
    set("cp-petsList", data.petsList);
    set("cp-petsNote", data.petsNote);
    set("cp-liveAlone", data.liveAlone);

    // Living details logic
    let livingDetails = [];
    if (data.liveFamily === "Yes")
      livingDetails.push(`Family: ${data.liveFamilyName}`);
    if (data.liveSenior === "Yes")
      livingDetails.push(
        `Senior Housing: ${data.liveSeniorName} - ${data.liveSeniorAddress}`
      );
    if (data.liveRehab === "Yes")
      livingDetails.push(
        `Rehab: ${data.liveRehabName} - ${data.liveRehabAddress}`
      );
    set("cp-liveDetails", livingDetails.join(" | "));

    // Payment & Insurance
    set("cp-paymentType", data.paymentType);
    set("cp-paymentOptions", data.paymentOptions);

    // Show/hide payment details based on payment option
    const bankDetails = document.getElementById("cp-paymentBankDetails");
    const digitalDetails = document.getElementById("cp-paymentDigitalDetails");
    const cardDetails = document.getElementById("cp-paymentCardDetails");
    const cashCheck = document.getElementById("cp-paymentCashCheck");
    const emptyPayment = document.getElementById("cp-paymentEmpty");

    // Hide all sections first
    if (bankDetails) bankDetails.classList.add("hidden");
    if (digitalDetails) digitalDetails.classList.add("hidden");
    if (cardDetails) cardDetails.classList.add("hidden");
    if (cashCheck) cashCheck.classList.add("hidden");
    if (emptyPayment) emptyPayment.classList.add("hidden");

    // Show relevant section based on payment option
    const payOpt = data.paymentOptions?.toLowerCase() || "";
    if (payOpt.includes("direct deposit") || payOpt.includes("bank deposit")) {
      if (bankDetails) bankDetails.classList.remove("hidden");
      set("cp-payBankName", data.payBankName);
      set("cp-payHolderName", data.payHolderName);
      set("cp-payAccountType", data.payAccountType);
      set("cp-payHolderType", data.payHolderType);
      set("cp-payBusinessName", data.payBusinessName);
      set(
        "cp-payAccountNum",
        data.payAccountNum ? `****${data.payAccountNum.slice(-4)}` : "****"
      );
      set(
        "cp-payRoutingNum",
        data.payRoutingNum ? `****${data.payRoutingNum.slice(-4)}` : "****"
      );

      // Show business name row if holder type is Business
      const businessRow = document.getElementById("cp-payBusinessNameRow");
      if (businessRow && data.payHolderType === "Business") {
        businessRow.classList.remove("hidden");
      } else if (businessRow) {
        businessRow.classList.add("hidden");
      }
    } else if (payOpt.includes("zelle") || payOpt.includes("apple pay")) {
      if (digitalDetails) digitalDetails.classList.remove("hidden");
      set("cp-payDigitalFullName", data.payDigitalFullName);
      set("cp-payDigitalType", data.payDigitalType);
      set("cp-payDigitalValue", data.payDigitalValue);
    } else if (
      payOpt.includes("credit") ||
      payOpt.includes("debit") ||
      payOpt.includes("card")
    ) {
      if (cardDetails) cardDetails.classList.remove("hidden");
      set("cp-payCardName", data.payCardName);
      set(
        "cp-payCardNumber",
        data.payCardNumber
          ? `**** **** **** ${data.payCardNumber.slice(-4)}`
          : "****"
      );
      set("cp-payCardExpiry", data.payCardExpiry);
    } else if (payOpt.includes("cash") || payOpt.includes("check")) {
      if (cashCheck) cashCheck.classList.remove("hidden");
      const cashCheckType = document.getElementById("cp-cashCheckType");
      if (cashCheckType) cashCheckType.textContent = data.paymentOptions;
    } else {
      if (emptyPayment) emptyPayment.classList.remove("hidden");
    }

    // Insurance Details
    set("cp-insuranceCompany", data.insuranceCompany);
    set(
      "cp-insuranceAddressFull",
      fmtAddr(
        data.insuranceAddress,
        data.insuranceApt,
        data.insuranceCity,
        data.insuranceState,
        data.insuranceZip
      )
    );
    set("cp-insurancePolicy", data.insurancePolicy);
    set("cp-insuranceMemberId", data.insuranceMemberId);
    set("cp-insuranceClaim", data.insuranceClaim);
    set("cp-insuranceCase", data.insuranceCase);
    set("cp-insuranceContactName", data.insuranceContactName);
    set("cp-insuranceContactPhone", data.insuranceContactPhone);
    set("cp-insuranceNote", data.insuranceAddNote);

    // Document Links
    const docLinks = [
      { id: "cp-agreementLink", url: data.agreementLink },
      { id: "cp-exhibitALink", url: data.exhibitALink },
      { id: "cp-exhibitBLink", url: data.exhibitBLink },
      { id: "cp-billOfRightsLink", url: data.billOfRightsLink },
      { id: "cp-hipaaLink", url: data.hipaaLink },
      { id: "cp-privacyLink", url: data.privacyLink },
    ];

    let hasDocuments = false;
    docLinks.forEach((doc) => {
      const linkEl = document.getElementById(doc.id);
      if (linkEl) {
        if (doc.url && doc.url.trim() !== "") {
          linkEl.href = doc.url;
          linkEl.classList.remove("hidden");
          hasDocuments = true;
        } else {
          linkEl.classList.add("hidden");
        }
      }
    });

    // Show/hide "no documents" message
    const noDocsEl = document.getElementById("cp-noDocuments");
    if (noDocsEl) {
      if (hasDocuments) {
        noDocsEl.classList.add("hidden");
      } else {
        noDocsEl.classList.remove("hidden");
      }
    }

    // 11. Footer / Metadata
    // Clean date formatting
    const fmtDate = (d) => {
      if (!d) return "--";
      const dt = new Date(d);
      return !isNaN(dt.getTime()) ? dt.toLocaleDateString() : d;
    };

    set("cp-createdAt", fmtDate(data.createdAt));
    set("cp-lastReviewed", fmtDate(data.lastReviewed));
    set("cp-coordinator", data.coordinator);

    document.getElementById("clProfileLoading").classList.add("hidden");
    document.getElementById("clProfileContent").classList.remove("hidden");
  }

  /* Financial Logic Wrappers for Edit View - using 'ce-' prefix */
  function toggleEditClientPaymentOther() {
    const el = document.getElementById("ce-paymentType");
    if (!el) return;
    const val = el.value;
    const cont = document.getElementById("ce-paymentTypeOtherContainer");
    if (cont) {
      if (val === "Other") cont.classList.remove("hidden");
      else cont.classList.add("hidden");
    }
  }

  function toggleEditClientPaymentDetails() {
    const opts = document.getElementsByName("paymentOptions");
    let selected = "";
    opts.forEach((r) => {
      if (r.checked) selected = r.value.toLowerCase();
    });

    const bank = document.getElementById("ce-bankDetails");
    const digital = document.getElementById("ce-digitalDetails");
    const card = document.getElementById("ce-cardDetails");
    const check = document.getElementById("ce-checkDetails");

    if (bank) bank.classList.add("hidden");
    if (digital) digital.classList.add("hidden");
    if (card) card.classList.add("hidden");
    if (check) check.classList.add("hidden");

    if (["direct deposit", "bank deposit"].includes(selected)) {
      if (bank) bank.classList.remove("hidden");
    } else if (["zelle", "apple pay"].includes(selected)) {
      if (digital) digital.classList.remove("hidden");
    } else if (["credit/debit card"].includes(selected)) {
      if (card) card.classList.remove("hidden");
    } else if (["check"].includes(selected)) {
      if (check) check.classList.remove("hidden");
    }
  }

  function toggleEditClientBusinessName() {
    const el = document.getElementById("ce-payHolderType");
    if (!el) return;
    const type = el.value;
    const cont = document.getElementById("ce-payBusinessNameContainer");
    if (cont) {
      if (type === "Business") cont.classList.remove("hidden");
      else cont.classList.add("hidden");
    }
  }

  function toggleEditClientDigitalInputs() {
    const type = document.querySelector(
      'input[name="payDigitalType"]:checked'
    )?.value;
    const lbl = document.getElementById("ce-payDigitalValueLabel");
    if (lbl) {
      lbl.textContent = type === "email" ? "Email Address" : "Phone Number";
    }
  }

  function calculateEditClientCosts() {
    const hrs =
      parseFloat(document.getElementById("ce-projectHours").value) || 0;
    const rate =
      parseFloat(document.getElementById("ce-hourlyRate").value) || 0;

    const weekly = hrs * rate;
    const monthly = weekly * 4.33; // Standard avg

    document.getElementById("ce-weeklyCost").value = weekly.toFixed(2);
    document.getElementById("ce-monthlyCost").value = monthly.toFixed(2);
  }

  function editClientProfile() {
    if (!currentClientData) {
      console.warn("No client data found for editing.");
      return;
    }

    try {
      switchClView("edit");

      const d = currentClientData;
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val === undefined || val === null ? "" : val;
      };

      const setCheckboxes = (containerId, valString) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((cb) => (cb.checked = false));
        if (!valString) return;
        const vals = valString.split(",").map((s) => s.trim());
        vals.forEach((v) => {
          const cb = container.querySelector(`input[value="\${v}"]`);
          if (cb) cb.checked = true;
        });
      };

      setVal("ce-id", d.id);

      // Dates helpers
      const setDate = (id, val) => {
        if (!val) {
          setVal(id, "");
          return;
        }
        const dt = new Date(val);
        if (isNaN(dt.getTime())) {
          setVal(id, val);
          return;
        } // fallback if not date string
        setVal(id, dt.toISOString().split("T")[0]);
      };
      const setDateTime = (id, val) => {
        if (!val) {
          setVal(id, "");
          return;
        }
        const dt = new Date(val);
        if (isNaN(dt.getTime())) {
          setVal(id, "");
          return;
        }
        // Create local ISO string manually to keep local time
        const pad = (n) => (n < 10 ? "0" + n : n);
        const localIso =
          dt.getFullYear() +
          "-" +
          pad(dt.getMonth() + 1) +
          "-" +
          pad(dt.getDate()) +
          "T" +
          pad(dt.getHours()) +
          ":" +
          pad(dt.getMinutes());
        setVal(id, localIso);
      };

      // 1. Admin
      setVal("ce-status", d.status);
      setVal("ce-coordinator", d.coordinator);
      setVal("ce-referredBy", d.referredBy);
      setVal("ce-username", d.username);
      setDate("ce-contactDate", d.contactDate);
      setDateTime("ce-assessmentDateTime", d.assessmentDateTime);

      // 2. Personal
      setVal("ce-firstName", d.firstName);
      setVal("ce-middleName", d.middleName);
      setVal("ce-lastName", d.lastName);
      setDate("ce-dob", d.dob);
      setVal("ce-gender", d.gender);
      setVal("ce-maritalStatus", d.maritalStatus);
      setVal("ce-spouseName", d.spouseName);
      setVal("ce-ssn", d.ssn);
      setVal("ce-ein", d.ein);
      setVal("ce-height", d.height);
      if (d.height) convertHeight(document.getElementById("ce-height"));
      setVal("ce-weight", d.weight);
      if (d.weight) convertWeight(d.weight);
      setVal("ce-codeStatus", d.codeStatus);

      // Handle languages (checkboxes + other input)
      const langContainer = document.getElementById("ce-languages-container");
      if (langContainer) {
        const checkboxes = langContainer.querySelectorAll(
          'input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = false)); // Reset

        const otherInput = document.getElementById("ce-otherLangInput");
        if (otherInput) {
          otherInput.value = "";
          otherInput.classList.add("hidden");
        }

        if (d.languages) {
          const langs = d.languages.split(",").map((s) => s.trim());
          const checkValues = Array.from(checkboxes).map((cb) => cb.value);
          const otherLangs = [];

          langs.forEach((lang) => {
            if (checkValues.includes(lang)) {
              const cb = langContainer.querySelector(`input[value="${lang}"]`);
              if (cb) cb.checked = true;
            } else {
              otherLangs.push(lang);
            }
          });

          if (otherLangs.length > 0) {
            const otherCb = langContainer.querySelector('input[value="Other"]');
            if (otherCb) {
              otherCb.checked = true;
              toggleClientOtherLang(otherCb);
              if (otherInput) otherInput.value = otherLangs.join(", ");
            }
          }
        }
      }

      // 3. Contact
      setVal("ce-clientPhone", d.clientPhone);
      setVal("ce-email", d.email);
      setVal("ce-clientAddress", d.clientAddress);
      setVal("ce-clientApt", d.clientApt);
      setVal("ce-clientCity", d.clientCity);
      setVal("ce-clientState", d.clientState);
      setVal("ce-clientZip", d.clientZip);

      setVal("ce-billingAddress", d.billingAddress);
      setVal("ce-billingApt", d.billingApt);
      setVal("ce-billingCity", d.billingCity);
      setVal("ce-billingState", d.billingState);
      setVal("ce-billingZip", d.billingZip);

      // 4. Key Contacts
      setVal("ce-repName", d.repName);
      setVal("ce-repRelationship", d.repRelationship);
      setVal("ce-repPhone", d.repPhone);

      setVal("ce-emergencyName", d.emergencyName);
      setVal("ce-emergencyRelationship", d.emergencyRelationship);
      setVal("ce-emergencyPhone", d.emergencyPhone);
      setVal("ce-emergencyEmail", d.emergencyEmail);
      setVal("ce-emergencyAddress", d.emergencyAddress);
      setVal("ce-emergencyApt", d.emergencyApt);
      setVal("ce-emergencyCity", d.emergencyCity);
      setVal("ce-emergencyState", d.emergencyState);
      setVal("ce-emergencyZip", d.emergencyZip);

      setVal("ce-authName", d.authName);
      setVal("ce-authRelationship", d.authRelationship);
      setVal("ce-authPhone", d.authPhone);
      setVal("ce-authEmail", d.authEmail);
      setVal("ce-authAddress", d.authAddress);
      setVal("ce-authApt", d.authApt);
      setVal("ce-authCity", d.authCity);
      setVal("ce-authState", d.authState);
      setVal("ce-authZip", d.authZip);

      // 5. Medical
      setVal("ce-diagnosis", d.diagnosis);

      setVal("ce-allergies", d.allergies);
      setVal("ce-allergiesDetail", d.allergiesDetail);
      if (document.getElementById("ce-allergies")) {
        toggleDetailInput(
          document.getElementById("ce-allergies"),
          "ce-allergies-detail",
          "Yes"
        );
      }

      // Checkboxes for Medical
      setCheckboxes("ce-medicalHistory-container", d.medicalHistory);
      setCheckboxes("ce-medicalAids-container", d.medicalAids);
      setCheckboxes("ce-mobility-container", d.mobility);
      setCheckboxes("ce-dietaryInfo-container", d.dietaryInfo);

      // Mental Status
      const mentalStatus = d.mentalStatus || "";
      const mentalSelect = document.getElementById("ce-mentalStatus");
      const mentalOtherInput = document.getElementById("ce-mentalStatus-other");
      const mentalOtherContainer = document.getElementById(
        "ce-mental-other-container"
      );
      if (mentalSelect) {
        const mOpts = Array.from(mentalSelect.options).map((o) => o.value);
        if (mOpts.includes(mentalStatus)) {
          mentalSelect.value = mentalStatus;
          if (mentalOtherContainer)
            mentalOtherContainer.classList.add("hidden");
          if (mentalOtherInput) mentalOtherInput.value = "";
        } else if (mentalStatus.startsWith("Other: ")) {
          mentalSelect.value = "Other";
          if (mentalOtherContainer)
            mentalOtherContainer.classList.remove("hidden");
          if (mentalOtherInput)
            mentalOtherInput.value = mentalStatus.substring(7);
        } else {
          mentalSelect.value = "";
        }
      }

      setVal("ce-medList", d.medList);
      setVal("ce-medReminder", d.medReminder);
      setVal("ce-selfAdminMed", d.selfAdminMed);
      setVal("ce-takingMed", d.takingMed);
      setVal("ce-medOverseer", d.medOverseer);

      setVal("ce-assistDirections", d.assistDirections);
      setVal("ce-assistDirectionsDetail", d.assistDirectionsDetail);
      if (document.getElementById("ce-assistDirections")) {
        toggleDetailInput(
          document.getElementById("ce-assistDirections"),
          "ce-assistDirections-detail",
          "Yes"
        );
      }

      // Sensory & Continent
      setVal("ce-blind", d.blind);
      setVal("ce-glasses", d.glasses);
      setVal("ce-dentures", d.dentures);

      setCheckboxes("ce-continent-container", d.continent);
      setCheckboxes("ce-incontinent-container", d.incontinent);

      // Care Plan Grids
      setCheckboxes("ce-dailyLivingSkills-container", d.dailyLivingSkills);
      setCheckboxes("ce-transportation-container", d.transportation);
      setCheckboxes("ce-mealPreparation-container", d.mealPreparation);
      setCheckboxes("ce-lightHousekeeping-container", d.lightHousekeeping);

      // Living Environment
      setVal("ce-liveAlone", d.liveAlone);
      setVal("ce-liveFamily", d.liveFamily);
      const famDetail = document.getElementById("ce-liveFamily-detail");
      if (famDetail) {
        if (d.liveFamily === "Yes") famDetail.classList.remove("hidden");
        else famDetail.classList.add("hidden");
      }
      setVal("ce-liveFamilyName", d.liveFamilyName);

      setVal("ce-liveSenior", d.liveSenior);
      const senDetail = document.getElementById("ce-liveSenior-detail");
      if (senDetail) {
        if (d.liveSenior === "Yes") senDetail.classList.remove("hidden");
        else senDetail.classList.add("hidden");
      }
      setVal("ce-liveSeniorName", d.liveSeniorName);
      setVal("ce-liveSeniorAddress", d.liveSeniorAddress);

      setVal("ce-liveRehab", d.liveRehab);
      const rehabDetail = document.getElementById("ce-liveRehab-detail");
      if (rehabDetail) {
        if (d.liveRehab === "Yes") rehabDetail.classList.remove("hidden");
        else rehabDetail.classList.add("hidden");
      }
      setVal("ce-liveRehabName", d.liveRehabName);
      setVal("ce-liveRehabAddress", d.liveRehabAddress);

      setVal("ce-smoke", d.smoke);
      setVal("ce-drink", d.drink);

      setVal("ce-pets", d.pets);
      const petsDetail = document.getElementById("ce-pets-detail");
      if (petsDetail) {
        if (d.pets === "Yes") petsDetail.classList.remove("hidden");
        else petsDetail.classList.add("hidden");
      }
      setCheckboxes("ce-petsList-container", d.petsList);
      setVal("ce-petsNote", d.petsNote);

      setVal("ce-pharmacyName", d.pharmacyName);

      setVal("ce-hospitalName", d.hospitalName);
      setVal("ce-hospitalPhone", d.hospitalPhone);
      setVal("ce-hospitalAddress", d.hospitalAddress);

      setVal("ce-covidVaccine", d.covidVaccine);
      setVal("ce-covidVaccineDetail", d.covidVaccineDetail);
      if (document.getElementById("ce-covidVaccine")) {
        toggleDetailInput(
          document.getElementById("ce-covidVaccine"),
          "ce-covidVaccine-detail",
          "Yes"
        );
      }

      setVal("ce-fluVaccine", d.fluVaccine);
      setVal("ce-fluVaccineDetail", d.fluVaccineDetail);
      if (document.getElementById("ce-fluVaccine")) {
        toggleDetailInput(
          document.getElementById("ce-fluVaccine"),
          "ce-fluVaccine-detail",
          "Yes"
        );
      }

      // Extended Healthcare
      setVal("ce-primaryDrName", d.primaryDrName);
      setVal("ce-drOfficeName", d.drOfficeName);
      setVal("ce-drPhone", d.drPhone);
      setVal("ce-drAddress", d.drAddress);

      setVal("ce-hospitalName", d.hospitalName);
      setVal("ce-hospitalPhone", d.hospitalPhone);
      setVal("ce-hospitalAddress", d.hospitalAddress);

      setVal("ce-pharmacyName", d.pharmacyName);
      setVal("ce-pharmacyPhone", d.pharmacyPhone);
      setVal("ce-pharmacyAddress", d.pharmacyAddress);

      // 6. Care Plan
      // Care Matching
      setCheckboxes("ce-careCertifications-container", d.careCertifications);
      setVal("ce-careGender", d.careGender);
      setVal("ce-careSmokePremises", d.careSmokePremises);
      setVal("ce-careSmokeNote", d.careSmokeNote);
      setCheckboxes("ce-careSkills-container", d.careSkills);

      // Live-in Radio
      if (d.careLiveIn) {
        const radios = document.getElementsByName("careLiveIn");
        radios.forEach((r) => {
          if (r.value === d.careLiveIn) r.checked = true;
        });
      }

      // Accommodation
      setCheckboxes("ce-careAccommodation-container", d.careAccommodation);
      // Handle Accommodation Other
      if (d.careAccommodation && d.careAccommodation.includes("Other")) {
        const accOther = d.careAccommodation.split("Other:")[1]; // crude parse if stored as "Bedroom, Other: X"
        // Better: Check if "Other" checkbox is checked, if so, populate input?
        // The setCheckboxes function checks "Other" if "Other" is in the string.
        // But our storage format is comma separated.
        // If stored as "Bedroom, Other: My Note", split by comma might be tricky if note has comma.
        // Assuming simple CSV.

        // Let's refine how we handle "Other" for accommodation if it mimics the mentalStatus pattern
        const accContainer = document.getElementById(
          "ce-careAccommodation-container"
        );
        if (accContainer) {
          const otherCb = accContainer.querySelector('input[value="Other"]');
          if (otherCb && otherCb.checked) {
            const detailContainer = document.getElementById(
              "ce-careAccommodation-other-container"
            );
            const detailInput = document.getElementById(
              "ce-careAccommodation-other"
            );
            if (detailContainer) detailContainer.classList.remove("hidden");
            // Extract text: "Other: details" -> "details"
            const match = d.careAccommodation.match(/Other:\s*(.*)/);
            if (match && detailInput)
              detailInput.value = match[1].split(",")[0]; // rough extraction
          }
        }
      }

      setVal("ce-levelOfCare", d.levelOfCare);

      setVal("ce-careNeeds", d.careNeeds);
      setVal("ce-serviceNeedsText", d.serviceNeedsText);
      setVal("ce-goals", d.goals);

      setCheckboxes("ce-serviceTypes-container", d.serviceTypes);

      setVal("ce-projectHours", d.projectHours);

      setVal("ce-schMO", d.schMO);
      setVal("ce-schT", d.schT);
      setVal("ce-schW", d.schW);
      setVal("ce-schTH", d.schTH);
      setVal("ce-schFR", d.schFR);
      setVal("ce-schSA", d.schSA);
      setVal("ce-schSU", d.schSU);

      // 7. Financials
      // Payment Type
      const payTypeSelect = document.getElementById("ce-paymentType");
      if (payTypeSelect) {
        // Check if value is one of the options
        const stdOpts = [
          "Private pay",
          "Lead Insurance",
          "Medicaid",
          "VA",
          "Other",
        ];
        const val = d.paymentType || "";
        if (stdOpts.includes(val) && val !== "Other") {
          payTypeSelect.value = val;
          setVal("ce-paymentTypeOther", "");
        } else if (val !== "") {
          // It's a custom value -> Toggle Other
          payTypeSelect.value = "Other";
          setVal("ce-paymentTypeOther", val);
        } else {
          payTypeSelect.value = "";
          setVal("ce-paymentTypeOther", "");
        }
        toggleEditClientPaymentOther();
      }

      // Payment Options (Radio)
      const payOpts = document.getElementsByName("paymentOptions");
      // Reset first
      payOpts.forEach((r) => (r.checked = false));
      if (d.paymentOptions) {
        payOpts.forEach((r) => {
          if (r.value.toLowerCase() === d.paymentOptions.toLowerCase())
            r.checked = true;
        });
      }
      toggleEditClientPaymentDetails();

      // Bank Details
      setVal("ce-payBankName", d.payBankName);
      setVal("ce-payHolderName", d.payHolderName);
      setVal("ce-payAccountType", d.payAccountType);
      setVal("ce-payHolderType", d.payHolderType);
      setVal("ce-payBusinessName", d.payBusinessName);
      toggleEditClientBusinessName();
      setVal("ce-payAccountNum", d.payAccountNum);
      setVal("ce-payAccountNumConfirm", d.payAccountNum);
      setVal("ce-payRoutingNum", d.payRoutingNum);
      setVal("ce-payRoutingNumConfirm", d.payRoutingNum);

      // Digital Details
      setVal("ce-payDigitalFullName", d.payDigitalFullName);
      // Radio for Digital Type
      const digTypes = document.getElementsByName("payDigitalType");
      if (d.payDigitalType) {
        digTypes.forEach((r) => (r.checked = r.value === d.payDigitalType));
      }
      setVal("ce-payDigitalValue", d.payDigitalValue);
      toggleEditClientDigitalInputs();

      // Card Details
      setVal("ce-payCardName", d.payCardName);
      setVal("ce-payCardNumber", d.payCardNumber);
      setVal("ce-payCardExpiry", d.payCardExpiry);
      setVal("ce-payCardCVV", d.payCardCVV);

      // Hourly/Costs
      setVal("ce-hourlyRate", d.hourlyRate);

      const overtimeCheckbox = document.getElementById("ce-overtime");
      if (overtimeCheckbox)
        overtimeCheckbox.checked = d.overtime === "Yes" || d.overtime === true;

      setVal("ce-weeklyCost", d.weeklyCost);
      setVal("ce-monthlyCost", d.monthlyCost);

      // Insurance (Expanded)
      setVal("ce-insuranceCompany", d.insuranceCompany);
      setVal("ce-insuranceAddress", d.insuranceAddress);
      setVal("ce-insuranceApt", d.insuranceApt);
      setVal("ce-insuranceCity", d.insuranceCity);
      setVal("ce-insuranceState", d.insuranceState);
      setVal("ce-insuranceZip", d.insuranceZip);

      setVal("ce-insurancePolicy", d.insurancePolicy);
      setVal("ce-insuranceMemberId", d.insuranceMemberId);
      setVal("ce-insuranceCase", d.insuranceCase);
      setVal("ce-insuranceClaim", d.insuranceClaim);

      setVal("ce-insuranceContactName", d.insuranceContactName);
      setVal("ce-insuranceContactPhone", d.insuranceContactPhone);
      setVal("ce-insuranceAddNote", d.insuranceAddNote);

      // 8. Documents
      setVal("ce-agreementLink", d.agreementLink);
      setVal("ce-exhibitALink", d.exhibitALink);
      setVal("ce-exhibitBLink", d.exhibitBLink);
      setVal("ce-billOfRightsLink", d.billOfRightsLink);
      setVal("ce-hipaaLink", d.hipaaLink);
      setVal("ce-privacyLink", d.privacyLink);
    } catch (e) {
      console.error("Error in editClientProfile:", e);
      Swal.fire("Error", "Failed to prepare edit form: " + e.message, "error");
    }
  }

  function submitEditClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("updateClientBtn");
    btn.disabled = true;
    btn.textContent = "Updating...";

    const form = document.getElementById("clientEditForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      if (key !== "languages" && key !== "overtime" && key !== "mentalStatus") {
        // Handled manually
        data[key] = value;
      }
    });

    // Handle Payment Type Other Override
    if (data.paymentType === "Other") {
      const ptOther = document
        .getElementById("ce-paymentTypeOther")
        .value.trim();
      if (ptOther) data.paymentType = ptOther;
    }

    // Validation for Financials
    if (data.payAccountNum) {
      const confirm = document.getElementById("ce-payAccountNumConfirm").value;
      if (data.payAccountNum !== confirm) {
        Swal.fire("Error", "Bank Account Numbers do not match.", "error");
        btn.disabled = false;
        btn.textContent = "Update Client";
        return;
      }
    }
    if (data.payRoutingNum) {
      const confirm = document.getElementById("ce-payRoutingNumConfirm").value;
      if (data.payRoutingNum !== confirm) {
        Swal.fire("Error", "Bank Routing Numbers do not match.", "error");
        btn.disabled = false;
        btn.textContent = "Update Client";
        return;
      }
    }

    // Handle Mental Status
    const msSelect = document.getElementById("ce-mentalStatus");
    if (msSelect) {
      if (msSelect.value === "Other") {
        const msOther = document
          .getElementById("ce-mentalStatus-other")
          .value.trim();
        data.mentalStatus = msOther ? "Other: " + msOther : "Other";
      } else {
        data.mentalStatus = msSelect.value;
      }
    }

    // Helper for joining checkboxes
    const getChecked = (id) => {
      const c = document.getElementById(id);
      if (!c) return "";
      return Array.from(c.querySelectorAll('input[type="checkbox"]:checked'))
        .map((cb) => cb.value)
        .join(", ");
    };

    data.serviceTypes = getChecked("ce-serviceTypes-container");
    data.continent = getChecked("ce-continent-container");
    data.incontinent = getChecked("ce-incontinent-container");

    // Collect new Checkbox Grids
    data.medicalHistory = getChecked("ce-medicalHistory-container");
    const mhOther = document.getElementById("ce-medicalHistory-other");
    if (
      mhOther &&
      data.medicalHistory.includes("Other") &&
      mhOther.value.trim()
    ) {
      data.medicalHistory = data.medicalHistory.replace(
        "Other",
        "Other: " + mhOther.value.trim()
      );
    }

    data.medicalAids = getChecked("ce-medicalAids-container");
    const maOther = document.getElementById("ce-medicalAids-other");
    if (maOther && data.medicalAids.includes("Other") && maOther.value.trim()) {
      data.medicalAids = data.medicalAids.replace(
        "Other",
        "Other: " + maOther.value.trim()
      );
    }

    data.mobility = getChecked("ce-mobility-container");
    data.dietaryInfo = getChecked("ce-dietaryInfo-container");

    data.dailyLivingSkills = getChecked("ce-dailyLivingSkills-container");
    data.transportation = getChecked("ce-transportation-container");
    data.mealPreparation = getChecked("ce-mealPreparation-container");
    data.lightHousekeeping = getChecked("ce-lightHousekeeping-container");

    data.petsList = getChecked("ce-petsList-container");

    // Care Matching
    data.careCertifications = getChecked("ce-careCertifications-container");
    data.careSkills = getChecked("ce-careSkills-container");

    const liveInTo = document.querySelector('input[name="careLiveIn"]:checked');
    data.careLiveIn = liveInTo ? liveInTo.value : "";

    data.careAccommodation = getChecked("ce-careAccommodation-container");
    const accOther = document.getElementById("ce-careAccommodation-other");
    if (
      accOther &&
      data.careAccommodation.includes("Other") &&
      accOther.value.trim()
    ) {
      data.careAccommodation = data.careAccommodation.replace(
        "Other",
        "Other: " + accOther.value.trim()
      );
    }

    // Handle Languages
    const langContainer = document.getElementById("ce-languages-container");
    if (langContainer) {
      const checked = Array.from(
        langContainer.querySelectorAll('input[type="checkbox"]:checked')
      ).map((cb) => cb.value);
      // Check if 'Other' is checked
      if (checked.includes("Other")) {
        const otherInput = document.getElementById("ce-otherLangInput");
        const otherText = otherInput ? otherInput.value.trim() : "";
        // Remove "Other" from array and add the text
        const index = checked.indexOf("Other");
        if (index > -1) checked.splice(index, 1);
        if (otherText) {
          const others = otherText
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          checked.push(...others);
        }
      }
      data.languages = checked.join(", ");
    } else {
      // Fallback if container not found (e.g. older version), though we edited HTML
      data.languages = formData.get("languages");
    }

    // Handle Overtime
    const overtimeCheckbox = document.getElementById("ce-overtime");
    if (overtimeCheckbox) {
      data.overtime = overtimeCheckbox.checked ? "Yes" : "No";
    }

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Update Client Information";
        if (res.success) {
          Swal.fire("Success", "Client Information Updated!", "success");
          // Reload profile with new data
          loadClientProfile(data.id);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClient(data);
  }

  // --- Archive Client Functions ---

  function openArchiveClientModal() {
    document.getElementById("archiveModal").classList.remove("hidden");
    document.getElementById("archiveReason").value = "";
    document.getElementById("archiveNote").value = "";
    toggleArchiveOtherInput();
  }

  function closeArchiveClientModal() {
    document.getElementById("archiveModal").classList.add("hidden");
  }

  function toggleArchiveOtherInput() {
    const reason = document.getElementById("archiveReason").value;
    const otherContainer = document.getElementById("archiveOtherContainer");
    if (reason === "Other") {
      otherContainer.classList.remove("hidden");
    } else {
      otherContainer.classList.add("hidden");
    }
  }

  function submitArchiveClient() {
    const reason = document.getElementById("archiveReason").value;
    const note = document.getElementById("archiveNote").value.trim();

    if (!reason) {
      Swal.fire("Error", "Please select a reason.", "error");
      return;
    }

    let finalReason = reason;
    if (reason === "Other") {
      if (!note) {
        Swal.fire(
          "Error",
          "Please provide a note for 'Other' reason.",
          "error"
        );
        return;
      }
      finalReason = `Other: ${note}`;
    } else if (note) {
      // Append note if provided for standard reasons too
      finalReason = `${reason} - ${note}`;
    }

    const clientId = document.getElementById("cp-id").textContent;
    if (!clientId || clientId === "--") {
      Swal.fire("Error", "No Client ID found.", "error");
      return;
    }

    const submitBtn = document.querySelector("#archiveModal button.bg-red-600");
    const originalText = submitBtn.innerText;
    submitBtn.disabled = true;
    submitBtn.innerText = "Archiving...";

    google.script.run
      .withSuccessHandler((res) => {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
        closeArchiveClientModal();
        if (res.success) {
          Swal.fire(
            "Success",
            "Client moved to archive successfully.",
            "success"
          ).then(() => {
            switchClView("list");
            loadClientList();
          });
        } else {
          Swal.fire(
            "Error",
            res.message || "Failed to archive client.",
            "error"
          );
        }
      })
      .withFailureHandler((err) => {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
        console.error(err);
        Swal.fire(
          "Error",
          "An unexpected error occurred: " + err.message,
          "error"
        );
      })
      .archiveClient(clientId, finalReason);
  }
  function toggleOtherInput(select, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (select.value === "Other") {
      container.classList.remove("hidden");
    } else {
      container.classList.add("hidden");
    }
  }

  function toggleDetailInput(select, containerId, triggerValue) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (select.value === triggerValue) {
      container.classList.remove("hidden");
    } else {
      container.classList.add("hidden");
    }
  }

  function convertHeight(input) {
    const val = input.value;
    const span = document.getElementById(input.id + "-m");
    if (!span) return;
    if (!val) {
      span.textContent = "-- m";
      return;
    }

    let inches = 0;
    if (val.includes("'")) {
      const parts = val.split("'");
      const ft = parseFloat(parts[0]) || 0;
      const inc = parseFloat(parts[1]) || 0;
      inches = ft * 12 + inc;
    } else {
      inches = parseFloat(val) || 0;
    }

    if (inches > 0) {
      const m = inches * 0.0254;
      span.textContent = m.toFixed(2) + " m";
    } else {
      span.textContent = "-- m";
    }
  }

  function convertWeight(lbs) {
    const span = document.getElementById("ce-weight-kg");
    if (!span) return;
    if (!lbs || isNaN(lbs)) {
      span.textContent = "-- kg";
      return;
    }
    const kg = parseFloat(lbs) * 0.453592;
    span.textContent = `${kg.toFixed(1)} kg`;
  }
</script>
