<script>
  function switchClView(subView) {
    const list = document.getElementById("cl-subview-list");
    const add = document.getElementById("cl-subview-add");
    const profile = document.getElementById("cl-subview-profile");
    const edit = document.getElementById("cl-subview-edit");

    if (list) list.classList.add("hidden");
    if (add) add.classList.add("hidden");
    if (profile) profile.classList.add("hidden");
    if (edit) edit.classList.add("hidden");

    const target = document.getElementById("cl-subview-" + subView);
    if (target) target.classList.remove("hidden");
  }

  function loadClientList() {
    const tbody = document.getElementById("clTableBody");
    if (tbody)
      tbody.innerHTML =
        '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        clData = data;
        renderClTable();
      })
      .getClientList();
  }

  function renderClTable() {
    const searchEl = document.getElementById("clSearch");
    const statusEl = document.getElementById("clFilterStatus");
    const typeEl = document.getElementById("clFilterType");

    if (!searchEl) return;

    const search = searchEl.value.toLowerCase();
    const statusFilter = statusEl.value;
    const typeFilter = typeEl.value;

    const filtered = clData.filter((item) => {
      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search);
      const matchStatus =
        statusFilter === "All" || item.status === statusFilter;
      const matchType = typeFilter === "All" || item.type === typeFilter;
      return matchSearch && matchStatus && matchType;
    });

    const totalPages = Math.ceil(filtered.length / clRowsPerPage);
    if (clCurrentPage > totalPages) clCurrentPage = 1;

    const start = (clCurrentPage - 1) * clRowsPerPage;
    const end = start + clRowsPerPage;
    const pageData = filtered.slice(start, end);

    const tbody = document.getElementById("clTableBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No clients found.</td></tr>';
    } else {
      pageData.forEach((row) => {
        let statusColor = "bg-gray-100 text-gray-600";
        if (row.status === "Active")
          statusColor = "bg-green-100 text-green-700";
        if (row.status === "Inactive") statusColor = "bg-red-100 text-red-700";
        if (row.status === "Cancelled service")
          statusColor = "bg-gray-200 text-gray-800";
        if (row.status === "Temporary hospital stay")
          statusColor = "bg-orange-100 text-orange-800";

        tbody.innerHTML += `
        <tr class="hover:bg-gray-50 border-b border-gray-50">
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4 text-sm text-gray-600">${row.type}</td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip || ""}</p>
            </div>
          </td>
          <td class="p-4 text-xs text-gray-500">${row.lastReviewed || "--"}</td>
          <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${
          row.status
        }</span></td>
          <td class="p-4 text-right">
             <button onclick="loadClientProfile('${
               row.id
             }')" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full hover:bg-green-100 font-bold border border-green-200 transition-colors">Details</button>
          </td>
        </tr>
      `;
      });
    }

    const infoEl = document.getElementById("clPageInfo");
    if (infoEl) {
      infoEl.textContent = `Showing ${
        pageData.length > 0 ? start + 1 : 0
      }-${Math.min(end, filtered.length)} of ${filtered.length}`;
    }
    const btnPrev = document.getElementById("clBtnPrev");
    const btnNext = document.getElementById("clBtnNext");
    if (btnPrev) btnPrev.disabled = clCurrentPage === 1;
    if (btnNext)
      btnNext.disabled = clCurrentPage >= totalPages || totalPages === 0;
  }

  function changeClPage(dir) {
    clCurrentPage += dir;
    renderClTable();
  }

  function submitClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveClientBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("clientForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Register Client & Send Email";
        if (res.success) {
          Swal.fire("Success", "Client Registered!", "success");
          form.reset();
          switchClView("list");
          loadClientList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleClientSubmission(data);
  }

  function loadClientProfile(id) {
    switchClView("profile");
    document.getElementById("clProfileLoading").classList.remove("hidden");
    document.getElementById("clProfileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        currentClientData = data;
        renderClientProfile(data);
      })
      .getClientDetails(id);
  }

  function renderClientProfile(data) {
    if (!data) return;

    // Helper to set text content safely
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = val || "--";
    };

    set(
      "cp-initials",
      (data.firstName?.[0] || "") + (data.lastName?.[0] || "")
    );
    set(
      "cp-name",
      `${data.firstName} ${data.middleName || ""} ${data.lastName}`
    );
    set("cp-id", data.id);
    set("cp-status", data.status);
    set("cp-email", data.email);
    set("cp-phone", data.phone);
    set(
      "cp-address",
      `${data.address || ""}, ${data.city || ""} ${data.zip || ""}`
    );

    // Format DOB
    let dob = data.dob;
    if (dob) {
      const d = new Date(dob);
      if (!isNaN(d.getTime())) {
        dob = d.toLocaleDateString();
      }
    }
    set("cp-dob", dob);

    set("cp-gender", data.gender);
    set("cp-type", data.type);
    set(
      "cp-living",
      data.livingAlone === "Yes" ? "Living Alone" : "Not Living Alone"
    );
    set("cp-languages", data.languages);

    set("cp-emName", data.emName);
    set("cp-emRel", data.emRel);
    set("cp-emPhone", data.emPhone);
    set("cp-emEmail", data.emEmail);
    set(
      "cp-emAddress",
      `${data.emAddress || ""}, ${data.emCity || ""} ${data.emZip || ""}`
    );

    document.getElementById("clProfileLoading").classList.add("hidden");
    document.getElementById("clProfileContent").classList.remove("hidden");
  }

  function editClientProfile() {
    if (!currentClientData) return;
    switchClView("edit");

    const d = currentClientData;
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val || "";
    };

    setVal("ce-id", d.id);
    setVal("ce-firstName", d.firstName);
    setVal("ce-middleName", d.middleName);
    setVal("ce-lastName", d.lastName);
    setVal("ce-status", d.status);

    // Format DOB for input[type="date"]
    let dob = "";
    if (d.dob) {
      const dateObj = new Date(d.dob);
      if (!isNaN(dateObj.getTime())) {
        dob = dateObj.toISOString().split("T")[0];
      }
    }
    setVal("ce-dob", dob);

    setVal("ce-gender", d.gender);
    setVal("ce-email", d.email);
    setVal("ce-phone", d.phone);
    setVal("ce-address", d.address);
    setVal("ce-city", d.city);
    setVal("ce-zip", d.zip);
    setVal("ce-type", d.type);
    setVal("ce-livingAlone", d.livingAlone);
    setVal("ce-languages", d.languages);
    setVal("ce-emName", d.emName);
    setVal("ce-emRel", d.emRel);
    setVal("ce-emEmail", d.emEmail);
    setVal("ce-emPhone", d.emPhone);
    setVal("ce-emAddress", d.emAddress);
    setVal("ce-emCity", d.emCity);
    setVal("ce-emZip", d.emZip);
  }

  function submitEditClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("updateClientBtn");
    btn.disabled = true;
    btn.textContent = "Updating...";

    const form = document.getElementById("clientEditForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Update Client";
        if (res.success) {
          Swal.fire("Success", "Client Updated!", "success");
          // Reload profile with new data
          loadClientProfile(data.id);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClient(data);
  }
</script>
