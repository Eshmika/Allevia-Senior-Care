<script>
  // Globals (currentClientData, clData, etc) are defined in js-utils.html

  function switchClView(subView) {
    const list = document.getElementById("cl-subview-list");
    const add = document.getElementById("cl-subview-add");
    const profile = document.getElementById("cl-subview-profile");
    const edit = document.getElementById("cl-subview-edit");

    if (list) list.classList.add("hidden");
    if (add) add.classList.add("hidden");
    if (profile) profile.classList.add("hidden");
    if (edit) edit.classList.add("hidden");

    const target = document.getElementById("cl-subview-" + subView);
    if (target) target.classList.remove("hidden");

    // Set today's date when switching to add view
    if (subView === "add" && typeof setTodayDate === "function") {
      setTodayDate();
    }
  }

  // Format phone number as (XXX) XXX-XXXX
  function formatPhone(input) {
    // Save selection start to restore cursor position
    const selectionStart = input.selectionStart;
    const oldLength = input.value.length;

    let value = input.value.replace(/\D/g, ""); // Remove non-digits

    if (value.length > 10) {
      value = value.substring(0, 10); // Limit to 10 digits
    }

    let formattedValue = "";
    if (value.length > 0) {
      formattedValue = "(" + value.substring(0, 3);
      if (value.length > 3) {
        formattedValue += ") " + value.substring(3, 6);
      }
      if (value.length > 6) {
        formattedValue += "-" + value.substring(6, 10);
      }
    }

    input.value = formattedValue;

    // Restore cursor position logically
    const newLength = formattedValue.length;
    let newCursorPos = selectionStart + (newLength - oldLength);

    // Ensure cursor doesn't jump weirdly after formatting
    if (newCursorPos < 0) newCursorPos = 0;
    input.setSelectionRange(newCursorPos, newCursorPos);
  }

  function loadClientList() {
    const tbody = document.getElementById("clTableBody");
    if (tbody)
      tbody.innerHTML =
        '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        clData = data;
        renderClTable();
      })
      .getClientList();
  }

  function renderClTable() {
    const searchEl = document.getElementById("clSearch");
    const typeFilterEl = document.getElementById("clTypeFilter");
    const statusFilterEl = document.getElementById("clStatusFilter");

    if (!searchEl) return;

    const search = searchEl.value.toLowerCase();
    const typeFilter = typeFilterEl ? typeFilterEl.value : "";
    const statusFilter = statusFilterEl ? statusFilterEl.value : "";

    const filtered = clData.filter((item) => {
      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search) ||
        String(item.id).toLowerCase().includes(search);

      const isClientStage = item.stage === "Convert Clients";
      const matchType =
        typeFilter === "" || (item.type && item.type.includes(typeFilter));
      const matchStatus = statusFilter === "" || item.status === statusFilter;

      return matchSearch && isClientStage && matchType && matchStatus;
    });

    const totalPages = Math.ceil(filtered.length / clRowsPerPage);
    if (clCurrentPage > totalPages) clCurrentPage = 1;

    const start = (clCurrentPage - 1) * clRowsPerPage;
    const end = start + clRowsPerPage;
    const pageData = filtered.slice(start, end);

    const tbody = document.getElementById("clTableBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No clients found.</td></tr>';
    } else {
      pageData.forEach((row) => {
        let statusColor = "text-white";
        let statusStyle = "";

        if (row.status === "Active") {
          statusColor = "text-white";
          statusStyle = "background-color: #2ECC71;";
        }
        if (row.status === "Inactive") {
          statusColor = "text-white";
          statusStyle = "background-color: #95A5A6;";
        }
        if (row.status === "Cancelled service") {
          statusColor = "text-white";
          statusStyle = "background-color: #8E2A2A;";
        }
        if (row.status === "Temporary hospital stay") {
          statusColor = "text-white";
          statusStyle = "background-color: #1A5276;";
        }

        let codeStatusStyle = "";
        let codeStatusClass =
          "px-2 py-1 rounded-full text-xs font-bold inline-block";
        const cs = (row.codeStatus || "").trim();

        if (cs === "Full code") {
          codeStatusStyle = "background-color: #1E8449; color: white;";
        } else if (cs === "Comfort care") {
          codeStatusStyle = "background-color: #AF7AC5; color: white;";
        } else if (cs === "DNR") {
          codeStatusStyle = "background-color: #7B241C; color: white;";
        } else {
          codeStatusStyle = "background-color: #E5E7EB; color: #374151;";
        }

        tbody.innerHTML += `
        <tr class="hover:bg-gray-50 border-b border-gray-50">
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4 text-sm text-gray-600">${row.type}</td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip || ""}</p>
            </div>
          </td>
          <td class="p-4">
            <span class="${codeStatusClass}" style="${codeStatusStyle}">${
          row.codeStatus || "--"
        }</span>
          </td>
          <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}" style="${statusStyle}">${
          row.status
        }</span></td>
          <td class="p-4 text-right">
             <button onclick="loadClientProfile('${
               row.id
             }')" class="text-xs text-white px-3 py-1 rounded-full hover:opacity-90 font-bold transition-colors" style="background-color: #00BCD4;">Details</button>
          </td>
        </tr>
      `;
      });
    }

    const infoEl = document.getElementById("clPageInfo");
    if (infoEl) {
      infoEl.textContent = `Showing ${
        pageData.length > 0 ? start + 1 : 0
      }-${Math.min(end, filtered.length)} of ${filtered.length}`;
    }
    const btnPrev = document.getElementById("clBtnPrev");
    const btnNext = document.getElementById("clBtnNext");
    if (btnPrev) btnPrev.disabled = clCurrentPage === 1;
    if (btnNext)
      btnNext.disabled = clCurrentPage >= totalPages || totalPages === 0;
  }

  function changeClPage(dir) {
    clCurrentPage += dir;
    renderClTable();
  }

  function submitClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveClientBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("clientForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Save Client Information";
        if (res.success) {
          Swal.fire("Success", "Client Information Saved!", "success");
          form.reset();
          // Reset today's date after form reset
          setTodayDate();
          switchClView("list");
          loadClientList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleClientSubmission(data);
  }

  // Function to set today's date
  function setTodayDate() {
    const dateInput = document.getElementById("contactDate");
    if (dateInput) {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${year}-${month}-${day}`;
    }
  }

  // Initialize date when page loads or when switching to add view
  document.addEventListener("DOMContentLoaded", setTodayDate);

  function loadClientProfile(id) {
    switchClView("profile");
    document.getElementById("clProfileLoading").classList.remove("hidden");
    document.getElementById("clProfileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        currentClientData = data;
        renderClientProfile(data);
      })
      .getClientDetails(id);
  }

  function renderClientProfile(data) {
    if (!data) return;

    // Helper to set text content safely
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el)
        el.textContent =
          val === undefined || val === null || val === "" ? "--" : val;
    };

    // Helper to format address
    const fmtAddr = (addr, apt, city, state, zip) => {
      return [addr, apt ? "Apt " + apt : "", city, state, zip]
        .filter(Boolean)
        .join(", ");
    };

    // 1. Identity Header
    const fName = data.firstName || "";
    const mName = data.middleName || "";
    const lName = data.lastName || "";
    const fullName = [fName, mName, lName].filter(Boolean).join(" ");

    set("cp-name", fullName);
    set("cp-initials", (fName[0] || "") + (lName[0] || fName[0] || "?"));
    set("cp-id", data.id);
    set("cp-status", data.status);
    const statusEl = document.getElementById("cp-status");
    if (statusEl) {
      if (data.status === "Active") {
        statusEl.style.backgroundColor = "#2ECC71";
        statusEl.style.color = "white";
      } else if (data.status === "Inactive") {
        statusEl.style.backgroundColor = "#95A5A6";
        statusEl.style.color = "white";
      } else if (data.status === "Cancelled service") {
        statusEl.style.backgroundColor = "#8E2A2A";
        statusEl.style.color = "white";
      } else if (data.status === "Temporary hospital stay") {
        statusEl.style.backgroundColor = "#1A5276";
        statusEl.style.color = "white";
      } else {
        statusEl.style.backgroundColor = "";
        statusEl.style.color = "";
      }
    }
    set("cp-type", data.serviceTypes || "Client");
    set("cp-username", data.username);

    // 2. Personal Info
    set("cp-dob", data.dob);
    set("cp-gender", data.gender);
    set("cp-ssn", data.ssn);
    set("cp-ein", data.ein);
    set("cp-maritalStatus", data.maritalStatus);
    set("cp-codeStatus", data.codeStatus);
    // Apply code status color badge
    const codeStatusEl = document.getElementById("cp-codeStatus");
    if (codeStatusEl) {
      const val = (data.codeStatus || "").trim();
      codeStatusEl.style.padding = "4px 8px";
      codeStatusEl.style.borderRadius = "999px";
      codeStatusEl.style.fontWeight = "700";
      codeStatusEl.style.display = "inline-block";

      let bg = "#E5E7EB"; // gray-200
      let fg = "#374151"; // gray-700
      if (val === "Full code") {
        bg = "#1E8449";
        fg = "#FFFFFF";
      } else if (val === "Comfort care") {
        bg = "#AF7AC5";
        fg = "#FFFFFF";
      } else if (val === "DNR") {
        bg = "#7B241C";
        fg = "#FFFFFF";
      }

      codeStatusEl.style.backgroundColor = bg;
      codeStatusEl.style.color = fg;
    }
    set("cp-spouseName", data.spouseName);
    set("cp-languages", data.languages);

    // 3. Contact Info
    set("cp-clientPhone", data.clientPhone);
    set("cp-email", data.email);
    set("cp-referredBy", data.referredBy);
    set(
      "cp-clientAddressFull",
      fmtAddr(
        data.clientAddress,
        data.clientApt,
        data.clientCity,
        data.clientState,
        data.clientZip
      )
    );
    set(
      "cp-billingAddressFull",
      fmtAddr(
        data.billingAddress,
        data.billingApt,
        data.billingCity,
        data.billingState,
        data.billingZip
      )
    );

    // 4. Key Contacts
    // Representative
    set("cp-repName", data.repName);
    set("cp-repRelationship", data.repRelationship);
    set("cp-repPhone", data.repPhone);

    // Emergency
    set("cp-emergencyName", data.emergencyName);
    set("cp-emergencyPhone", data.emergencyPhone);
    set("cp-emergencyRelationship", data.emergencyRelationship);
    set("cp-emergencyEmail", data.emergencyEmail);
    set(
      "cp-emergencyAddressFull",
      fmtAddr(
        data.emergencyAddress,
        data.emergencyApt,
        data.emergencyCity,
        data.emergencyState,
        data.emergencyZip
      )
    );

    // Authorization
    set("cp-authName", data.authName);
    set("cp-authPhone", data.authPhone);
    set("cp-authEmail", data.authEmail);
    set("cp-authRelationship", data.authRelationship);
    set(
      "cp-authAddressFull",
      fmtAddr(
        data.authAddress,
        data.authApt,
        data.authCity,
        data.authState,
        data.authZip
      )
    );

    // 5. Medical Status
    set("cp-height", data.height);
    set("cp-weight", data.weight);
    set("cp-mentalStatus", data.mentalStatus);
    set("cp-diagnosis", data.diagnosis);
    set(
      "cp-allergies",
      data.allergies +
        (data.allergiesDetail ? ` (${data.allergiesDetail})` : "")
    );
    set(
      "cp-covidVaccine",
      data.covidVaccine +
        (data.covidVaccineDetail ? ` (${data.covidVaccineDetail})` : "")
    );
    set(
      "cp-fluVaccine",
      data.fluVaccine +
        (data.fluVaccineDetail ? ` (${data.fluVaccineDetail})` : "")
    );

    // Aids
    let aids = [];
    if (data.blind === "Yes") aids.push("Blind");
    if (data.glasses === "Yes") aids.push("Glasses");
    if (data.dentures === "Yes") aids.push("Dentures");
    if (data.medicalAids) aids.push(data.medicalAids);
    set("cp-physicalAids", aids.join(", ") || "--");

    // Continence
    let cont = [];
    if (data.continentInfo) cont.push(`Continent: ${data.continentInfo}`);
    if (data.incontinentInfo) cont.push(`Incontinent: ${data.incontinentInfo}`);
    set("cp-continence", cont.join(" | ") || "--");

    set("cp-medicalHistory", data.medicalHistory);

    // Medications
    set("cp-medReminder", data.medReminder);
    set("cp-selfAdminMed", data.selfAdminMed);
    set("cp-takingMed", data.takingMed);
    set("cp-medOverseer", data.medOverseer);
    set("cp-medList", data.medList);
    set(
      "cp-assistDirections",
      data.assistDirections +
        (data.assistDirectionsDetail
          ? `\nDetails: ${data.assistDirectionsDetail}`
          : "")
    );

    // Healthcare Providers
    set("cp-primaryDrName", data.primaryDrName);
    set("cp-drOfficeName", data.drOfficeName);
    set("cp-drPhone", data.drPhone);
    set("cp-drAddress", data.drAddress);

    set("cp-hospitalName", data.hospitalName);
    set("cp-hospitalPhone", data.hospitalPhone);
    set("cp-hospitalAddress", data.hospitalAddress);

    set("cp-pharmacyName", data.pharmacyName);
    set("cp-pharmacyPhone", data.pharmacyPhone);
    set("cp-pharmacyAddress", data.pharmacyAddress);

    // 6. Care Needs
    set("cp-mobility", data.mobility);
    set("cp-dailyLivingSkills", data.dailyLivingSkills);
    set("cp-dietaryInfo", data.dietaryInfo);
    set("cp-careNeeds", data.careNeeds);
    set("cp-mealPreparation", data.mealPreparation);
    set("cp-lightHousekeeping", data.lightHousekeeping);
    set("cp-transportation", data.transportation);
    set("cp-goals", data.goals);

    // Caregiver Prefs
    set("cp-careGender", data.careGender);
    set("cp-careCertifications", data.careCertifications);
    set(
      "cp-careSmokePremises",
      data.careSmokePremises +
        (data.careSmokeNote ? ` (${data.careSmokeNote})` : "")
    );
    set(
      "cp-careLiveIn",
      data.careLiveIn +
        (data.careAccommodation ? ` - Accom: ${data.careAccommodation}` : "")
    );
    set("cp-careSkills", data.careSkills);

    // 8. Service Plan
    set("cp-levelOfCare", data.levelOfCare);
    set("cp-projectHours", data.projectHours);
    set("cp-hourlyRate", data.hourlyRate ? `$${data.hourlyRate}` : "");
    set("cp-weeklyCost", data.weeklyCost ? `$${data.weeklyCost}` : "");
    set("cp-overtime", data.overtime);
    set("cp-monthlyCost", data.monthlyCost ? `$${data.monthlyCost}` : "");
    set("cp-serviceTypes", data.serviceTypes);

    // 9. Schedule
    set("cp-schMO", data.schMO);
    set("cp-schT", data.schT);
    set("cp-schW", data.schW);
    set("cp-schTH", data.schTH);
    set("cp-schFR", data.schFR);
    set("cp-schSA", data.schSA);
    set("cp-schSU", data.schSU);

    // 10. Living Environment
    set("cp-smoke", data.smoke);
    set("cp-drink", data.drink);
    set("cp-pets", data.pets);
    set("cp-petsList", data.petsList);
    set("cp-petsNote", data.petsNote);
    set("cp-liveAlone", data.liveAlone);

    // Living details logic
    let livingDetails = [];
    if (data.liveFamily === "Yes")
      livingDetails.push(`Family: ${data.liveFamilyName}`);
    if (data.liveSenior === "Yes")
      livingDetails.push(
        `Senior Housing: ${data.liveSeniorName} - ${data.liveSeniorAddress}`
      );
    if (data.liveRehab === "Yes")
      livingDetails.push(
        `Rehab: ${data.liveRehabName} - ${data.liveRehabAddress}`
      );
    set("cp-liveDetails", livingDetails.join(" | "));

    // Payment & Insurance
    set("cp-paymentType", data.paymentType);
    set("cp-paymentOptions", data.paymentOptions);

    // Show/hide payment details based on payment option
    const bankDetails = document.getElementById("cp-paymentBankDetails");
    const digitalDetails = document.getElementById("cp-paymentDigitalDetails");
    const cardDetails = document.getElementById("cp-paymentCardDetails");
    const cashCheck = document.getElementById("cp-paymentCashCheck");
    const emptyPayment = document.getElementById("cp-paymentEmpty");

    // Hide all sections first
    if (bankDetails) bankDetails.classList.add("hidden");
    if (digitalDetails) digitalDetails.classList.add("hidden");
    if (cardDetails) cardDetails.classList.add("hidden");
    if (cashCheck) cashCheck.classList.add("hidden");
    if (emptyPayment) emptyPayment.classList.add("hidden");

    // Show relevant section based on payment option
    const payOpt = data.paymentOptions?.toLowerCase() || "";
    if (payOpt.includes("direct deposit") || payOpt.includes("bank deposit")) {
      if (bankDetails) bankDetails.classList.remove("hidden");
      set("cp-payBankName", data.payBankName);
      set("cp-payHolderName", data.payHolderName);
      set("cp-payAccountType", data.payAccountType);
      set("cp-payHolderType", data.payHolderType);
      set("cp-payBusinessName", data.payBusinessName);
      set(
        "cp-payAccountNum",
        data.payAccountNum ? `****${data.payAccountNum.slice(-4)}` : "****"
      );
      set(
        "cp-payRoutingNum",
        data.payRoutingNum ? `****${data.payRoutingNum.slice(-4)}` : "****"
      );

      // Show business name row if holder type is Business
      const businessRow = document.getElementById("cp-payBusinessNameRow");
      if (businessRow && data.payHolderType === "Business") {
        businessRow.classList.remove("hidden");
      } else if (businessRow) {
        businessRow.classList.add("hidden");
      }
    } else if (payOpt.includes("zelle") || payOpt.includes("apple pay")) {
      if (digitalDetails) digitalDetails.classList.remove("hidden");
      set("cp-payDigitalFullName", data.payDigitalFullName);
      set("cp-payDigitalType", data.payDigitalType);
      set("cp-payDigitalValue", data.payDigitalValue);
    } else if (
      payOpt.includes("credit") ||
      payOpt.includes("debit") ||
      payOpt.includes("card")
    ) {
      if (cardDetails) cardDetails.classList.remove("hidden");
      set("cp-payCardName", data.payCardName);
      set(
        "cp-payCardNumber",
        data.payCardNumber
          ? `**** **** **** ${data.payCardNumber.slice(-4)}`
          : "****"
      );
      set("cp-payCardExpiry", data.payCardExpiry);
    } else if (payOpt.includes("cash") || payOpt.includes("check")) {
      if (cashCheck) cashCheck.classList.remove("hidden");
      const cashCheckType = document.getElementById("cp-cashCheckType");
      if (cashCheckType) cashCheckType.textContent = data.paymentOptions;
    } else {
      if (emptyPayment) emptyPayment.classList.remove("hidden");
    }

    // Insurance Details
    set("cp-insuranceCompany", data.insuranceCompany);
    set(
      "cp-insuranceAddressFull",
      fmtAddr(
        data.insuranceAddress,
        data.insuranceApt,
        data.insuranceCity,
        data.insuranceState,
        data.insuranceZip
      )
    );
    set("cp-insurancePolicy", data.insurancePolicy);
    set("cp-insuranceMemberId", data.insuranceMemberId);
    set("cp-insuranceClaim", data.insuranceClaim);
    set("cp-insuranceCase", data.insuranceCase);
    set("cp-insuranceContactName", data.insuranceContactName);
    set("cp-insuranceContactPhone", data.insuranceContactPhone);
    set("cp-insuranceNote", data.insuranceAddNote);

    // Document Links
    const docLinks = [
      { id: "cp-agreementLink", url: data.agreementLink },
      { id: "cp-exhibitALink", url: data.exhibitALink },
      { id: "cp-exhibitBLink", url: data.exhibitBLink },
      { id: "cp-billOfRightsLink", url: data.billOfRightsLink },
      { id: "cp-hipaaLink", url: data.hipaaLink },
      { id: "cp-privacyLink", url: data.privacyLink },
    ];

    let hasDocuments = false;
    docLinks.forEach((doc) => {
      const linkEl = document.getElementById(doc.id);
      if (linkEl) {
        if (doc.url && doc.url.trim() !== "") {
          linkEl.href = doc.url;
          linkEl.classList.remove("hidden");
          hasDocuments = true;
        } else {
          linkEl.classList.add("hidden");
        }
      }
    });

    // Show/hide "no documents" message
    const noDocsEl = document.getElementById("cp-noDocuments");
    if (noDocsEl) {
      if (hasDocuments) {
        noDocsEl.classList.add("hidden");
      } else {
        noDocsEl.classList.remove("hidden");
      }
    }

    // 11. Footer / Metadata
    // Clean date formatting
    const fmtDate = (d) => {
      if (!d) return "--";
      const dt = new Date(d);
      return !isNaN(dt.getTime()) ? dt.toLocaleDateString() : d;
    };

    set("cp-createdAt", fmtDate(data.createdAt));
    set("cp-lastReviewed", fmtDate(data.lastReviewed));
    set("cp-coordinator", data.coordinator);

    document.getElementById("clProfileLoading").classList.add("hidden");
    document.getElementById("clProfileContent").classList.remove("hidden");
  }

  function editClientProfile() {
    if (!currentClientData) {
      console.warn("No client data found for editing.");
      return;
    }

    try {
      switchClView("edit");

      const d = currentClientData;
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val === undefined || val === null ? "" : val;
      };

      setVal("ce-id", d.id);

      // Dates helpers
      const setDate = (id, val) => {
        if (!val) {
          setVal(id, "");
          return;
        }
        const dt = new Date(val);
        if (isNaN(dt.getTime())) {
          setVal(id, val);
          return;
        } // fallback if not date string
        setVal(id, dt.toISOString().split("T")[0]);
      };
      const setDateTime = (id, val) => {
        if (!val) {
          setVal(id, "");
          return;
        }
        const dt = new Date(val);
        if (isNaN(dt.getTime())) {
          setVal(id, "");
          return;
        }
        // Create local ISO string manually to keep local time
        const pad = (n) => (n < 10 ? "0" + n : n);
        const localIso =
          dt.getFullYear() +
          "-" +
          pad(dt.getMonth() + 1) +
          "-" +
          pad(dt.getDate()) +
          "T" +
          pad(dt.getHours()) +
          ":" +
          pad(dt.getMinutes());
        setVal(id, localIso);
      };

      // 1. Admin
      setVal("ce-status", d.status);
      setVal("ce-coordinator", d.coordinator);
      setDate("ce-contactDate", d.contactDate);
      setDateTime("ce-assessmentDateTime", d.assessmentDateTime);

      // 2. Personal
      setVal("ce-firstName", d.firstName);
      setVal("ce-middleName", d.middleName);
      setVal("ce-lastName", d.lastName);
      setDate("ce-dob", d.dob);
      setVal("ce-gender", d.gender);
      setVal("ce-maritalStatus", d.maritalStatus);
      setVal("ce-spouseName", d.spouseName);
      setVal("ce-ssn", d.ssn);
      setVal("ce-height", d.height);
      setVal("ce-weight", d.weight);
      setVal("ce-codeStatus", d.codeStatus);
      setVal("ce-languages", d.languages);

      // 3. Contact
      setVal("ce-clientPhone", d.clientPhone);
      setVal("ce-email", d.email);
      setVal("ce-clientAddress", d.clientAddress);
      setVal("ce-clientApt", d.clientApt);
      setVal("ce-clientCity", d.clientCity);
      setVal("ce-clientState", d.clientState);
      setVal("ce-clientZip", d.clientZip);

      setVal("ce-billingAddress", d.billingAddress);
      setVal("ce-billingApt", d.billingApt);
      setVal("ce-billingCity", d.billingCity);
      setVal("ce-billingState", d.billingState);
      setVal("ce-billingZip", d.billingZip);

      // 4. Key Contacts
      setVal("ce-repName", d.repName);
      setVal("ce-repRelationship", d.repRelationship);
      setVal("ce-repPhone", d.repPhone);

      setVal("ce-emergencyName", d.emergencyName);
      setVal("ce-emergencyRelationship", d.emergencyRelationship);
      setVal("ce-emergencyPhone", d.emergencyPhone);
      setVal("ce-emergencyEmail", d.emergencyEmail);
      setVal("ce-emergencyAddress", d.emergencyAddress);

      setVal("ce-authName", d.authName);
      setVal("ce-authRelationship", d.authRelationship);
      setVal("ce-authPhone", d.authPhone);
      setVal("ce-authEmail", d.authEmail);
      setVal("ce-authAddress", d.authAddress);

      // 5. Medical
      setVal("ce-diagnosis", d.diagnosis);
      setVal("ce-allergies", d.allergies);
      setVal("ce-medicalHistory", d.medicalHistory);
      setVal("ce-medicalAids", d.medicalAids);

      setVal("ce-medList", d.medList);
      setVal("ce-assistDirections", d.assistDirections);
      setVal("ce-pharmacyName", d.pharmacyName);
      setVal("ce-pharmacyPhone", d.pharmacyPhone);
      setVal("ce-primaryDrName", d.primaryDrName);
      setVal("ce-drPhone", d.drPhone);

      // 6. Care Plan
      setVal("ce-levelOfCare", d.levelOfCare);
      setVal("ce-serviceTypes", d.serviceTypes);
      setVal("ce-careNeeds", d.careNeeds);

      setVal("ce-schMO", d.schMO);
      setVal("ce-schT", d.schT);
      setVal("ce-schW", d.schW);
      setVal("ce-schTH", d.schTH);
      setVal("ce-schFR", d.schFR);
      setVal("ce-schSA", d.schSA);
      setVal("ce-schSU", d.schSU);

      // 7. Financials
      setVal("ce-paymentOptions", d.paymentOptions);
      setVal("ce-hourlyRate", d.hourlyRate);
      setVal("ce-weeklyCost", d.weeklyCost);
      setVal("ce-monthlyCost", d.monthlyCost);

      setVal("ce-insuranceCompany", d.insuranceCompany);
      setVal("ce-insurancePolicy", d.insurancePolicy);
      setVal("ce-insuranceMemberId", d.insuranceMemberId);

      // 8. Documents
      setVal("ce-agreementLink", d.agreementLink);
      setVal("ce-exhibitALink", d.exhibitALink);
      setVal("ce-exhibitBLink", d.exhibitBLink);
      setVal("ce-billOfRightsLink", d.billOfRightsLink);
      setVal("ce-hipaaLink", d.hipaaLink);
      setVal("ce-privacyLink", d.privacyLink);
    } catch (e) {
      console.error("Error in editClientProfile:", e);
      Swal.fire("Error", "Failed to prepare edit form: " + e.message, "error");
    }
  }

  function submitEditClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("updateClientBtn");
    btn.disabled = true;
    btn.textContent = "Updating...";

    const form = document.getElementById("clientEditForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Update Client Information";
        if (res.success) {
          Swal.fire("Success", "Client Information Updated!", "success");
          // Reload profile with new data
          loadClientProfile(data.id);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClient(data);
  }

  // --- Archive Client Functions ---

  function openArchiveClientModal() {
    document.getElementById("archiveModal").classList.remove("hidden");
    document.getElementById("archiveReason").value = "";
    document.getElementById("archiveNote").value = "";
    toggleArchiveOtherInput();
  }

  function closeArchiveClientModal() {
    document.getElementById("archiveModal").classList.add("hidden");
  }

  function toggleArchiveOtherInput() {
    const reason = document.getElementById("archiveReason").value;
    const otherContainer = document.getElementById("archiveOtherContainer");
    if (reason === "Other") {
      otherContainer.classList.remove("hidden");
    } else {
      otherContainer.classList.add("hidden");
    }
  }

  function submitArchiveClient() {
    const reason = document.getElementById("archiveReason").value;
    const note = document.getElementById("archiveNote").value.trim();

    if (!reason) {
      Swal.fire("Error", "Please select a reason.", "error");
      return;
    }

    let finalReason = reason;
    if (reason === "Other") {
      if (!note) {
        Swal.fire(
          "Error",
          "Please provide a note for 'Other' reason.",
          "error"
        );
        return;
      }
      finalReason = `Other: ${note}`;
    } else if (note) {
      // Append note if provided for standard reasons too
      finalReason = `${reason} - ${note}`;
    }

    const clientId = document.getElementById("cp-id").textContent;
    if (!clientId || clientId === "--") {
      Swal.fire("Error", "No Client ID found.", "error");
      return;
    }

    const submitBtn = document.querySelector("#archiveModal button.bg-red-600");
    const originalText = submitBtn.innerText;
    submitBtn.disabled = true;
    submitBtn.innerText = "Archiving...";

    google.script.run
      .withSuccessHandler((res) => {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
        closeArchiveClientModal();
        if (res.success) {
          Swal.fire(
            "Success",
            "Client moved to archive successfully.",
            "success"
          ).then(() => {
            switchClView("list");
            loadClientList();
          });
        } else {
          Swal.fire(
            "Error",
            res.message || "Failed to archive client.",
            "error"
          );
        }
      })
      .withFailureHandler((err) => {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
        console.error(err);
        Swal.fire(
          "Error",
          "An unexpected error occurred: " + err.message,
          "error"
        );
      })
      .archiveClient(clientId, finalReason);
  }
</script>
