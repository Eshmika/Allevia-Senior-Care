<script>
  function switchClView(subView) {
    const list = document.getElementById("cl-subview-list");
    const add = document.getElementById("cl-subview-add");
    const profile = document.getElementById("cl-subview-profile");
    const edit = document.getElementById("cl-subview-edit");

    if (list) list.classList.add("hidden");
    if (add) add.classList.add("hidden");
    if (profile) profile.classList.add("hidden");
    if (edit) edit.classList.add("hidden");

    const target = document.getElementById("cl-subview-" + subView);
    if (target) target.classList.remove("hidden");

    // Set today's date when switching to add view
    if (subView === "add" && typeof setTodayDate === "function") {
      setTodayDate();
    }
  }

  // Format phone number as (XXX) XXX-XXXX
  function formatPhone(input) {
    // Save selection start to restore cursor position
    const selectionStart = input.selectionStart;
    const oldLength = input.value.length;

    let value = input.value.replace(/\D/g, ""); // Remove non-digits

    if (value.length > 10) {
      value = value.substring(0, 10); // Limit to 10 digits
    }

    let formattedValue = "";
    if (value.length > 0) {
      formattedValue = "(" + value.substring(0, 3);
      if (value.length > 3) {
        formattedValue += ") " + value.substring(3, 6);
      }
      if (value.length > 6) {
        formattedValue += "-" + value.substring(6, 10);
      }
    }

    input.value = formattedValue;

    // Restore cursor position logically
    const newLength = formattedValue.length;
    let newCursorPos = selectionStart + (newLength - oldLength);

    // Ensure cursor doesn't jump weirdly after formatting
    if (newCursorPos < 0) newCursorPos = 0;
    input.setSelectionRange(newCursorPos, newCursorPos);
  }

  function loadClientList() {
    const tbody = document.getElementById("clTableBody");
    if (tbody)
      tbody.innerHTML =
        '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        clData = data;
        renderClTable();
      })
      .getClientList();
  }

  function renderClTable() {
    const searchEl = document.getElementById("clSearch");
    const statusEl = document.getElementById("clFilterStatus");
    const typeEl = document.getElementById("clFilterType");

    if (!searchEl) return;

    const search = searchEl.value.toLowerCase();
    const statusFilter = statusEl.value;
    const typeFilter = typeEl.value;

    const filtered = clData.filter((item) => {
      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search);
      const matchStatus =
        statusFilter === "All" || item.status === statusFilter;
      const matchType = typeFilter === "All" || item.type === typeFilter;
      return matchSearch && matchStatus && matchType;
    });

    const totalPages = Math.ceil(filtered.length / clRowsPerPage);
    if (clCurrentPage > totalPages) clCurrentPage = 1;

    const start = (clCurrentPage - 1) * clRowsPerPage;
    const end = start + clRowsPerPage;
    const pageData = filtered.slice(start, end);

    const tbody = document.getElementById("clTableBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No clients found.</td></tr>';
    } else {
      pageData.forEach((row) => {
        let statusColor = "bg-gray-100 text-gray-600";
        if (row.status === "Active")
          statusColor = "bg-green-100 text-green-700";
        if (row.status === "Inactive") statusColor = "bg-red-100 text-red-700";
        if (row.status === "Cancelled service")
          statusColor = "bg-gray-200 text-gray-800";
        if (row.status === "Temporary hospital stay")
          statusColor = "bg-orange-100 text-orange-800";

        tbody.innerHTML += `
        <tr class="hover:bg-gray-50 border-b border-gray-50">
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4 text-sm text-gray-600">${row.type}</td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip || ""}</p>
            </div>
          </td>
          <td class="p-4 text-xs text-gray-500">${row.lastReviewed || "--"}</td>
          <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${
          row.status
        }</span></td>
          <td class="p-4 text-right">
             <button onclick="loadClientProfile('${
               row.id
             }')" class="text-xs bg-gray-50 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-100 font-bold border border-gray-200 transition-colors">Details</button>
          </td>
        </tr>
      `;
      });
    }

    const infoEl = document.getElementById("clPageInfo");
    if (infoEl) {
      infoEl.textContent = `Showing ${
        pageData.length > 0 ? start + 1 : 0
      }-${Math.min(end, filtered.length)} of ${filtered.length}`;
    }
    const btnPrev = document.getElementById("clBtnPrev");
    const btnNext = document.getElementById("clBtnNext");
    if (btnPrev) btnPrev.disabled = clCurrentPage === 1;
    if (btnNext)
      btnNext.disabled = clCurrentPage >= totalPages || totalPages === 0;
  }

  function changeClPage(dir) {
    clCurrentPage += dir;
    renderClTable();
  }

  function submitClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveClientBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("clientForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Save Client Information";
        if (res.success) {
          Swal.fire("Success", "Client Information Saved!", "success");
          form.reset();
          // Reset today's date after form reset
          setTodayDate();
          switchClView("list");
          loadClientList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleClientSubmission(data);
  }

  // Function to set today's date
  function setTodayDate() {
    const dateInput = document.getElementById("contactDate");
    if (dateInput) {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${year}-${month}-${day}`;
    }
  }

  // Initialize date when page loads or when switching to add view
  document.addEventListener("DOMContentLoaded", setTodayDate);

  function loadClientProfile(id) {
    switchClView("profile");
    document.getElementById("clProfileLoading").classList.remove("hidden");
    document.getElementById("clProfileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        currentClientData = data;
        renderClientProfile(data);
      })
      .getClientDetails(id);
  }

  function renderClientProfile(data) {
    if (!data) return;

    // Helper to set text content safely
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = val || "--";
    };

    // Set initials from client name
    const clientName = data.clientName || "";
    const nameParts = clientName.split(" ");
    const initials =
      nameParts.length > 1
        ? nameParts[0][0] + nameParts[nameParts.length - 1][0]
        : clientName[0] || "?";

    set("cp-initials", initials);
    set("cp-name", data.clientName);
    set("cp-id", data.id);
    set("cp-status", data.status);
    set("cp-email", "--");
    set("cp-phone", data.clientPhone);

    // Format full address
    const addressParts = [
      data.clientAddress,
      data.clientApt ? `Apt ${data.clientApt}` : "",
      data.clientCity,
      data.clientState,
      data.clientZip,
    ]
      .filter((part) => part)
      .join(", ");
    set("cp-address", addressParts || "--");

    // Format Contact Date
    let contactDate = data.contactDate;
    if (contactDate) {
      const d = new Date(contactDate);
      if (!isNaN(d.getTime())) {
        contactDate = d.toLocaleDateString();
      }
    }
    set("cp-dob", `Contact Date: ${contactDate || "--"}`);

    // Format Assessment Date/Time
    let assessmentDateTime = data.assessmentDateTime;
    if (assessmentDateTime) {
      const d = new Date(assessmentDateTime);
      if (!isNaN(d.getTime())) {
        assessmentDateTime = d.toLocaleString();
      }
    }

    set("cp-gender", `Assessment: ${assessmentDateTime || "--"}`);
    set("cp-type", "Lead");
    set("cp-living", `Coordinator: ${data.coordinator || "--"}`);
    set("cp-languages", `Care Needs: ${data.careNeeds || "--"}`);

    // Representative information in emergency contact section
    set("cp-emName", data.repName);
    set("cp-emRel", data.repRelationship);
    set("cp-emPhone", data.repPhone);
    set("cp-emEmail", `Referred by: ${data.referredBy || "--"}`);
    set("cp-emAddress", "--");

    document.getElementById("clProfileLoading").classList.add("hidden");
    document.getElementById("clProfileContent").classList.remove("hidden");
  }

  function editClientProfile() {
    if (!currentClientData) return;
    switchClView("edit");

    const d = currentClientData;
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val || "";
    };

    setVal("ce-id", d.id);

    // Format Contact Date for input[type="date"]
    let contactDate = "";
    if (d.contactDate) {
      const dateObj = new Date(d.contactDate);
      if (!isNaN(dateObj.getTime())) {
        contactDate = dateObj.toISOString().split("T")[0];
      }
    }
    setVal("ce-contactDate", contactDate);

    // Format Assessment DateTime for input[type="datetime-local"]
    let assessmentDateTime = "";
    if (d.assessmentDateTime) {
      const dateObj = new Date(d.assessmentDateTime);
      if (!isNaN(dateObj.getTime())) {
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        assessmentDateTime = dateObj.toISOString().slice(0, 16);
      }
    }
    setVal("ce-assessmentDateTime", assessmentDateTime);

    setVal("ce-coordinator", d.coordinator);
    setVal("ce-repName", d.repName);
    setVal("ce-repPhone", d.repPhone);
    setVal("ce-repRelationship", d.repRelationship);
    setVal("ce-clientName", d.clientName);
    setVal("ce-clientPhone", d.clientPhone);
    setVal("ce-status", d.status);
    setVal("ce-clientAddress", d.clientAddress);
    setVal("ce-clientApt", d.clientApt);
    setVal("ce-clientCity", d.clientCity);
    setVal("ce-clientState", d.clientState);
    setVal("ce-clientZip", d.clientZip);
    setVal("ce-careNeeds", d.careNeeds);
    setVal("ce-referredBy", d.referredBy);
  }

  function submitEditClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("updateClientBtn");
    btn.disabled = true;
    btn.textContent = "Updating...";

    const form = document.getElementById("clientEditForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Update Client Information";
        if (res.success) {
          Swal.fire("Success", "Client Information Updated!", "success");
          // Reload profile with new data
          loadClientProfile(data.id);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClient(data);
  }
</script>
