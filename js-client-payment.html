<script>
  // Format phone number as (XXX) XXX-XXXX
  function formatPhone(input) {
    const selectionStart = input.selectionStart;
    const oldLength = input.value.length;
    let value = input.value.replace(/\D/g, "");

    if (value.length > 10) {
      value = value.substring(0, 10);
    }

    let formattedValue = "";
    if (value.length > 0) {
      formattedValue = "(" + value.substring(0, 3);
      if (value.length > 3) {
        formattedValue += ") " + value.substring(3, 6);
      }
      if (value.length > 6) {
        formattedValue += "-" + value.substring(6, 10);
      }
    }

    input.value = formattedValue;
    const newLength = formattedValue.length;
    let newCursorPos = selectionStart + (newLength - oldLength);
    if (newCursorPos < 0) newCursorPos = 0;
    input.setSelectionRange(newCursorPos, newCursorPos);
  }
  function toggleBusinessName() {
    const holderType = document.getElementById("pay-holderType").value;
    const businessNameContainer = document.getElementById(
      "pay-businessNameContainer"
    );
    if (holderType === "Business") {
      businessNameContainer.classList.remove("hidden");
    } else {
      businessNameContainer.classList.add("hidden");
    }
  }

  function toggleOtherPaymentField() {
    const typeSelect = document.getElementById("pay-paymentType");
    const otherContainer = document.getElementById(
      "pay-paymentTypeOtherContainer"
    );
    const otherInput = document.getElementById("pay-paymentTypeOther");

    if (typeSelect.value === "Other") {
      otherContainer.classList.remove("hidden");
      otherInput.setAttribute("required", "true");
    } else {
      otherContainer.classList.add("hidden");
      otherInput.removeAttribute("required");
    }
  }

  function togglePaymentDetailFields() {
    const checks = document.getElementsByName("payOption");
    const options = Array.from(checks)
      .filter((cb) => cb.checked)
      .map((cb) => cb.value.toLowerCase());

    const bankSection = document.getElementById("pay-bankDetails");
    const digitalSection = document.getElementById("pay-digitalDetails");
    const cardSection = document.getElementById("pay-cardDetails");
    const checkSection = document.getElementById("pay-checkDetails");

    const hasBank =
      options.includes("direct deposit") || options.includes("bank deposit");
    const hasDigital =
      options.includes("zelle") || options.includes("apple pay");
    const hasCard = options.includes("credit/debit card");
    const hasCheck = options.includes("check");

    bankSection.classList.toggle("hidden", !hasBank);
    digitalSection.classList.toggle("hidden", !hasDigital);
    cardSection.classList.toggle("hidden", !hasCard);
    checkSection.classList.toggle("hidden", !hasCheck);
  }

  function togglePayDigitalInputs() {
    const digitalType =
      document.querySelector('input[name="payDigitalType"]:checked')?.value ||
      "phone";
    const label = document.getElementById("pay-digitalValueLabel");
    label.textContent =
      digitalType === "phone" ? "Phone Number" : "Email Address";
  }

  function openPaymentForm(clientId) {
    toggleClientStageView("payment-form");
    document.getElementById("paymentDetailsForm").reset();
    document.getElementById("pay-id").value = clientId;

    google.script.run
      .withSuccessHandler((data) => {
        if (!data) return;

        // Select payment type
        const typeSelect = document.getElementById("pay-paymentType");
        const otherContainer = document.getElementById(
          "pay-paymentTypeOtherContainer"
        );
        const otherInput = document.getElementById("pay-paymentTypeOther");
        const standardOptions = [
          "Private pay",
          "Lead Insurance",
          "Medicaid",
          "VA",
        ];

        if (data.paymentType) {
          if (standardOptions.includes(data.paymentType)) {
            typeSelect.value = data.paymentType;
            otherContainer.classList.add("hidden");
            otherInput.value = "";
          } else {
            typeSelect.value = "Other";
            otherContainer.classList.remove("hidden");
            otherInput.value =
              data.paymentType === "Other" ? "" : data.paymentType;
          }
        }

        // Check payment options
        const selectedOption = (data.paymentOptions || "").trim().toLowerCase();
        const radios = document.getElementsByName("payOption");
        radios.forEach((rb) => {
          rb.checked = rb.value.toLowerCase() === selectedOption;
        });

        // Fill Bank Details
        document.getElementById("pay-bankName").value = data.payBankName || "";
        document.getElementById("pay-holderName").value =
          data.payHolderName || "";
        document.getElementById("pay-accountType").value =
          data.payAccountType || "Checking";
        document.getElementById("pay-holderType").value =
          data.payHolderType || "Personal";
        document.getElementById("pay-businessName").value =
          data.payBusinessName || "";
        document.getElementById("pay-accountNum").value =
          data.payAccountNum || "";
        document.getElementById("pay-routingNum").value =
          data.payRoutingNum || "";

        // Fill Digital Details
        document.getElementById("pay-digitalFullName").value =
          data.payDigitalFullName || "";
        if (data.payDigitalType) {
          const typeRadios = document.getElementsByName("payDigitalType");
          typeRadios.forEach((radio) => {
            radio.checked = radio.value === data.payDigitalType;
          });
        }
        document.getElementById("pay-digitalValue").value =
          data.payDigitalValue || "";

        // Fill Card Details
        document.getElementById("pay-cardName").value = data.payCardName || "";
        document.getElementById("pay-cardNumber").value =
          data.payCardNumber || "";
        document.getElementById("pay-cardExpiry").value =
          data.payCardExpiry || "";
        document.getElementById("pay-cardCVV").value = data.payCardCVV || "";

        // Fill Insurance Details
        document.getElementById("pay-insuranceFirstName").value =
          data.firstName || "";
        document.getElementById("pay-insuranceMiddleName").value =
          data.middleName || "";
        document.getElementById("pay-insuranceLastName").value =
          data.lastName || "";
        document.getElementById("pay-insuranceDOB").value = data.dob || "";

        document.getElementById("pay-insuranceCompany").value =
          data.insuranceCompany || "";
        document.getElementById("pay-insuranceAddress").value =
          data.insuranceAddress || "";
        document.getElementById("pay-insuranceApt").value =
          data.insuranceApt || "";
        document.getElementById("pay-insuranceCity").value =
          data.insuranceCity || "";
        document.getElementById("pay-insuranceState").value =
          data.insuranceState || "";
        document.getElementById("pay-insuranceZip").value =
          data.insuranceZip || "";
        document.getElementById("pay-insurancePolicy").value =
          data.insurancePolicy || "";
        document.getElementById("pay-insuranceMemberId").value =
          data.insuranceMemberId || "";
        document.getElementById("pay-insuranceContactName").value =
          data.insuranceContactName || "";
        document.getElementById("pay-insuranceContactPhone").value =
          data.insuranceContactPhone || "";
        document.getElementById("pay-insuranceCase").value =
          data.insuranceCase || "";
        document.getElementById("pay-insuranceClaim").value =
          data.insuranceClaim || "";
        document.getElementById("pay-insuranceAddNote").value =
          data.insuranceAddNote || "";

        toggleBusinessName();
        togglePaymentDetailFields();
      })
      .getClientDetails(clientId);
  }

  function submitPaymentForm(e) {
    e.preventDefault();
    const btn = document.getElementById("savePaymentBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";

    const form = document.getElementById("paymentDetailsForm");
    const formData = new FormData(form);

    let paymentType = formData.get("paymentType");
    if (paymentType === "Other") {
      const otherVal = document.getElementById("pay-paymentTypeOther").value;
      if (otherVal && otherVal.trim() !== "") {
        paymentType = otherVal.trim();
      }
    }

    const selectedRadio = Array.from(
      document.getElementsByName("payOption")
    ).find((rb) => rb.checked);
    const paymentOptions = selectedRadio ? selectedRadio.value : "";

    const clientId = document.getElementById("pay-id").value;

    // Validation for Bank Details
    const selectedOption = paymentOptions.toLowerCase();

    if (
      selectedOption === "direct deposit" ||
      selectedOption === "bank deposit"
    ) {
      const acc = document.getElementById("pay-accountNum").value;
      const accConf = document.getElementById("pay-accountNumConfirm").value;
      const rout = document.getElementById("pay-routingNum").value;
      const routConf = document.getElementById("pay-routingNumConfirm").value;

      if (acc !== accConf) {
        Swal.fire("Error", "Account Numbers do not match.", "error");
        btn.disabled = false;
        btn.textContent = "Save Payment Details";
        return;
      }
      if (rout !== routConf) {
        Swal.fire("Error", "Routing Numbers do not match.", "error");
        btn.disabled = false;
        btn.textContent = "Save Payment Details";
        return;
      }
    }

    const insurancePhone = formData.get("insuranceContactPhone");
    if (insurancePhone && insurancePhone.replace(/\D/g, "").length !== 10) {
      Swal.fire("Error", "Insurance Contact Phone must be 10 digits.", "error");
      btn.disabled = false;
      btn.textContent = "Save Payment Details";
      return;
    }

    const data = {
      id: clientId,
      paymentType: paymentType,
      paymentOptions: paymentOptions,
      payBankName: formData.get("payBankName"),
      payHolderName: formData.get("payHolderName"),
      payAccountType: formData.get("payAccountType"),
      payHolderType: formData.get("payHolderType"),
      payBusinessName: formData.get("payBusinessName"),
      payAccountNum: formData.get("payAccountNum"),
      payRoutingNum: formData.get("payRoutingNum"),
      payDigitalFullName: formData.get("payDigitalFullName"),
      payDigitalType: formData.get("payDigitalType"),
      payDigitalValue: formData.get("payDigitalValue"),
      payCardName: formData.get("payCardName"),
      payCardNumber: formData.get("payCardNumber"),
      payCardExpiry: formData.get("payCardExpiry"),
      payCardCVV: formData.get("payCardCVV"),
      insuranceCompany: formData.get("insuranceCompany"),
      insuranceAddress: formData.get("insuranceAddress"),
      insuranceApt: formData.get("insuranceApt"),
      insuranceCity: formData.get("insuranceCity"),
      insuranceState: formData.get("insuranceState"),
      insuranceZip: formData.get("insuranceZip"),
      insurancePolicy: formData.get("insurancePolicy"),
      insuranceMemberId: formData.get("insuranceMemberId"),
      insuranceContactName: formData.get("insuranceContactName"),
      insuranceContactPhone: formData.get("insuranceContactPhone"),
      insuranceCase: formData.get("insuranceCase"),
      insuranceClaim: formData.get("insuranceClaim"),
      insuranceAddNote: formData.get("insuranceAddNote"),
    };

    google.script.run
      .withSuccessHandler((existing) => {
        const merged = { ...existing, ...data };
        google.script.run
          .withSuccessHandler((res) => {
            btn.disabled = false;
            btn.textContent = "Save Payment Details";
            if (res.success) {
              Swal.fire("Success", "Payment details saved!", "success");
              toggleClientStageView("stages");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClient(merged);
      })
      .getClientDetails(clientId);
  }
</script>
