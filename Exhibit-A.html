<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>Exhibit A - Cost of Services</title>
    <style>
      body { font-family: "Inter", sans-serif; }

      /* Tailwind Polyfill for PDF Generation */
      .text-center { text-align: center; }
      .text-justify { text-align: justify; }
      .font-bold { font-weight: 700; }
      .font-semibold { font-weight: 600; }
      .text-2xl { font-size: 1.5rem; line-height: 2rem; }
      .underline { text-decoration: underline; }
      .italic { font-style: italic; }
      .mb-6 { margin-bottom: 1.5rem; }
      .mb-4 { margin-bottom: 1rem; }
      .mt-2 { margin-top: 0.5rem; }
      .mt-4 { margin-top: 1rem; }
      .p-8 { padding: 2rem; }
      .px-8 { padding-left: 2rem; padding-right: 2rem; }
      .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
      .w-full { width: 100%; }
      .border { border-width: 1px; border-style: solid; }
      .border-gray-300 { border-color: #d1d5db; }
      .rounded-md { border-radius: 0.375rem; }
      .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
      .p-2 { padding: 0.5rem; }
      .block { display: block; }
      .flex { display: flex; }
      .gap-3 { gap: 0.75rem; }
      .items-start { align-items: flex-start; }
      .text-red-500 { color: #ef4444; }

      /* Custom styles for Exhibit A Elements */
      table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
      td { border: 1px solid #d1d5db; padding: 0.75rem; vertical-align: top; }
      .field { border-bottom: 1px solid #000; min-height: 1.5em; margin-top: 5px; }
      .checkbox { display: inline-block; width: 1rem; height: 1rem; border: 1px solid #000; margin-right: 0.25rem; vertical-align: middle; }

      /* PDF Specific Overrides */
      <? if (isPdf) { ?>
        body { background-color: white !important; padding: 0 !important; }
        .shadow-lg { box-shadow: none !important; }
        .rounded-xl { border-radius: 0 !important; }
        .no-pdf { display: none !important; }
        .container-box { border: none !important; max-width: 100% !important; box-shadow: none !important; }
      <? } ?>
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen py-10 px-4">
    <div
      class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden container-box"
    >
      <div class="px-8 py-6">
        <h1 class="text-2xl font-bold text-center">
          EXHIBIT A - COST OF SERVICES
        </h1>
      </div>

      <div class="p-8">
        <p class="text-justify mb-6">
          <b>THIS</b> Exhibit A - Cost of Services, shall be incorporated into
          and considered part of the Client Services Agreement
          ("<b>Agreement</b>") by and between Allevia Senior Care and the CLIENT
          and/or Financially Responsible Party by this reference.
        </p>

        <h3 class="font-semibold underline mt-6 mb-4">
          Projected Service Hours and Costs
        </h3>

        <div
          class="border border-gray-300 rounded-lg overflow-hidden mb-8 shadow-sm"
        >
          <table class="w-full m-0" style="margin-bottom: 0">
            <!-- Row 1: Key Metrics -->
            <tr class="bg-gray-50">
              <td
                class="w-1/4 p-3 border-r border-b border-gray-300 align-middle text-center"
              >
                <span
                  class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1"
                  >Hours / Week</span
                >
                <div class="text-lg font-bold text-gray-900">
                  <?= clientData.projectHours || '-' ?>
                </div>
              </td>
              <td
                class="w-1/4 p-3 border-r border-b border-gray-300 align-middle text-center"
              >
                <span
                  class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1"
                  >Level of Care</span
                >
                <div class="text-lg font-bold text-gray-900">
                  <?= clientData.levelOfCare || '-' ?>
                </div>
              </td>
              <td
                class="w-1/4 p-3 border-r border-b border-gray-300 align-middle text-center"
              >
                <span
                  class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1"
                  >Rate / Hour</span
                >
                <div class="text-lg font-bold text-gray-900">
                  <?= clientData.hourlyRate || '-' ?>
                </div>
              </td>
              <td
                class="w-1/4 p-3 border-b border-gray-300 align-middle text-center relative"
              >
                <span
                  class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1"
                  >Overtime</span
                >
                <div class="flex justify-center items-center gap-3 mt-1">
                  <div class="flex items-center">
                    <span
                      class="w-4 h-4 border border-gray-600 flex items-center justify-center mr-1 bg-white text-xs"
                    >
                      <?= (clientData.overtime === 'Yes' || clientData.overtime === 'on' ? '✓' : '') ?>
                    </span>
                    <span class="text-xs font-bold">YES</span>
                  </div>
                  <div class="flex items-center">
                    <span
                      class="w-4 h-4 border border-gray-600 flex items-center justify-center mr-1 bg-white text-xs"
                    >
                      <?= (clientData.overtime === 'No' ? '✓' : '') ?>
                    </span>
                    <span class="text-xs font-bold">NO</span>
                  </div>
                </div>
              </td>
            </tr>

            <!-- Row 2: Costs -->
            <tr>
              <td
                colspan="2"
                class="p-3 border-r border-gray-300 align-middle text-center bg-white"
              >
                <span
                  class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1"
                  >Projected Weekly Cost</span
                >
                <div class="text-xl font-bold text-green-700">
                  <?= clientData.weeklyCost || '-' ?>
                </div>
              </td>
              <td colspan="2" class="p-3 align-middle text-center bg-white">
                <span
                  class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1"
                  >Projected Monthly Cost</span
                >
                <div class="text-xl font-bold text-green-700">
                  <?= clientData.monthlyCost || '-' ?>
                </div>
              </td>
            </tr>

            <!-- Row 3: Billing Address -->
            <tr>
              <td colspan="4" class="p-4 bg-gray-100 border-t border-gray-300">
                <div class="flex items-start">
                  <span
                    class="text-xs font-bold text-gray-500 uppercase tracking-wider mr-2 mt-1 shrink-0"
                    >Billing Address:</span
                  >
                  <div class="text-base font-medium text-gray-800 break-words">
                    <?= [clientData.billingAddress, clientData.billingApt, clientData.billingCity, clientData.billingState, clientData.billingZip].filter(Boolean).join(', ') || 'Not provided' ?>
                  </div>
                </div>
              </td>
            </tr>
          </table>
        </div>

        <h3 class="font-semibold underline mt-6 mb-4">Initial Deposit</h3>
        <div class="flex gap-4 mb-4">
          <div style="flex: 1">
            <span>Initial Deposit Amount:</span>
            <div class="field"></div>
          </div>
          <div style="flex: 1">
            <span>Date:</span>
            <div class="field"></div>
          </div>
        </div>

        <h3 class="font-semibold underline mt-6 mb-4">Payment Method:</h3>

        <!-- Visa -->
        <div class="mb-4">
          <div class="flex items-center mb-2">
            <span class="checkbox"></span>
            <span class="ml-2 font-semibold">VISA #:</span>
          </div>
          <div class="field w-full"></div>
        </div>

        <div class="mb-4">
          <span>Name as it Appears on Credit Card:</span>
          <div class="field w-full"></div>
        </div>

        <!-- Mastercard -->
        <div class="mb-4 flex gap-4">
          <div style="flex: 1">
            <div class="flex items-center mb-2">
              <span class="checkbox"></span>
              <span class="ml-2 font-semibold">MasterCard #:</span>
            </div>
            <div class="field w-full"></div>
          </div>
          <div style="flex: 1">
            <div class="mb-2">Credit Card Exp. Date:</div>
            <div class="field w-full"></div>
          </div>
        </div>

        <!-- Check -->
        <div class="mb-6">
          <span>Check #:</span>
          <div class="field w-full"></div>
        </div>

        <!-- Insurance -->
        <div class="mt-6 border-t pt-4">
          <div class="flex items-center mb-4">
            <span class="checkbox"></span>
            <span class="ml-2 font-semibold">Insurance Payment</span>
          </div>

          <div style="padding-left: 1.5rem" class="space-y-4">
            <div class="flex gap-4">
              <div style="flex: 1">
                <span>Insurance Company Name:</span>
                <div class="field"></div>
              </div>
              <div style="flex: 1">
                <span>Policy Number:</span>
                <div class="field"></div>
              </div>
            </div>

            <div>
              <span>Insurance Company Address:</span>
              <div class="field"></div>
            </div>

            <div class="flex gap-4">
              <div style="flex: 1">
                <span>Contact Name:</span>
                <div class="field"></div>
              </div>
              <div style="flex: 1">
                <span>Contact Phone #:</span>
                <div class="field"></div>
              </div>
            </div>
          </div>
        </div>

        <p class="mt-8 italic">
          Executed and applicable as of the Effective Date of the Agreement.
        </p>

        <!-- Signing Form Section (Same as Agreement) -->
        <form id="clientAgreementForm" class="space-y-6 mt-8 border-t pt-6">
          <div class="space-y-2 mt-2 pt-4">
            <? if (isPdf) { ?>
            <div class="flex gap-3 items-start">
              <span style="font-size: 18px; line-height: 1">☑</span>
              <span class="italic"
                >By electronically typing or signing my name below, I
                acknowledge and agree that this electronic representation of my
                name constitutes my legal signature. This electronic signature
                has the same validity, force, and effect as a handwritten
                signature under applicable state and federal law, including the
                ESIGN Act and the Uniform Electronic Transactions Act.</span
              >
            </div>
            <? } else { ?>
            <label class="flex gap-3 items-start cursor-pointer">
              <input
                type="checkbox"
                name="agreeEsign"
                required
                class="mt-0.5 accent-[#65c027] w-4 h-4 shrink-0"
              />
              <span class="italic"
                >By electronically typing or signing my name below, I
                acknowledge and agree that this electronic representation of my
                name constitutes my legal signature. This electronic signature
                has the same validity, force, and effect as a handwritten
                signature under applicable state and federal law, including the
                ESIGN Act and the Uniform Electronic Transactions Act.</span
              >
            </label>
            <? } ?>
          </div>

          <div>
            <input type="hidden" name="clientId" value="<?= clientId ?>" />
            <label class="input-label font-semibold block mb-1"
              >Full Name <span class="text-red-500 no-pdf">*</span></label
            >
            <? if (isPdf) { ?>
            <div class="w-full border-b border-gray-400 py-2 mb-4">
              <?= [clientData.firstName, clientData.middleName, clientData.lastName].filter(Boolean).join(' ') ?>
            </div>
            <? } else { ?>
            <input
              type="text"
              name="fullName"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border mb-4"
              placeholder="Given Name"
              value="<?= [clientData.firstName, clientData.middleName, clientData.lastName].filter(Boolean).join(' ') ?>"
              readonly
              required
            />
            <? } ?>

            <label class="input-label font-semibold block mb-1"
              >Digital Signature (Type Full Name)<span
                class="text-red-500 no-pdf"
                >*</span
              ></label
            >
            <? if (isPdf) { ?>
            <div
              class="w-full border-b border-gray-400 py-2 mb-4"
              style="font-family: 'Courier New', Courier, monospace"
            >
              <?= clientData.Signature || '' ?>
            </div>
            <? } else { ?>
            <input
              type="text"
              name="signature"
              required
              placeholder="Type your full name"
              value="<?= clientData.Signature || '' ?>"
              class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
            />
            <? } ?>

            <label class="input-label mt-4 block font-semibold mb-1"
              >Date & Time <span class="text-red-500 no-pdf">*</span></label
            >
            <? if (isPdf) { ?>
            <div class="w-full border-b border-gray-400 py-2 mb-1">
              <?= clientData.SignDate || '' ?>
            </div>
            <? } else { ?>
            <div class="mb-4">
              <input
                type="datetime-local"
                name="signDateLocal"
                required
                class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 p-2 border"
              />
              <input type="hidden" name="signDate" />
            </div>
            <? } ?>
          </div>

          <!-- Allevia Senior Care Signature -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="mb-4">
              <p class="font-semibold text-lg">
                ALLEVIA SENIOR CARE (Allevia llc)
              </p>
            </div>
            <div>
              <label class="input-label block font-semibold mb-2"
                >SIGNATURE:</label
              >
              <? if (isPdf) { ?>
              <div
                style="
                  width: 150px;
                  height: 60px;
                  border-bottom: 1px solid #000;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <img
                  src="https://lh3.googleusercontent.com/d/11Oxbip4bK0lI_uZMtuKj3_pa7f3YZknW"
                  alt="Allevia Senior Care Signature"
                  style="
                    max-width: 150px;
                    max-height: 60px;
                    width: auto;
                    height: auto;
                  "
                />
              </div>
              <? } else { ?>
              <div style="width: 150px">
                <img
                  src="https://drive.google.com/uc?export=download&id=11Oxbip4bK0lI_uZMtuKj3_pa7f3YZknW"
                  alt="Allevia Senior Care Signature"
                  class="w-full h-auto"
                  onerror="this.src='https://lh3.googleusercontent.com/d/11Oxbip4bK0lI_uZMtuKj3_pa7f3YZknW'"
                />
              </div>
              <? } ?>
            </div>
          </div>

          <div class="pt-4 no-pdf">
            <button
              type="submit"
              class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              Sign Agreement
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Set default local date-time to now (for user convenience)
      (function setDefaultDateTimeLocal() {
        const dtInput = document.querySelector('input[name="signDateLocal"]');
        if (dtInput && !dtInput.value) {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          const y = d.getFullYear();
          const m = pad(d.getMonth() + 1);
          const day = pad(d.getDate());
          const hh = pad(d.getHours());
          const mm = pad(d.getMinutes());
          dtInput.value = `${y}-${m}-${day}T${hh}:${mm}`;
        }
      })();

      document
        .getElementById("clientAgreementForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const fullNameLower = document
            .querySelector('input[name="fullName"]')
            .value.trim()
            .replace(/\s+/g, " ")
            .toLowerCase();
          const signatureInput = document.querySelector(
            'input[name="signature"]'
          );
          const signatureRaw = signatureInput.value.trim().replace(/\s+/g, " "); // Keep original case
          const signatureLower = signatureRaw.toLowerCase();

          if (fullNameLower !== signatureLower) {
            alert("Digital Signature must match the Full Name exactly.");
            return;
          }

          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerText;
          btn.innerText = "Signing & Uploading...";
          btn.disabled = true;

          // Build Sign Date string in Eastern Time (New York) for storage/display
          const dtLocalInput = document.querySelector(
            'input[name="signDateLocal"]'
          );
          let signDateEt = "";
          if (dtLocalInput && dtLocalInput.value) {
            const localDate = new Date(dtLocalInput.value);
            const parts = new Intl.DateTimeFormat("en-US", {
              timeZone: "America/New_York",
              weekday: "long",
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            }).formatToParts(localDate);
            const get = (t) => parts.find((p) => p.type === t)?.value || "";
            const weekday = get("weekday");
            const month = get("month");
            const day = get("day");
            const year = get("year");
            const hour = get("hour");
            const minute = get("minute");
            const dayPeriod = get("dayPeriod").toLowerCase();
            signDateEt = `${weekday} ${month} ${day}, ${year} ${hour}:${minute} ${dayPeriod}`;
          }

          // Store ET string in hidden field `signDate`
          const hiddenSignDate = document.querySelector(
            'input[name="signDate"]'
          );
          if (hiddenSignDate) hiddenSignDate.value = signDateEt;

          const formData = {
            clientId: document.querySelector('input[name="clientId"]').value,
            fullName: document.querySelector('input[name="fullName"]').value,
            signature: signatureRaw, // Send original case
            signDate: document.querySelector('input[name="signDate"]').value,
          };

          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                const clientId = document.querySelector(
                  'input[name="clientId"]'
                ).value;
                const targetUrl =
                  "<?= scriptUrl ?>?page=client-intake-steps&id=" + clientId;

                const container = document.querySelector(".container-box");
                container.innerHTML = `
                <div class="p-10 text-center">
                  <div style="width: 64px; height: 64px; margin: 0 auto 16px; border-radius: 50%; background-color: #dcfce7; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <h2 class="text-xl font-bold mb-2">Agreement Signed</h2>
                  <p class="text-gray-600 mb-6">Thank you for signing Exhibit A.</p>
                  <a href="${targetUrl}" style="display: inline-flex; align-items: center; padding: 12px 24px; border: none; border-radius: 6px; background-color: #16a34a; color: white; text-decoration: none; font-weight: 500;">Return to Intake Steps</a>
                </div>`;
                window.scrollTo(0, 0);
              } else {
                alert("Error: " + response.message);
                btn.innerText = originalText;
                btn.disabled = false;
              }
            })
            .withFailureHandler(function (err) {
              alert("Error: " + err);
              btn.innerText = originalText;
              btn.disabled = false;
            })
            .submitClientExhibitA(formData);
        });
    </script>
  </body>
</html>
