<script>
  function toggleOtherInput(select, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (select.value === "Other") {
      container.classList.remove("hidden");
    } else {
      container.classList.add("hidden");
    }
  }

  function toggleLangOther(checkbox) {
    const container = document.getElementById("as-lang-other-container");
    if (checkbox.checked) {
      container.classList.remove("hidden");
    } else {
      container.classList.add("hidden");
    }
  }

  function syncBillingAddress(checkbox) {
    const fields = ["Address", "Apt", "City", "State", "Zip"];
    const container = document.getElementById("billing-fields");

    if (checkbox.checked) {
      container.classList.add("opacity-50", "pointer-events-none");
      fields.forEach((f) => {
        const primary = document.getElementById(`as-client${f}`);
        const billing = document.getElementById(`as-billing${f}`);
        if (primary && billing) billing.value = primary.value;
      });
    } else {
      container.classList.remove("opacity-50", "pointer-events-none");
    }
  }

  function openAssessmentForm(clientId) {
    toggleClientStageView("form");
    document.getElementById("assessmentDetailsForm").reset();
    document.getElementById("as-age-display").textContent = "-- years old";
    document
      .getElementById("as-status-other-container")
      .classList.add("hidden");
    document.getElementById("as-lang-other-container").classList.add("hidden");
    document
      .getElementById("billing-fields")
      .classList.remove("opacity-50", "pointer-events-none");

    google.script.run
      .withSuccessHandler((data) => {
        if (!data) return;
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = val || "";
        };

        setVal("as-id", data.id);
        setVal("as-firstName", data.firstName);
        setVal("as-middleName", data.middleName);
        setVal("as-lastName", data.lastName);
        setVal("as-email", data.email);
        setVal("as-clientPhone", data.clientPhone);
        setVal("as-username", data.username);
        setVal("as-gender", data.gender);
        setVal("as-maritalStatus", data.maritalStatus);
        setVal("as-spouseName", data.spouseName);
        setVal("as-coordinator", data.coordinator);
        setVal("as-codeStatus", data.codeStatus);

        // Status handling
        const statusSelect = document.getElementById("as-status-select");
        const options = Array.from(statusSelect.options).map(
          (opt) => opt.value
        );
        if (data.status && options.includes(data.status)) {
          statusSelect.value = data.status;
        } else if (data.status) {
          statusSelect.value = "Other";
          setVal("as-status-other", data.status);
          document
            .getElementById("as-status-other-container")
            .classList.remove("hidden");
        }

        // Languages handling
        const langs = (data.languages || "").split(",").map((s) => s.trim());
        const langChecks = document.getElementsByName("lang");
        let otherLang = "";
        langChecks.forEach((cb) => {
          if (cb.value === "Other") {
            const hasOther = langs.some(
              (l) =>
                !Array.from(langChecks).some(
                  (alt) => alt.value !== "Other" && alt.value === l
                )
            );
            if (hasOther) {
              cb.checked = true;
              document
                .getElementById("as-lang-other-container")
                .classList.remove("hidden");
              // Find the one that doesn't match predefined
              const predefined = Array.from(langChecks).map((alt) => alt.value);
              otherLang = langs
                .filter((l) => !predefined.includes(l))
                .join(", ");
              setVal("as-lang-other", otherLang);
            }
          } else {
            cb.checked = langs.includes(cb.value);
          }
        });

        // Address handling
        setVal("as-clientAddress", data.clientAddress);
        setVal("as-clientApt", data.clientApt);
        setVal("as-clientCity", data.clientCity);
        setVal("as-clientState", data.clientState);
        setVal("as-clientZip", data.clientZip);

        setVal("as-billingAddress", data.billingAddress);
        setVal("as-billingApt", data.billingApt);
        setVal("as-billingCity", data.billingCity);
        setVal("as-billingState", data.billingState);
        setVal("as-billingZip", data.billingZip);

        // Check if billing same as primary
        const isSame =
          data.clientAddress === data.billingAddress &&
          data.clientZip === data.billingZip &&
          data.billingAddress !== "";
        if (isSame) {
          document.getElementById("as-same-address").checked = true;
          document
            .getElementById("billing-fields")
            .classList.add("opacity-50", "pointer-events-none");
        }

        setVal("as-ssn", data.ssn);
        setVal("as-ein", data.ein);

        if (data.dob) {
          setVal("as-dob", data.dob);
          updateClientAge(data.dob);
        }
      })
      .getClientDetails(clientId);
  }

  function submitAssessmentForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveAssessmentBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";

    const form = document.getElementById("assessmentDetailsForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      if (key !== "lang") data[key] = value;
    });

    // Handle Status Other
    if (data.status_select === "Other") {
      data.status = document.getElementById("as-status-other").value;
    } else {
      data.status = data.status_select;
    }

    // Handle Languages
    const langChecks = document.getElementsByName("lang");
    const selectedLangs = Array.from(langChecks)
      .filter((cb) => cb.checked && cb.value !== "Other")
      .map((cb) => cb.value);

    const otherLangCb = Array.from(langChecks).find(
      (cb) => cb.value === "Other" && cb.checked
    );
    if (otherLangCb) {
      const otherVal = document.getElementById("as-lang-other").value;
      if (otherVal) selectedLangs.push(otherVal);
    }
    data.languages = selectedLangs.join(", ");

    // Handle Billing Address sync if checked
    if (document.getElementById("as-same-address").checked) {
      data.billingAddress = data.clientAddress;
      data.billingApt = data.clientApt;
      data.billingCity = data.clientCity;
      data.billingState = data.clientState;
      data.billingZip = data.clientZip;
    }

    google.script.run
      .withSuccessHandler((existing) => {
        const merged = { ...existing, ...data };
        google.script.run
          .withSuccessHandler((res) => {
            btn.disabled = false;
            btn.textContent = "Save Details";
            if (res.success) {
              Swal.fire("Success", "Assessment details saved!", "success");
              toggleClientStageView("stages");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClient(merged);
      })
      .getClientDetails(data.id);
  }

  function updateClientAge(dobValue) {
    const display = document.getElementById("as-age-display");
    if (!dobValue) {
      display.textContent = "-- years old";
      return;
    }
    const birthDate = new Date(dobValue);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    display.textContent = `${age} years old`;
  }

  function formatSSN(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 9) value = value.substring(0, 9);
    let formatted = "";
    if (value.length > 0) {
      formatted = value.substring(0, 3);
      if (value.length > 3) formatted += "-" + value.substring(3, 5);
      if (value.length > 5) formatted += "-" + value.substring(5, 9);
    }
    input.value = formatted;
  }

  function formatEIN(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 9) value = value.substring(0, 9);
    let formatted = "";
    if (value.length > 0) {
      formatted = value.substring(0, 2);
      if (value.length > 2) formatted += "-" + value.substring(2, 9);
    }
    input.value = formatted;
  }
</script>
