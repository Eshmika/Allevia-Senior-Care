<script>
  function toggleClientStageView(view) {
    const main = document.getElementById("client-stages-main");
    const form = document.getElementById("client-assessment-view");

    if (view === "form") {
      main.classList.add("hidden");
      form.classList.remove("hidden");
    } else {
      main.classList.remove("hidden");
      form.classList.add("hidden");
    }
  }
  function toggleOtherInput(select, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (select.value === "Other") {
      container.classList.remove("hidden");
    } else {
      container.classList.add("hidden");
    }
  }

  function toggleLangOther(checkbox) {
    const container = document.getElementById("as-lang-other-container");
    if (checkbox.checked) {
      container.classList.remove("hidden");
    } else {
      container.classList.add("hidden");
    }
  }

  function syncBillingAddress(checkbox) {
    const fields = ["Address", "Apt", "City", "State", "Zip"];
    const container = document.getElementById("billing-fields");

    if (checkbox.checked) {
      container.classList.add("opacity-50", "pointer-events-none");
      fields.forEach((f) => {
        const primary = document.getElementById(`as-client${f}`);
        const billing = document.getElementById(`as-billing${f}`);
        if (primary && billing) billing.value = primary.value;
      });
    } else {
      container.classList.remove("opacity-50", "pointer-events-none");
    }
  }

  function syncEmergencyAddress(checkbox) {
    const fields = ["Address", "Apt", "City", "State", "Zip"];
    const container = document.getElementById("ec-address-fields");

    if (checkbox.checked) {
      container.classList.add("opacity-50", "pointer-events-none");
      fields.forEach((f) => {
        const clientRel = document.getElementById(`as-client${f}`);
        const ecRel = document.getElementById(`as-emergency${f}`);
        if (clientRel && ecRel) ecRel.value = clientRel.value;
      });
    } else {
      container.classList.remove("opacity-50", "pointer-events-none");
    }
  }

  function syncAuthAddress(checkbox) {
    const fields = ["Address", "Apt", "City", "State", "Zip"];
    const container = document.getElementById("auth-address-fields");

    if (checkbox.checked) {
      container.classList.add("opacity-50", "pointer-events-none");
      fields.forEach((f) => {
        const clientRel = document.getElementById(`as-client${f}`);
        const authRel = document.getElementById(`as-auth${f}`);
        if (clientRel && authRel) authRel.value = clientRel.value;
      });
    } else {
      container.classList.remove("opacity-50", "pointer-events-none");
    }
  }

  function handleNameSync(type, value) {
    const input = document.getElementById(
      `as-${type === "ec" ? "emergency" : "auth"}Name`
    );
    if (!input) return;

    if (value === "custom") {
      input.classList.remove("hidden");
      input.readOnly = false;
    } else {
      input.classList.add("hidden");
      input.readOnly = true;
      if (value === "rep") {
        input.value = document.getElementById("as-repName-hidden").value;
      } else if (value === "ec") {
        input.value = document.getElementById("as-emergencyName").value;
      }
    }
  }

  function openAssessmentForm(clientId) {
    toggleClientStageView("form");
    document.getElementById("assessmentDetailsForm").reset();
    document.getElementById("as-age-display").textContent = "-- years old";
    document
      .getElementById("as-status-other-container")
      .classList.add("hidden");
    document.getElementById("as-lang-other-container").classList.add("hidden");
    document
      .getElementById("billing-fields")
      .classList.remove("opacity-50", "pointer-events-none");
    document
      .getElementById("ec-address-fields")
      .classList.remove("opacity-50", "pointer-events-none");
    document
      .getElementById("auth-address-fields")
      .classList.remove("opacity-50", "pointer-events-none");

    // Reset sync selectors
    document.getElementById("as-ec-name-sync").value = "custom";
    document.getElementById("as-emergencyName").classList.remove("hidden");
    document.getElementById("as-auth-name-sync").value = "custom";
    document.getElementById("as-authName").classList.remove("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        if (!data) return;
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = val || "";
        };

        setVal("as-id", data.id);
        setVal("as-repName-hidden", data.repName);
        setVal("as-firstName", data.firstName);
        setVal("as-middleName", data.middleName);
        setVal("as-lastName", data.lastName);
        setVal("as-email", data.email);
        setVal("as-clientPhone", data.clientPhone);
        setVal("as-username", data.username);
        setVal("as-gender", data.gender);
        setVal("as-maritalStatus", data.maritalStatus);
        setVal("as-spouseName", data.spouseName);
        setVal("as-coordinator", data.coordinator);
        setVal("as-codeStatus", data.codeStatus);

        // Status handling
        const statusSelect = document.getElementById("as-status-select");
        const options = Array.from(statusSelect.options).map(
          (opt) => opt.value
        );
        if (data.status && options.includes(data.status)) {
          statusSelect.value = data.status;
        } else if (data.status) {
          statusSelect.value = "Other";
          setVal("as-status-other", data.status);
          document
            .getElementById("as-status-other-container")
            .classList.remove("hidden");
        }

        // Languages handling
        const langs = (data.languages || "").split(",").map((s) => s.trim());
        const langChecks = document.getElementsByName("lang");
        let otherLang = "";
        langChecks.forEach((cb) => {
          if (cb.value === "Other") {
            const hasOther = langs.some(
              (l) =>
                !Array.from(langChecks).some(
                  (alt) => alt.value !== "Other" && alt.value === l
                )
            );
            if (hasOther) {
              cb.checked = true;
              document
                .getElementById("as-lang-other-container")
                .classList.remove("hidden");
              // Find the one that doesn't match predefined
              const predefined = Array.from(langChecks).map((alt) => alt.value);
              otherLang = langs
                .filter((l) => !predefined.includes(l))
                .join(", ");
              setVal("as-lang-other", otherLang);
            }
          } else {
            cb.checked = langs.includes(cb.value);
          }
        });

        // Address handling
        setVal("as-clientAddress", data.clientAddress);
        setVal("as-clientApt", data.clientApt);
        setVal("as-clientCity", data.clientCity);
        setVal("as-clientState", data.clientState);
        setVal("as-clientZip", data.clientZip);

        setVal("as-billingAddress", data.billingAddress);
        setVal("as-billingApt", data.billingApt);
        setVal("as-billingCity", data.billingCity);
        setVal("as-billingState", data.billingState);
        setVal("as-billingZip", data.billingZip);

        // Emergency Contact fields
        setVal("as-emergencyName", data.emergencyName);
        setVal("as-emergencyPhone", data.emergencyPhone);
        setVal("as-emergencyEmail", data.emergencyEmail);
        setVal("as-emergencyRelationship", data.emergencyRelationship);
        setVal("as-emergencyAddress", data.emergencyAddress);
        setVal("as-emergencyApt", data.emergencyApt);
        setVal("as-emergencyCity", data.emergencyCity);
        setVal("as-emergencyState", data.emergencyState);
        setVal("as-emergencyZip", data.emergencyZip);

        // Detect EC Name sync
        if (data.emergencyName && data.emergencyName === data.repName) {
          document.getElementById("as-ec-name-sync").value = "rep";
          document.getElementById("as-emergencyName").classList.add("hidden");
        }

        // Authorized Contact fields
        setVal("as-authName", data.authName);
        setVal("as-authPhone", data.authPhone);
        setVal("as-authEmail", data.authEmail);
        setVal("as-authRelationship", data.authRelationship);
        setVal("as-authAddress", data.authAddress);
        setVal("as-authApt", data.authApt);
        setVal("as-authCity", data.authCity);
        setVal("as-authState", data.authState);
        setVal("as-authZip", data.authZip);

        // Detect Auth Name sync
        if (data.authName && data.authName === data.repName) {
          document.getElementById("as-auth-name-sync").value = "rep";
          document.getElementById("as-authName").classList.add("hidden");
        } else if (data.authName && data.authName === data.emergencyName) {
          document.getElementById("as-auth-name-sync").value = "ec";
          document.getElementById("as-authName").classList.add("hidden");
        }

        // Check if billing same as primary
        const isBillingSame =
          data.clientAddress === data.billingAddress &&
          data.clientZip === data.billingZip &&
          data.billingAddress !== "";
        if (isBillingSame) {
          document.getElementById("as-same-address").checked = true;
          document
            .getElementById("billing-fields")
            .classList.add("opacity-50", "pointer-events-none");
        }

        // Check if emergency address same as primary
        const isECSame =
          data.clientAddress === data.emergencyAddress &&
          data.clientZip === data.emergencyZip &&
          data.emergencyAddress !== "";
        if (isECSame) {
          document.getElementById("as-ec-same-address").checked = true;
          document
            .getElementById("ec-address-fields")
            .classList.add("opacity-50", "pointer-events-none");
        }

        // Check if auth address same as primary
        const isAuthSame =
          data.clientAddress === data.authAddress &&
          data.clientZip === data.authZip &&
          data.authAddress !== "";
        if (isAuthSame) {
          document.getElementById("as-auth-same-address").checked = true;
          document
            .getElementById("auth-address-fields")
            .classList.add("opacity-50", "pointer-events-none");
        }

        setVal("as-ssn", data.ssn);
        setVal("as-ein", data.ein);

        if (data.dob) {
          setVal("as-dob", data.dob);
          updateClientAge(data.dob);
        }
      })
      .getClientDetails(clientId);
  }

  function submitAssessmentForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveAssessmentBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";

    const form = document.getElementById("assessmentDetailsForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      if (key !== "lang") data[key] = value;
    });

    // Handle Status Other
    if (data.status_select === "Other") {
      data.status = document.getElementById("as-status-other").value;
    } else {
      data.status = data.status_select;
    }

    // Handle Languages
    const langChecks = document.getElementsByName("lang");
    const selectedLangs = Array.from(langChecks)
      .filter((cb) => cb.checked && cb.value !== "Other")
      .map((cb) => cb.value);

    const otherLangCb = Array.from(langChecks).find(
      (cb) => cb.value === "Other" && cb.checked
    );
    if (otherLangCb) {
      const otherVal = document.getElementById("as-lang-other").value;
      if (otherVal) selectedLangs.push(otherVal);
    }
    data.languages = selectedLangs.join(", ");

    // Handle Billing Address sync if checked
    if (document.getElementById("as-same-address").checked) {
      data.billingAddress = data.clientAddress;
      data.billingApt = data.clientApt;
      data.billingCity = data.clientCity;
      data.billingState = data.clientState;
      data.billingZip = data.clientZip;
    }

    // Handle Emergency Address sync if checked
    if (document.getElementById("as-ec-same-address").checked) {
      data.emergencyAddress = data.clientAddress;
      data.emergencyApt = data.clientApt;
      data.emergencyCity = data.clientCity;
      data.emergencyState = data.clientState;
      data.emergencyZip = data.clientZip;
    }

    // Handle Authorized Address sync if checked
    if (document.getElementById("as-auth-same-address").checked) {
      data.authAddress = data.clientAddress;
      data.authApt = data.clientApt;
      data.authCity = data.clientCity;
      data.authState = data.clientState;
      data.authZip = data.clientZip;
    }

    google.script.run
      .withSuccessHandler((existing) => {
        const merged = { ...existing, ...data };
        google.script.run
          .withSuccessHandler((res) => {
            btn.disabled = false;
            btn.textContent = "Save Details";
            if (res.success) {
              Swal.fire("Success", "Assessment details saved!", "success");
              toggleClientStageView("stages");
              loadClientStages();
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .updateClient(merged);
      })
      .getClientDetails(data.id);
  }

  function updateClientAge(dobValue) {
    const display = document.getElementById("as-age-display");
    if (!dobValue) {
      display.textContent = "-- years old";
      return;
    }
    const birthDate = new Date(dobValue);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    display.textContent = `${age} years old`;
  }

  function formatSSN(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 9) value = value.substring(0, 9);
    let formatted = "";
    if (value.length > 0) {
      formatted = value.substring(0, 3);
      if (value.length > 3) formatted += "-" + value.substring(3, 5);
      if (value.length > 5) formatted += "-" + value.substring(5, 9);
    }
    input.value = formatted;
  }

  function formatEIN(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 9) value = value.substring(0, 9);
    let formatted = "";
    if (value.length > 0) {
      formatted = value.substring(0, 2);
      if (value.length > 2) formatted += "-" + value.substring(2, 9);
    }
    input.value = formatted;
  }
</script>
