<script>
  // -- Global State --
  let cgData = [];
  let cgFiltered = [];
  let cgCurrentPage = 1;
  const cgRowsPerPage = 5;
  let currentProfileId = null;
  let currentProfileData = null;
  let clData = [];
  let currentClientData = null;

  // -- Input Masking & Validation --
  function setupInputMasks() {
    // Helper to attach listeners
    const attach = (selector, type) => {
      const els = document.querySelectorAll(selector);
      els.forEach((el) => {
        // Remove existing listeners to avoid duplicates if called multiple times
        // (Simple way is just to overwrite oninput, though addEventListener is better if we track them)
        el.oninput = (e) => handleInputMask(e, type);
      });
    };

    // Caregiver Inputs
    attach('input[name="ssn"]', "ssn");
    attach('input[name="phone"]', "phone");
    attach('input[name="zip"]', "zip");

    // Client Inputs
    // Note: Client form uses same names
    attach('#clientForm input[name="phone"]', "phone");
    attach('#clientForm input[name="zip"]', "zip");

    // Edit Forms (IDs)
    attach("#edit-ssn", "ssn");
    attach("#edit-phone", "phone");
    attach("#edit-zip", "zip");
    attach('input[name="routingNum"]', "routing");
    attach('input[name="accountNum"]', "account");
    attach("#edit-routingNum", "routing");
    attach("#edit-accountNum", "account");
    attach("#ce-phone", "phone");
    attach("#ce-zip", "zip");
  }

  function handleInputMask(e, type) {
    let val = e.target.value.replace(/\D/g, ""); // Strip non-digits

    if (type === "ssn") {
      // Max 9 digits
      if (val.length > 9) val = val.substring(0, 9);

      // Format: xxx-xx-xxxx
      if (val.length > 5) {
        val = val.replace(/^(\d{3})(\d{2})(\d+)/, "$1-$2-$3");
      } else if (val.length > 3) {
        val = val.replace(/^(\d{3})(\d+)/, "$1-$2");
      }
      e.target.value = val;
    } else if (type === "phone") {
      // Max 10 digits
      if (val.length > 10) val = val.substring(0, 10);

      // Format: (xxx) xxx-xxxx
      if (val.length > 6) {
        val = val.replace(/^(\d{3})(\d{3})(\d+)/, "($1) $2-$3");
      } else if (val.length > 3) {
        val = val.replace(/^(\d{3})(\d+)/, "($1) $2");
      }
      e.target.value = val;
    } else if (type === "zip") {
      // Max 5 digits
      if (val.length > 5) val = val.substring(0, 5);
      e.target.value = val;
    } else if (type === "routing") {
      // Max 9 digits
      if (val.length > 9) val = val.substring(0, 9);
      e.target.value = val;
    } else if (type === "account") {
      // Max 12 digits
      if (val.length > 12) val = val.substring(0, 12);
      e.target.value = val;
    }
  }

  // Initialize masks on load
  window.addEventListener("DOMContentLoaded", setupInputMasks);

  // -- Google Maps Autocomplete --
  window.initAutocomplete = function () {
    // Helper to setup autocomplete
    const setup = (addrId, cityId, stateId, zipId) => {
      const input = document.getElementById(addrId);
      if (!input) return;

      // Check if google is defined (in case API fails to load)
      if (typeof google === "undefined" || !google.maps || !google.maps.places)
        return;

      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ["address"],
        componentRestrictions: { country: "us" },
        fields: ["address_components", "geometry", "name"],
      });

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        fillInAddress(place, cityId, stateId, zipId);
      });
    };

    // Caregiver Edit Profile
    setup("edit-address", "edit-city", "edit-state", "edit-zip");

    // Client Add Form
    setup("add-cl-address", "add-cl-city", null, "add-cl-zip");
    setup("add-cl-emAddress", "add-cl-emCity", null, "add-cl-emZip");

    // Client Edit Form
    setup("ce-address", "ce-city", null, "ce-zip");
    setup("ce-emAddress", "ce-emCity", null, "ce-emZip");
  };

  function fillInAddress(place, cityId, stateId, zipId) {
    let address1 = "";
    let postcode = "";
    let city = "";
    let state = "";

    if (place.address_components) {
      for (const component of place.address_components) {
        const componentType = component.types[0];

        switch (componentType) {
          case "street_number": {
            address1 = `${component.long_name} ${address1}`;
            break;
          }
          case "route": {
            address1 += component.short_name;
            break;
          }
          case "postal_code": {
            postcode = `${component.long_name}`;
            break;
          }
          case "locality":
            city = component.long_name;
            break;
          case "administrative_area_level_1": {
            state = component.short_name;
            break;
          }
        }
      }
    }

    if (cityId && document.getElementById(cityId)) {
      document.getElementById(cityId).value = city;
    }
    if (stateId && document.getElementById(stateId)) {
      document.getElementById(stateId).value = state;
    }
    if (zipId && document.getElementById(zipId)) {
      // Max 5 digits as requested
      document.getElementById(zipId).value = postcode.substring(0, 5);
    }
  }

  // -- Navigation --
  const originalNavigate = window.navigate || function () {};
  window.navigate = function (viewName) {
    document
      .querySelectorAll(".nav-item")
      .forEach((el) => el.classList.remove("active"));
    document
      .querySelectorAll(".view-section")
      .forEach((el) => el.classList.remove("active"));

    const btn = document.querySelector(
      `button[onclick="navigate('${viewName}')"]`
    );
    if (btn) btn.classList.add("active");

    const target = document.getElementById("view-" + viewName);
    if (target) target.classList.add("active");

    // Re-attach masks when switching views (just in case dynamic content)
    setupInputMasks();

    if (viewName === "caregivers") {
      loadCaregiverList();
      switchCgView("list");
    } else if (viewName === "caregiver-stages") {
      document.getElementById("view-caregivers").classList.add("active");
      loadCaregiverStages();
      switchCgView("stages");
    } else if (viewName === "clients") {
      loadClientList();
      switchClView("list");
    } else if (viewName === "dashboard") {
      loadDashboardStats();
    } else if (viewName === "communication") {
      loadCommunicationView();
    } else if (viewName === "shifts") {
      loadShiftView();
    } else if (viewName === "caregiver-calendar") {
      loadCaregiverCalendar();
    }
  };

  function switchCgView(subView) {
    document.getElementById("cg-subview-list").classList.add("hidden");
    document.getElementById("cg-subview-add").classList.add("hidden");
    document.getElementById("cg-subview-profile").classList.add("hidden");
    document.getElementById("cg-subview-edit").classList.add("hidden");
    const stages = document.getElementById("cg-subview-stages");
    if (stages) stages.classList.add("hidden");

    const target = document.getElementById("cg-subview-" + subView);
    if (target) target.classList.remove("hidden");
  }

  // -- 1. Load List --
  function loadCaregiverList() {
    document.getElementById("cgTableBody").innerHTML =
      '<tr><td colspan="6" class="p-4 text-center text-gray-400">Loading list...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        console.log("Loaded List:", data); // Debug
        cgData = data;
        renderCgTable();
      })
      .getCaregiverList();
  }

  // -- 2. Render Table --
  function renderCgTable() {
    const search = document.getElementById("cgSearch").value.toLowerCase();
    const statusFilter = document.getElementById("cgFilterStatus").value;

    cgFiltered = cgData.filter((item) => {
      // Only show caregivers who have been converted to Active/Inactive/etc.
      // Exclude "Applicant", "Pending", or empty statuses unless they are in the final stages.
      const validStatuses = ["Active", "Inactive", "No call", "Vacation"];
      if (!validStatuses.includes(item.status)) return false;

      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search) ||
        String(item.id).toLowerCase().includes(search);
      const matchStatus =
        statusFilter === "All" || item.status === statusFilter;
      return matchSearch && matchStatus;
    });

    const totalPages = Math.ceil(cgFiltered.length / cgRowsPerPage);
    if (cgCurrentPage > totalPages) cgCurrentPage = 1;

    const start = (cgCurrentPage - 1) * cgRowsPerPage;
    const end = start + cgRowsPerPage;
    const pageData = cgFiltered.slice(start, end);

    const tbody = document.getElementById("cgTableBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No caregivers found.</td></tr>';
    } else {
      pageData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.className =
          "hover:bg-gray-50 transition-colors cursor-pointer group";

        // IMPORTANT: Pass ID exactly as string
        tr.onclick = function () {
          loadProfile(row.id);
        };

        let statusColor = "bg-gray-100 text-gray-600";
        if (row.status === "Active")
          statusColor = "bg-green-100 text-green-700";
        if (row.status === "Inactive") statusColor = "bg-red-100 text-red-700";
        if (row.status === "Vacation")
          statusColor = "bg-orange-100 text-orange-700";

        tr.innerHTML = `
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4 text-gray-600">${row.title}</td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip}</p>
            </div>
          </td>
          <td class="p-4 text-xs text-gray-500">${row.lastReviewed || "--"}</td>
          <td class="p-4 text-xs text-gray-500 font-medium">${
            row.lastClientSeen || "--"
          }</td>
          <td class="p-4">
            <span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${
          row.status
        }</span>
          </td>
          <td class="p-4 text-right">
             <button onclick="loadProfile('${
               row.id
             }')" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full hover:bg-green-100 font-bold border border-green-200 transition-colors">Details</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("cgPageInfo").textContent = `Showing ${
      pageData.length > 0 ? start + 1 : 0
    }-${Math.min(end, cgFiltered.length)} of ${cgFiltered.length}`;
    document.getElementById("btnPrev").disabled = cgCurrentPage === 1;
    document.getElementById("btnNext").disabled =
      cgCurrentPage >= totalPages || totalPages === 0;
  }

  function changeCgPage(dir) {
    cgCurrentPage += dir;
    renderCgTable();
  }

  // --- EDIT PROFILE LOGIC (NEW) ---

  function openEditMode() {
    if (!currentProfileData) return;
    switchCgView("edit");
    const d = currentProfileData;

    // 1. Fill Text Inputs
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val || "";
    };

    setVal("edit-id", d["Caregiver ID"]);
    setVal("edit-firstName", d["First Name"]);
    setVal("edit-lastName", d["Last Name"]);
    setVal("edit-middleName", d["Middle Int"]);

    if (d["DOB"]) {
      const date = new Date(d["DOB"]);
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      setVal("edit-dob", `${yyyy}-${mm}-${dd}`);
    }

    setVal("edit-gender", d["Gender"]);
    setVal("edit-ssn", d["SSN"]);
    setVal("edit-routingNum", d["Routing Number"]);
    setVal("edit-accountNum", d["Bank Account"]);
    setVal("edit-status", d["Status"]);
    setVal("edit-address", d["Address"]);
    setVal("edit-apt", d["Apt"]);
    setVal("edit-city", d["City"]);
    setVal("edit-state", d["State"]);
    setVal("edit-zip", d["Zip"]);
    setVal("edit-phone", d["Phone"]);
    setVal("edit-email", d["Email"]);

    setVal("edit-hasLicense", d["Driver License?"]);
    setVal("edit-licenseState", d["License State"]);
    setVal("edit-licenseNum", d["License #"]);
    setVal("edit-hasCar", d["Has Car?"]);
    setVal("edit-carModel", d["Car Make/Model"]);
    setVal("edit-hasInsurance", d["Has Insurance?"]);
    setVal("edit-emergencyAvail", d["Emergency Avail?"]);
    setVal("edit-liveInAvail", d["Live-in Avail?"]);
    setVal("edit-usEligible", d["US Eligible?"]);
    setVal("edit-usCitizen", d["US Citizen?"]);

    setVal("edit-emName", d["Emergency Contact"]);
    setVal("edit-emPhone", d["Emerg. Phone"]);
    setVal("edit-emRel", d["Emerg. Relation"]);

    // New Sections Mapped
    setVal("edit-hsName", d["High School"]);
    setVal("edit-hsDegree", d["HS Degree"]);
    setVal("edit-colName", d["College"]);
    setVal("edit-colDegree", d["College Degree"]);
    setVal("edit-otherEdu", d["Other Edu"]);
    setVal("edit-otherDegree", d["Other Degree"]);

    setVal("edit-emp1", d["Employer 1"]);
    setVal("edit-emp2", d["Employer 2"]);
    setVal("edit-emp3", d["Employer 3"]);

    setVal("edit-ref1", d["Reference 1"]);
    setVal("edit-ref2", d["Reference 2"]);

    setVal("edit-criminalHistory", d["Criminal Conviction?"]);
    setVal("edit-criminalExplain", d["Conviction Details"]);

    // 2. Checkboxes
    const checkBoxes = (name, str) => {
      const arr = str ? str.split(",").map((s) => s.trim()) : [];
      document.querySelectorAll(`input[name="${name}"]`).forEach((cb) => {
        cb.checked = arr.includes(cb.value);
      });
    };

    checkBoxes("hoursAvail", d["Hours Avail"]);
    checkBoxes("scheduleDays", d["Schedule Desired"]);
    checkBoxes("timesAvail", d["Times Avail"]);
    checkBoxes("certs", d["Certifications"]);
    checkBoxes("skills", d["Skills Checklist"]);
    checkBoxes("languages", d["Languages"]);
  }

  function cancelEdit() {
    switchCgView("profile");
  }

  function submitEditProfile(e) {
    e.preventDefault();
    const btn = document.getElementById("saveProfileBtn");
    btn.textContent = "Saving...";
    btn.disabled = true;

    const form = document.getElementById("editProfileForm");
    const obj = {};
    const formData = new FormData(form);

    // Checkboxes
    const getChecks = (name) =>
      Array.from(
        document.querySelectorAll(`input[name="${name}"]:checked`)
      ).map((c) => c.value);

    for (let [key, value] of formData.entries()) {
      obj[key] = value;
    }

    obj.skills = getChecks("skills");
    obj.certs = getChecks("certs");
    obj.languages = getChecks("languages");
    obj.hoursAvail = getChecks("hoursAvail");
    obj.scheduleDays = getChecks("scheduleDays");
    obj.timesAvail = getChecks("timesAvail");

    // SPECIAL MAPPING for SheetController compat
    // The controller expects objects for these, so we mock them to match the string value
    obj.emp1 = { company: obj.emp1_full || "", title: "" };
    obj.emp2 = { company: obj.emp2_full || "", title: "" };
    obj.emp3 = { company: obj.emp3_full || "", title: "" };

    obj.ref1 = { name: obj.ref1_full || "", phone: "" };
    obj.ref2 = { name: obj.ref2_full || "", phone: "" };

    google.script.run
      .withSuccessHandler((res) => {
        btn.textContent = "Save Changes";
        btn.disabled = false;
        if (res.success) {
          Swal.fire("Success", "Profile Updated", "success");
          loadProfile(currentProfileId);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .submitFullApplication(obj);
  }

  // --- STAGE LOGIC ---
  function updateStageUI(stageNum, status, textId, btnId, iconId, label) {
    const icon = document.getElementById(iconId);
    const btn = document.getElementById(btnId);
    const text = document.getElementById(textId);

    if (!icon) return;

    if (
      status === "Yes" ||
      status === "Application Completed" ||
      status === "Done"
    ) {
      // SUCCESS
      icon.className =
        "w-12 h-12 rounded-full bg-[#65c027] text-white flex items-center justify-center text-xl font-bold border-4 border-white transition-colors shadow-lg";
      icon.innerHTML = '<i class="ph ph-check"></i>';
      if (btn) {
        btn.textContent = "Passed";
        btn.disabled = true;
        btn.className =
          "mt-1 text-xs px-2 py-1 rounded bg-green-50 text-green-600 font-bold";
      }
      if (text) {
        text.textContent = "Completed";
        text.className = "text-xs text-green-600 font-bold";
      }
    } else if (status === "No") {
      // FAILED / NO
      icon.className =
        "w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-xl font-bold border-4 border-white transition-colors";
      icon.innerHTML = '<i class="ph ph-x"></i>';
      if (btn) {
        btn.textContent = "Failed";
        btn.disabled = false;
        btn.className =
          "mt-1 text-xs px-2 py-1 rounded bg-red-50 text-red-600 font-bold hover:bg-red-100 cursor-pointer";
      }
    } else if (status === "Missing") {
      // MISSING
      icon.className =
        "w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center text-xl font-bold border-4 border-white transition-colors shadow-lg";
      icon.innerHTML = '<i class="ph ph-warning"></i>';
      if (text) {
        text.textContent = "Missing (> 1 Week)";
        text.className = "text-xs text-red-500 font-bold";
      }
    } else {
      // PENDING
      if (btn) {
        btn.textContent = label;
        btn.disabled = false;
        btn.className =
          "mt-1 text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 transition";
      }
      icon.className =
        "w-12 h-12 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-xl font-bold border-4 border-white transition-colors";
      icon.innerHTML =
        stageNum === 2
          ? '<i class="ph ph-chats-circle"></i>'
          : stageNum === 3
          ? '<i class="ph ph-shield-check"></i>'
          : stageNum === 4
          ? '<i class="ph ph-briefcase"></i>'
          : stageNum;
    }
  }

  function advanceStage(stageNum) {
    if (!currentProfileId) return;

    let title = "";
    let field = "";

    if (stageNum === 2) {
      title = "Interview Passed?";
      field = "Interview";
    }
    if (stageNum === 3) {
      title = "Background Check Passed?";
      field = "Background";
    }
    if (stageNum === 4) {
      title = "Activate Caregiver?";
      field = "Active";
    }

    // POPUP FOR YES / NO
    Swal.fire({
      title: title,
      icon: "question",
      showDenyButton: true,
      confirmButtonText: "Yes",
      denyButtonText: "No",
      confirmButtonColor: "#65c027",
      denyButtonColor: "#d33",
    }).then((result) => {
      if (result.isDismissed) return; // Clicked outside

      let val = result.isConfirmed ? "Yes" : "No";

      // Special logic for Activation
      if (stageNum === 4) {
        val = result.isConfirmed ? "Active" : "Inactive";
      }

      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            loadProfile(currentProfileId);
            if (stageNum === 4 && val === "Active") {
              Swal.fire("Success", "Caregiver is now Active!", "success");
            }
          } else {
            Swal.fire("Error", res.message, "error");
          }
        })
        .updateCaregiverStage(currentProfileId, field, val);
    });
  }

  // -- 3. Load Profile --
  function openProfile(id) {
    loadProfile(id);
  }

  function loadProfile(id) {
    currentProfileId = id;

    switchCgView("profile");
    document.getElementById("profileLoading").classList.remove("hidden");
    document.getElementById("profileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        if (!data) {
          Swal.fire("Error", "Caregiver details not found.", "error");
          switchCgView("list");
          return;
        }

        currentProfileData = data; // SAVE DATA FOR EDIT MODE

        // CRITICAL FIX: Safety Check Set Function
        const set = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val || "--";
        };

        set(
          "p-name",
          data["First Name"] +
            " " +
            data["Middle Int"] +
            " " +
            data["Last Name"]
        );
        set("p-initials", (data["First Name"] || "U").charAt(0));
        set("p-title", data["Title"]);
        set("p-id", data["Caregiver ID"]);
        set("p-last-client", data["Last Client Seen"]);

        const pipelinePanel = document.getElementById("pipeline-panel");
        if (data["Status"] === "Active") {
          if (pipelinePanel) pipelinePanel.classList.add("hidden");
          // SHOW EDIT BUTTON IF ACTIVE
          document
            .getElementById("btn-edit-profile")
            .classList.remove("hidden");
        } else {
          if (pipelinePanel) pipelinePanel.classList.remove("hidden");
        }

        const badge = document.getElementById("p-status-badge");
        if (badge) {
          badge.textContent = data["Status"];
          badge.className = `px-3 py-1 rounded-full text-xs font-bold ${
            data["Status"] === "Active"
              ? "bg-green-100 text-green-700"
              : "bg-gray-100 text-gray-600"
          }`;
        }

        const emailBtn = document.getElementById("p-email-btn");
        if (emailBtn) emailBtn.href = "mailto:" + data["Email"];

        set("p-email", data["Email"]);
        set("p-phone", data["Phone"]);
        set(
          "p-address",
          `${data["Address"] || ""} ${data["Apt"] || ""}, ${
            data["City"] || ""
          } ${data["Zip"] || ""}`
        );
        set("p-dob", `${data["DOB"] || "--"} (${data["Gender"] || "--"})`);
        set("p-ssn", data["SSN"]);
        set(
          "p-banking",
          `Routing: ${data["Routing Number"] || "--"} | Account: ${
            data["Bank Account"] || "--"
          }`
        );
        set(
          "p-license",
          `Driver License: ${data["Driver License?"]} | License State: ${data["License State"]} | License #: ${data["License #"]}`
        );
        set(
          "p-car",
          `Has Car: ${data["Has Car?"]} | Model: ${data["Car Make/Model"]} | Insurance: ${data["Has Insurance?"]}`
        );
        set(
          "p-us-eligible",
          `US Eligible: ${data["US Eligible?"]} | US Citizen: ${data["US Citizen?"]}`
        );
        set(
          "p-reference-contact",
          `Reference 1: ${data["Reference 1"]} | Reference 2: ${data["Reference 2"]}`
        );
        set(
          "p-criminal-conviction",
          `Criminal Conviction: ${data["Criminal Conviction?"]} | Conviction Details: ${data["Conviction Details"]}`
        );

        // Stages
        let appStatus = data["App Status"];
        if (appStatus !== "Application Completed") {
          const created = new Date(data["Created At"]);
          const now = new Date();
          const diffDays = (now - created) / (1000 * 60 * 60 * 24);
          if (diffDays > 7) appStatus = "Missing";
        }
        updateStageUI(1, appStatus, "stage-text-1", null, "stage-icon-1", "");
        updateStageUI(
          2,
          data["Interview Status"],
          null,
          "stage-btn-2",
          "stage-icon-2",
          "Update"
        );
        updateStageUI(
          3,
          data["Background Check"],
          null,
          "stage-btn-3",
          "stage-icon-3",
          "Update"
        );

        // Last stage button logic
        const activeState =
          data["Status"] === "Active"
            ? "Done"
            : data["Status"] === "Inactive"
            ? "No"
            : "Pending";
        updateStageUI(
          4,
          activeState,
          null,
          "stage-btn-4",
          "stage-icon-4",
          "Activate"
        );

        const makeTags = (containerId, str) => {
          const div = document.getElementById(containerId);
          if (!div) return;
          div.innerHTML = "";
          if (!str) return;
          str
            .toString()
            .split(",")
            .forEach((s) => {
              const span = document.createElement("span");
              span.className =
                "bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded border border-gray-200";
              span.textContent = s.trim();
              div.appendChild(span);
            });
        };
        makeTags("p-certs", data["Certifications"]);
        makeTags("p-days", data["Schedule Desired"]);
        set("p-skills", data["Skills Checklist"]);
        set("p-langs", data["Languages"]);
        set(
          "p-highSchool",
          `High School: ${data["High School"]} | HS Degree: ${data["HS Degree"]}`
        );
        set(
          "p-college",
          `College: ${data["College"]} | Degree: ${data["College Degree"]}`
        );
        set(
          "p-otherEducation",
          `Other Education: ${data["Other Edu"]} | Degree: ${data["Other Degree"]}`
        );
        set(
          "p-emp",
          `Employer 1: ${data["Employer 1"]} | Employer 2: ${data["Employer 2"]} | Employer 3: ${data["Employer 3"]}`
        );
        set("p-hours", data["Hours Avail"]);
        set("p-times", data["Times Avail"]);
        set(
          "p-extra-avail",
          `Emerg: ${data["Emergency Avail?"]} | Live-In: ${data["Live-in Avail?"]}`
        );
        set("p-emergency-name", data["Emergency Contact"]);
        set(
          "p-emergency-contact",
          `${data["Emerg. Relation"]} - ${data["Emerg. Phone"]}`
        );

        // Signature Details
        set("p-signName", data["Signature Name"]);
        set(
          "p-signDate",
          data["Signature Date"]
            ? new Date(data["Signature Date"]).toLocaleDateString()
            : "--"
        );

        document.getElementById("profileLoading").classList.add("hidden");
        document.getElementById("profileContent").classList.remove("hidden");
      })
      .getCaregiverDetails(id);
  }

  function submitForm(e) {
    e.preventDefault();
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("caregiverForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Create & Send";
        if (res.success) {
          Swal.fire("Success", "Caregiver Added", "success");
          form.reset();
          switchCgView("list");
          loadCaregiverList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleCaregiverSubmission(data);
  }

  function loadDashboardStats() {
    google.script.run
      .withSuccessHandler((stats) => {
        document.getElementById("stat-total").textContent = stats.total;
        document.getElementById("stat-active").textContent = stats.active;
        document.getElementById("stat-inactive").textContent = stats.inactive;
        document.getElementById("stat-stna").textContent = stats.stna;
      })
      .getDashboardStats();
  }

  window.onload = function () {
    loadDashboardStats();
  };

  function switchClView(subView) {
    const list = document.getElementById("cl-subview-list");
    const add = document.getElementById("cl-subview-add");
    const profile = document.getElementById("cl-subview-profile");
    const edit = document.getElementById("cl-subview-edit");

    if (list) list.classList.add("hidden");
    if (add) add.classList.add("hidden");
    if (profile) profile.classList.add("hidden");
    if (edit) edit.classList.add("hidden");

    const target = document.getElementById("cl-subview-" + subView);
    if (target) target.classList.remove("hidden");
  }

  function loadClientList() {
    const tbody = document.getElementById("clTableBody");
    if (tbody)
      tbody.innerHTML =
        '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        clData = data;
        renderClTable();
      })
      .getClientList();
  }

  function renderClTable() {
    const searchEl = document.getElementById("clSearch");
    const statusEl = document.getElementById("clFilterStatus");
    const typeEl = document.getElementById("clFilterType");

    if (!searchEl) return;

    const search = searchEl.value.toLowerCase();
    const statusFilter = statusEl.value;
    const typeFilter = typeEl.value;

    const filtered = clData.filter((item) => {
      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search);
      const matchStatus =
        statusFilter === "All" || item.status === statusFilter;
      const matchType = typeFilter === "All" || item.type === typeFilter;
      return matchSearch && matchStatus && matchType;
    });

    const tbody = document.getElementById("clTableBody");
    tbody.innerHTML = "";

    if (filtered.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No clients found.</td></tr>';
      return;
    }

    filtered.forEach((row) => {
      let statusColor = "bg-gray-100 text-gray-600";
      if (row.status === "Active") statusColor = "bg-green-100 text-green-700";
      if (row.status === "Inactive") statusColor = "bg-red-100 text-red-700";
      if (row.status === "Cancelled service")
        statusColor = "bg-gray-200 text-gray-800";
      if (row.status === "Temporary hospital stay")
        statusColor = "bg-orange-100 text-orange-800";

      tbody.innerHTML += `
        <tr class="hover:bg-gray-50 border-b border-gray-50">
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4 text-sm text-gray-600">${row.type}</td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip || ""}</p>
            </div>
          </td>
          <td class="p-4 text-xs text-gray-500">${row.lastReviewed || "--"}</td>
          <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${
        row.status
      }</span></td>
          <td class="p-4 text-right">
             <button onclick="loadClientProfile('${
               row.id
             }')" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full hover:bg-green-100 font-bold border border-green-200 transition-colors">Details</button>
          </td>
        </tr>
      `;
    });
  }

  function submitClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("saveClientBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("clientForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Register Client & Send Email";
        if (res.success) {
          Swal.fire("Success", "Client Registered!", "success");
          form.reset();
          switchClView("list");
          loadClientList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleClientSubmission(data);
  }

  function loadClientProfile(id) {
    switchClView("profile");
    document.getElementById("clProfileLoading").classList.remove("hidden");
    document.getElementById("clProfileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        currentClientData = data;
        renderClientProfile(data);
      })
      .getClientDetails(id);
  }

  function renderClientProfile(data) {
    if (!data) return;

    // Helper to set text content safely
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = val || "--";
    };

    set(
      "cp-initials",
      (data.firstName?.[0] || "") + (data.lastName?.[0] || "")
    );
    set(
      "cp-name",
      `${data.firstName} ${data.middleName || ""} ${data.lastName}`
    );
    set("cp-id", data.id);
    set("cp-status", data.status);
    set("cp-email", data.email);
    set("cp-phone", data.phone);
    set(
      "cp-address",
      `${data.address || ""}, ${data.city || ""} ${data.zip || ""}`
    );

    // Format DOB
    let dob = data.dob;
    if (dob) {
      const d = new Date(dob);
      if (!isNaN(d.getTime())) {
        dob = d.toLocaleDateString();
      }
    }
    set("cp-dob", dob);

    set("cp-gender", data.gender);
    set("cp-type", data.type);
    set(
      "cp-living",
      data.livingAlone === "Yes" ? "Living Alone" : "Not Living Alone"
    );
    set("cp-languages", data.languages);

    set("cp-emName", data.emName);
    set("cp-emRel", data.emRel);
    set("cp-emPhone", data.emPhone);
    set("cp-emEmail", data.emEmail);
    set(
      "cp-emAddress",
      `${data.emAddress || ""}, ${data.emCity || ""} ${data.emZip || ""}`
    );

    document.getElementById("clProfileLoading").classList.add("hidden");
    document.getElementById("clProfileContent").classList.remove("hidden");
  }

  function editClientProfile() {
    if (!currentClientData) return;
    switchClView("edit");

    const d = currentClientData;
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val || "";
    };

    setVal("ce-id", d.id);
    setVal("ce-firstName", d.firstName);
    setVal("ce-middleName", d.middleName);
    setVal("ce-lastName", d.lastName);
    setVal("ce-status", d.status);

    // Format DOB for input[type="date"]
    let dob = "";
    if (d.dob) {
      const dateObj = new Date(d.dob);
      if (!isNaN(dateObj.getTime())) {
        dob = dateObj.toISOString().split("T")[0];
      }
    }
    setVal("ce-dob", dob);

    setVal("ce-gender", d.gender);
    setVal("ce-email", d.email);
    setVal("ce-phone", d.phone);
    setVal("ce-address", d.address);
    setVal("ce-city", d.city);
    setVal("ce-zip", d.zip);
    setVal("ce-type", d.type);
    setVal("ce-livingAlone", d.livingAlone);
    setVal("ce-languages", d.languages);
    setVal("ce-emName", d.emName);
    setVal("ce-emRel", d.emRel);
    setVal("ce-emEmail", d.emEmail);
    setVal("ce-emPhone", d.emPhone);
    setVal("ce-emAddress", d.emAddress);
    setVal("ce-emCity", d.emCity);
    setVal("ce-emZip", d.emZip);
  }

  function submitEditClientForm(e) {
    e.preventDefault();
    const btn = document.getElementById("updateClientBtn");
    btn.disabled = true;
    btn.textContent = "Updating...";

    const form = document.getElementById("clientEditForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Update Client";
        if (res.success) {
          Swal.fire("Success", "Client Updated!", "success");
          // Reload profile with new data
          loadClientProfile(data.id);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .updateClient(data);
  }

  // -- Caregiver Stages Logic --
  function loadCaregiverStages() {
    google.script.run
      .withSuccessHandler((data) => {
        cgData = data;
        renderCaregiverStages();
      })
      .getCaregiverList();
  }

  function renderCaregiverStages() {
    const stages = {
      new: [],
      interview: [],
      background: [],
      active: [],
    };

    cgData.forEach((cg) => {
      // Stage 4: Active / Inactive / No call / Vacation
      // Condition: Status is one of the final states.
      if (["Active", "Inactive", "No call", "Vacation"].includes(cg.status)) {
        stages.active.push(cg);
      }
      // Stage 3: Passed Background Check
      // Condition: Interview Passed, but not yet Active
      else if (cg.interviewStatus === "Passed") {
        stages.background.push(cg);
      }
      // Stage 2: Interview Completed
      // Condition: App Completed
      else if (cg.appStatus === "Application Completed") {
        stages.interview.push(cg);
      }
      // Stage 1: New Application
      // Condition: Pending OR Applicant
      else if (
        cg.appStatus === "Pending Application" ||
        cg.status === "Applicant"
      ) {
        stages.new.push(cg);
      }
    });

    renderStageList("new", stages.new);
    renderStageList("interview", stages.interview);
    renderStageList("background", stages.background);
    renderStageList("active", stages.active);

    document.getElementById("count-stage-new").textContent = stages.new.length;
    document.getElementById("count-stage-interview").textContent =
      stages.interview.length;
    document.getElementById("count-stage-background").textContent =
      stages.background.length;
    document.getElementById("count-stage-active").textContent =
      stages.active.length;
  }

  function renderStageList(stage, list) {
    const tbody = document.getElementById(`list-stage-${stage}`);
    tbody.innerHTML = "";

    if (list.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="3" class="p-4 text-center text-gray-400">No caregivers in this stage.</td></tr>';
      return;
    }

    list.forEach((cg) => {
      let actionHtml = "";
      if (stage === "new") {
        actionHtml = `
              <div class="flex justify-end items-center gap-2">
                <span class="text-xs text-gray-400 italic mr-2">Waiting for submission...</span>
                <button onclick="resendEmail('${cg.id}')" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-100 font-bold border border-blue-200 transition-colors flex items-center gap-1">
                  <i class="ph ph-paper-plane-right"></i> Resend Email
                </button>
              </div>`;
      } else if (stage === "interview") {
        const viewDetailsBtn = `<button onclick="openProfile('${cg.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 mr-2 flex items-center gap-1"><i class="ph ph-eye"></i> View Details</button>`;
        const rejectBtn = `<button onclick="sendRejectionEmail('${cg.id}')" class="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full hover:bg-red-100 font-bold border border-red-200 mr-2 flex items-center gap-1" title="Send Rejection Email"><i class="ph ph-x-circle"></i> Reject</button>`;

        // If already passed/failed, show status, else show buttons
        if (cg.interviewStatus === "Passed") {
          actionHtml = `${viewDetailsBtn} <span class="text-xs text-green-600 font-bold mr-2">Passed</span> <button onclick="updateStageStatus('${cg.id}', 'Background', 'Pending')" class="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full hover:bg-purple-200 font-bold">Start Background Check</button>`;
        } else if (cg.interviewStatus === "Failed") {
          actionHtml = `${viewDetailsBtn} <span class="text-xs text-red-600 font-bold mr-2">Interview Failed</span> <button onclick="updateStageStatus('${cg.id}', 'Interview', 'Pending')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 flex items-center gap-1"><i class="ph ph-arrow-u-up-left"></i> Undo</button>`;
        } else {
          actionHtml = `
                    <div class="flex justify-end gap-2 items-center">
                        ${viewDetailsBtn}
                        ${rejectBtn}
                        <button onclick="updateStageStatus('${cg.id}', 'Interview', 'Passed')" class="text-xs bg-green-100 text-green-600 px-3 py-1 rounded-full hover:bg-green-200 font-bold">Pass</button>
                        <button onclick="updateStageStatus('${cg.id}', 'Interview', 'Failed')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full hover:bg-red-200 font-bold">Fail</button>
                    </div>`;
        }
      } else if (stage === "background") {
        let docsHtml = "";
        if (cg.contractLink)
          docsHtml += `<a href="${cg.contractLink}" target="_blank" class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded border border-gray-200 hover:bg-gray-100 mr-1 flex items-center gap-1" title="View Contract"><i class="ph ph-file-text"></i> Contract</a>`;
        if (cg.w9Link)
          docsHtml += `<a href="${cg.w9Link}" target="_blank" class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded border border-gray-200 hover:bg-gray-100 mr-1 flex items-center gap-1" title="View W9"><i class="ph ph-file-text"></i> W9</a>`;
        if (cg.backgroundLink)
          docsHtml += `<a href="${cg.backgroundLink}" target="_blank" class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded border border-gray-200 hover:bg-gray-100 mr-1 flex items-center gap-1" title="View Background"><i class="ph ph-file-text"></i> Background</a>`;

        // Hide "Send Consent" if Background Link exists (Consent Form submitted)
        // or if all docs are submitted. Let's use backgroundLink as the main indicator for "Consent".
        const showSendConsent = !cg.backgroundLink;

        if (cg.backgroundCheck === "Passed") {
          actionHtml = `<div class="flex items-center justify-end gap-2">${docsHtml} <span class="text-xs text-green-600 font-bold mr-2">Passed</span> <button onclick="updateStageStatus('${cg.id}', 'Active', 'Active')" class="text-xs bg-green-100 text-green-600 px-3 py-1 rounded-full hover:bg-green-200 font-bold">Activate Caregiver</button></div>`;
        } else if (cg.backgroundCheck === "Failed") {
          actionHtml = `<div class="flex items-center justify-end gap-2">${docsHtml} <span class="text-xs text-red-600 font-bold mr-2">Background Check Failed</span> <button onclick="updateStageStatus('${cg.id}', 'Background', 'Pending')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 flex items-center gap-1"><i class="ph ph-arrow-u-up-left"></i> Undo</button></div>`;
        } else {
          actionHtml = `
                    <div class="flex justify-end gap-2 items-center">
                        ${docsHtml}
                        <button onclick="updateStageStatus('${
                          cg.id
                        }', 'Interview', 'Pending')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 font-bold border border-gray-200 mr-2 flex items-center gap-1" title="Return to Interview Stage">
                            <i class="ph ph-arrow-u-up-left"></i> Undo
                        </button>
                        ${
                          showSendConsent
                            ? `<button onclick="sendOnboardingEmail('${cg.id}')" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-100 font-bold border border-blue-200 transition-colors flex items-center gap-1 mr-2">
                          <i class="ph ph-envelope-simple"></i> Send Consent
                        </button>`
                            : ""
                        }
                        <button onclick="updateStageStatus('${
                          cg.id
                        }', 'Background', 'Passed')" class="text-xs bg-green-100 text-green-600 px-3 py-1 rounded-full hover:bg-green-200 font-bold">Pass</button>
                        <button onclick="updateStageStatus('${
                          cg.id
                        }', 'Background', 'Failed')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full hover:bg-red-200 font-bold">Fail</button>
                    </div>`;
        }
      } else if (stage === "active") {
        let statusColor = "bg-gray-100 text-gray-700";
        if (cg.status === "Active") statusColor = "bg-green-100 text-green-700";
        else if (cg.status === "Inactive")
          statusColor = "bg-red-100 text-red-700";
        else if (cg.status === "No call")
          statusColor = "bg-yellow-100 text-yellow-700";
        else if (cg.status === "Vacation")
          statusColor = "bg-blue-100 text-blue-700";

        actionHtml = `<span class="text-xs ${statusColor} px-2 py-1 rounded font-bold">${cg.status}</span>`;
      }

      tbody.innerHTML += `
            <tr class="hover:bg-gray-50">
                <td class="p-3 font-medium text-gray-700">
                    <div>${cg.name}</div>
                    <div class="text-xs text-gray-400">${cg.id}</div>
                </td>
                <td class="p-3 text-gray-500 text-xs">
                    ${
                      stage === "interview"
                        ? cg.interviewStatus
                        : stage === "background"
                        ? cg.backgroundCheck
                        : cg.status
                    }
                </td>
                <td class="p-3 text-right">${actionHtml}</td>
            </tr>
        `;
    });
  }

  function toggleStage(stageId) {
    const content = document.getElementById(`content-${stageId}`);
    const icon = document.getElementById(`icon-${stageId}`);
    content.classList.toggle("hidden");
    icon.classList.toggle("rotate-180");
  }

  function updateStageStatus(id, stage, value) {
    // Optimistic update or wait? Let's wait for simplicity.
    google.script.run
      .withSuccessHandler(() => {
        // If we passed interview, we might want to auto-trigger next step or just reload
        // If we passed background, we might want to auto-trigger active

        // For better UX, let's just reload the list
        loadCaregiverStages();
      })
      .updateCaregiverStage(id, stage, value);
  }

  function downloadPdf(id, btn) {
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> ...';

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (res.success) {
          // Create a link and trigger download
          const link = document.createElement("a");
          link.href = "data:application/pdf;base64," + res.base64;
          link.download = res.filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .withFailureHandler((err) => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        Swal.fire("Error", err.message, "error");
      })
      .generateCaregiverPdf(id);
  }

  function resendEmail(id) {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Sending...';

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (res.success) {
          Swal.fire("Success", "Application email resent!", "success");
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .resendCaregiverEmail(id);
  }

  function sendOnboardingEmail(id) {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Sending...';

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (res.success) {
          Swal.fire("Success", "Onboarding email sent!", "success");
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .sendOnboardingEmail(id);
  }

  function sendRejectionEmail(id) {
    Swal.fire({
      title: "Send Rejection Email?",
      text: "This will send a rejection email to the caregiver.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, send it!",
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: "Sending...",
          text: "Please wait while we send the email.",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              Swal.fire("Sent!", "Rejection email has been sent.", "success");
            } else {
              Swal.fire("Error", res.message, "error");
            }
          })
          .sendRejectionEmail(id);
      }
    });
  }

  // -- Communication Logic --
  function loadCommunicationView() {
    // Load Caregivers
    const cgList = document.getElementById("comm-cg-list");
    cgList.innerHTML =
      '<div class="text-xs text-gray-400 text-center py-4">Loading...</div>';
    google.script.run
      .withSuccessHandler((data) => {
        renderCommList(data, "comm-cg-list", "cg");
      })
      .getCaregiverList();

    // Load Clients
    const clList = document.getElementById("comm-cl-list");
    clList.innerHTML =
      '<div class="text-xs text-gray-400 text-center py-4">Loading...</div>';
    google.script.run
      .withSuccessHandler((data) => {
        renderCommList(data, "comm-cl-list", "cl");
      })
      .getClientList();
  }

  function renderCommList(data, containerId, prefix) {
    const container = document.getElementById(containerId);
    if (!data || data.length === 0) {
      container.innerHTML =
        '<div class="text-xs text-gray-400 text-center py-4">No records found.</div>';
      return;
    }

    let html = "";
    data.forEach((item) => {
      // Only show items with email
      if (item.email && item.email.includes("@")) {
        html += `
          <label class="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer group">
            <input type="checkbox" name="${prefix}_ids" value="${item.id}" class="w-4 h-4 text-[#65c027] rounded border-gray-300 focus:ring-[#65c027]">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-700 truncate group-hover:text-[#65c027]">${item.name}</p>
              <p class="text-xs text-gray-400 truncate">${item.email}</p>
            </div>
          </label>
        `;
      }
    });
    container.innerHTML =
      html ||
      '<div class="text-xs text-gray-400 text-center py-4">No valid emails found.</div>';
  }

  function filterCommList(input, listId) {
    const filter = input.value.toLowerCase();
    const list = document.getElementById(listId);
    const labels = list.getElementsByTagName("label");

    for (let i = 0; i < labels.length; i++) {
      const text = labels[i].textContent.toLowerCase();
      if (text.includes(filter)) {
        labels[i].style.display = "";
      } else {
        labels[i].style.display = "none";
      }
    }
  }

  function toggleAll(listId) {
    const list = document.getElementById(listId);
    const checkboxes = list.querySelectorAll('input[type="checkbox"]');
    // Check if all visible are checked
    const visible = Array.from(checkboxes).filter(
      (cb) => cb.closest("label").style.display !== "none"
    );
    const allChecked = visible.every((cb) => cb.checked);

    visible.forEach((cb) => (cb.checked = !allChecked));
  }

  function sendCommunication(e) {
    e.preventDefault();
    const btn = document.getElementById("btnSendComm");
    const originalText = btn.innerHTML;

    const form = document.getElementById("commForm");
    const formData = new FormData(form);
    const subject = formData.get("subject");
    const message = formData.get("message");

    // Gather IDs
    const cgIds = Array.from(
      document.querySelectorAll('input[name="cg_ids"]:checked')
    ).map((cb) => cb.value);
    const clIds = Array.from(
      document.querySelectorAll('input[name="cl_ids"]:checked')
    ).map((cb) => cb.value);

    if (cgIds.length === 0 && clIds.length === 0) {
      Swal.fire("Error", "Please select at least one recipient", "warning");
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Sending...';

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (res.success) {
          Swal.fire("Success", `Sent to ${res.count} recipients!`, "success");
          form.reset();
          // Uncheck all
          document
            .querySelectorAll('input[type="checkbox"]')
            .forEach((cb) => (cb.checked = false));
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .sendCustomEmail(cgIds, clIds, subject, message);
  }

  // -- Shift Management Logic --

  function loadShiftView() {
    // Load Clients
    const clientSelect = document.getElementById("shiftClient");
    clientSelect.innerHTML = '<option value="">Loading...</option>';
    google.script.run
      .withSuccessHandler((data) => {
        let html = '<option value="">Select Client...</option>';
        data.forEach((item) => {
          html += `<option value="${item.id}">${item.name}</option>`;
        });
        clientSelect.innerHTML = html;
      })
      .getClientList();

    // Load Caregivers
    const cgSelect = document.getElementById("shiftCaregiver");
    cgSelect.innerHTML = '<option value="">Loading...</option>';
    google.script.run
      .withSuccessHandler((data) => {
        let html = '<option value="">Select Caregiver...</option>';
        data.forEach((item) => {
          html += `<option value="${item.id}">${item.name}</option>`;
        });
        cgSelect.innerHTML = html;
      })
      .getCaregiverList();
  }

  function calculateShiftHours() {
    const clockIn = document.getElementById("clockIn").value;
    const clockOut = document.getElementById("clockOut").value;
    const hoursInput = document.getElementById("shiftHours");

    if (clockIn && clockOut) {
      const start = new Date(`1970-01-01T${clockIn}:00`);
      const end = new Date(`1970-01-01T${clockOut}:00`);

      let diff = (end - start) / 1000 / 60 / 60; // hours
      if (diff < 0) diff += 24; // Handle overnight

      hoursInput.value = diff.toFixed(2);
      calculateShiftCosts(); // Recalculate costs when hours change
    }
  }

  function calculateShiftCosts() {
    const billingType = document.getElementById("billingType").value;
    const hours = parseFloat(document.getElementById("shiftHours").value) || 0;
    const clientRate =
      parseFloat(document.getElementById("clientRate").value) || 0;
    const caregiverRate =
      parseFloat(document.getElementById("caregiverRate").value) || 0;

    // Calculate Agency & Softcare Share
    // Logic: (Client Rate - Caregiver Rate) split 80% Agency, 20% Softcare
    const margin = Math.max(0, clientRate - caregiverRate);
    const agency = margin * 0.8;
    const softcare = margin * 0.2;

    document.getElementById("agencyShare").value = agency.toFixed(2);
    document.getElementById("softcareShare").value = softcare.toFixed(2);

    // Calculate Totals
    let totalClient = 0;
    let totalCaregiver = 0;
    let totalAgency = 0;
    let totalSoftcare = 0;

    if (billingType === "Hourly") {
      totalClient = clientRate * hours;
      totalCaregiver = caregiverRate * hours;
      totalAgency = agency * hours;
      totalSoftcare = softcare * hours;
    } else {
      // Fixed Rate
      totalClient = clientRate;
      totalCaregiver = caregiverRate;
      totalAgency = agency;
      totalSoftcare = softcare;
    }

    document.getElementById("totalClientPrice").value =
      "$" + totalClient.toFixed(2);
    document.getElementById("totalCaregiverPrice").value =
      "$" + totalCaregiver.toFixed(2);
    document.getElementById("totalAgencyPrice").value =
      "$" + totalAgency.toFixed(2);
    document.getElementById("totalSoftcarePrice").value =
      "$" + totalSoftcare.toFixed(2);
  }

  function submitShift(e) {
    e.preventDefault();
    const btn = document.getElementById("btnSaveShift");
    const originalText = btn.innerHTML;

    const form = document.getElementById("shiftForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Add calculated values
    data.agencyShare = document.getElementById("agencyShare").value;
    data.softcareShare = document.getElementById("softcareShare").value;
    data.totalClientPrice = document
      .getElementById("totalClientPrice")
      .value.replace("$", "");
    data.totalCaregiverPrice = document
      .getElementById("totalCaregiverPrice")
      .value.replace("$", "");
    data.totalAgencyPrice = document
      .getElementById("totalAgencyPrice")
      .value.replace("$", "");
    data.totalSoftcarePrice = document
      .getElementById("totalSoftcarePrice")
      .value.replace("$", "");

    btn.disabled = true;
    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Saving...';

    google.script.run
      .withSuccessHandler(() => {
        Swal.fire("Success", "Shift saved successfully!", "success");
        form.reset();
        document.getElementById("totalClientPrice").value = "$0.00";
        document.getElementById("totalCaregiverPrice").value = "$0.00";
        document.getElementById("totalAgencyPrice").value = "$0.00";
        document.getElementById("totalSoftcarePrice").value = "$0.00";
        btn.disabled = false;
        btn.innerHTML = originalText;
      })
      .withFailureHandler((err) => {
        Swal.fire("Error", "Failed to save shift: " + err.message, "error");
        btn.disabled = false;
        btn.innerHTML = originalText;
      })
      .saveShift(data);
  }

  // --- CAREGIVER CALENDAR LOGIC ---
  let currentCalendarDate = new Date();
  let currentMiniMonthDate = new Date();

  function loadCaregiverCalendar() {
    renderWeekCalendar();
    renderMiniMonthCalendar();
  }

  function changeWeek(offset) {
    currentCalendarDate.setDate(currentCalendarDate.getDate() + offset * 7);
    renderWeekCalendar();
  }

  function changeMiniMonth(offset) {
    currentMiniMonthDate.setMonth(currentMiniMonthDate.getMonth() + offset);
    renderMiniMonthCalendar();
  }

  function renderWeekCalendar() {
    const grid = document.getElementById("weekGrid");
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    // Calculate start of week (Sunday)
    const startOfWeek = new Date(currentCalendarDate);
    const day = startOfWeek.getDay();
    const diff = startOfWeek.getDate() - day;
    startOfWeek.setDate(diff);

    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    // Update Label
    const options = { month: "short", day: "numeric" };
    const label = `${startOfWeek.toLocaleDateString(
      "en-US",
      options
    )} - ${endOfWeek.toLocaleDateString("en-US", {
      ...options,
      year: "numeric",
    })}`;
    document.getElementById("currentWeekLabel").textContent = label;

    // Fetch Shifts
    const startStr = startOfWeek.toISOString().split("T")[0];
    const endStr = endOfWeek.toISOString().split("T")[0];

    google.script.run
      .withSuccessHandler((shifts) => {
        grid.innerHTML = "";

        // Generate 7 columns
        for (let i = 0; i < 7; i++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + i);
          const dateStr = currentDay.toISOString().split("T")[0];

          const isToday =
            new Date().toDateString() === currentDay.toDateString();

          const col = document.createElement("div");
          col.className = `border-r border-gray-100 min-h-[400px] flex flex-col ${
            isToday ? "bg-blue-50/30" : ""
          }`;

          // Date Header
          col.innerHTML = `
          <div class="p-2 text-center border-b border-gray-100 ${
            isToday ? "bg-blue-50 text-blue-600" : ""
          }">
            <span class="text-lg font-bold block">${currentDay.getDate()}</span>
          </div>
          <div class="flex-1 p-2 space-y-2" id="day-${dateStr}"></div>
        `;
          grid.appendChild(col);

          // Add Shifts
          const dayShifts = shifts.filter((s) => s.date === dateStr);
          const container = col.querySelector(`#day-${dateStr}`);

          dayShifts.forEach((s) => {
            // Find names from global data if available, else use ID
            const cg = cgData.find((c) => c.id === s.caregiverId);
            const cl = clData.find((c) => c.id === s.clientId);
            const cgName = cg ? cg.name : s.caregiverId;
            const clName = cl ? cl.firstName + " " + cl.lastName : s.clientId;

            const card = document.createElement("div");
            card.className =
              "bg-white p-2 rounded border border-l-4 border-l-[#65c027] shadow-sm text-xs hover:shadow-md transition cursor-pointer";
            card.innerHTML = `
             <div class="font-bold text-gray-700 truncate">${clName}</div>
             <div class="text-gray-500 truncate">${cgName}</div>
             <div class="mt-1 flex justify-between text-[10px] text-gray-400">
               <span>${s.clockIn} - ${s.clockOut}</span>
             </div>
           `;
            container.appendChild(card);
          });
        }
      })
      .getShifts(startStr, endStr);
  }

  function renderMiniMonthCalendar() {
    const grid = document.getElementById("miniMonthGrid");
    grid.innerHTML = "";

    const year = currentMiniMonthDate.getFullYear();
    const month = currentMiniMonthDate.getMonth();

    document.getElementById("miniMonthLabel").textContent =
      currentMiniMonthDate.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric",
      });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Empty cells for start padding
    for (let i = 0; i < firstDay.getDay(); i++) {
      grid.appendChild(document.createElement("div"));
    }

    // Days
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const d = new Date(year, month, i);
      const isToday = new Date().toDateString() === d.toDateString();

      const cell = document.createElement("div");
      cell.className = `p-1 rounded-full cursor-pointer hover:bg-gray-100 ${
        isToday ? "bg-[#65c027] text-white font-bold" : "text-gray-700"
      }`;
      cell.textContent = i;
      cell.onclick = () => {
        currentCalendarDate = new Date(year, month, i);
        renderWeekCalendar();
      };
      grid.appendChild(cell);
    }
  }
</script>
