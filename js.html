<script>
  let currentPage = 1;
  let totalItems = 0;
  const PAGE_SIZE = 10;
  let searchTimeout;

  // Shift Data Store
  let shiftData = { clients: [], caregivers: [] };

  // --- CONSTANTS ---
  const LANGUAGES = ["ENGLISH", "ARABIC", "FRENCH", "ARMENIAN", "CHINESE", "CREOLE", "GEORGIAN", "GERMAN", "GREEK", "HINDI", "ITALIAN", "RUSSIAN", "SIGN LANGUAGE", "SPANISH", "SWAHILI", "TWI", "UKRAINIAN", "OTHER"];
  const SKILLS = ["Ambulation", "Bathing – Bed", "Bathing-Shower", "Catheter Care", "Companion Care", "Dressing", "Feeding", "Homemaker Services", "Hygiene – Hair Care", "Hygiene-Mouth Care", "Incontinence Care", "Meal Preparation", "Medication Reminders", "Ostomy Care", "Respite Care (General)", "Respite Care (Skilled Nursing)", "Safety Supervision", "Shave", "Toileting", "Transportation", "Turning & Repositioning", "Wound Care"];

  // --- INIT ---
  window.onload = function() {
    populateDropdowns();
    loadStats();
    
    const rptAcc = document.getElementById('repeatAccount');
    const rptRout = document.getElementById('repeatRouting');
    if(rptAcc) rptAcc.addEventListener('input', validateBank);
    if(rptRout) rptRout.addEventListener('input', validateBank);
  };

  function populateDropdowns() {
    const fill = (names, list) => {
      names.forEach(name => {
        const els = document.getElementsByName(name);
        els.forEach(el => {
          let opts = '<option value="">Select...</option>';
          list.forEach(item => opts += `<option value="${item}">${item}</option>`);
          el.innerHTML = opts;
        });
      });
    };
    fill(['lang1', 'lang2', 'lang3'], LANGUAGES);
    fill(['skill1', 'skill2', 'skill3', 'skill4', 'skill5', 'skill6'], SKILLS);
  }

  // --- NAVIGATION ---
  function showPage(pageId) {
    document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

    const page = document.getElementById(pageId);
    if(page) page.classList.remove('hidden');
    
    if(pageId === 'page-dashboard') {
       document.getElementById('nav-dashboard').classList.add('active');
       loadStats();
    }
    // Shift Page Logic
    if(pageId === 'page-shift-add') {
       document.getElementById('nav-shift-add').classList.add('active');
       initShiftPage();
    }
    // CLIENT PAGES
    else if(pageId === 'page-client-add') {
       document.getElementById('nav-client-add').classList.add('active');
       resetClientForm();
    } 
    else if(pageId === 'page-client-dir') {
       document.getElementById('nav-client-dir').classList.add('active');
       loadClientDir(1);
    }
    // CAREGIVER PAGES
    else if(pageId === 'page-cg-add') {
       document.getElementById('nav-cg-add').classList.add('active');
       resetCgForm();
    } 
    else if(pageId === 'page-cg-dir') {
       document.getElementById('nav-cg-dir').classList.add('active');
       loadCgDir(1);
    }
  }

  //  SHIFT & MATCHING LOGIC
  function initShiftPage() {
    // 1. Reset Form
    document.getElementById('shiftForm').reset();
    document.getElementById('match-message-box').className = "mt-4 p-4 rounded text-center font-bold text-sm bg-gray-50 text-gray-500";
    document.getElementById('match-message-box').innerText = "Select both Client and Caregiver to check compatibility.";
    
    // Clear Match Table
    ['pets', 'smoke', 'drink'].forEach(k => {
       document.getElementById(`match-client-${k}`).innerText = '-';
       document.getElementById(`match-cg-${k}`).innerText = '-';
       document.getElementById(`res-${k}`).innerHTML = '<span class="text-gray-300">--</span>';
    });

    // 2. Fetch Data
    loading(true);
    google.script.run.withSuccessHandler(data => {
       loading(false);
       shiftData = data; // Store globally
       
       // Populate Selectors
       const cSelect = document.getElementById('shiftClientSelect');
       cSelect.innerHTML = '<option value="">Select Client...</option>';
       data.clients.forEach((c, i) => cSelect.innerHTML += `<option value="${i}">${c.name} (${c.code})</option>`);

       const cgSelect = document.getElementById('shiftCgSelect');
       cgSelect.innerHTML = '<option value="">Select Caregiver...</option>';
       data.caregivers.forEach((c, i) => cgSelect.innerHTML += `<option value="${i}">${c.name} (${c.code})</option>`);
       
       // Set Invoice
       document.getElementById('invoiceId').value = data.nextInvoice;

    }).getShiftDropdownData();
  }

  function onShiftClientSelect() {
    const idx = document.getElementById('shiftClientSelect').value;
    if(idx === "") return;
    const c = shiftData.clients[idx];
    
    document.getElementById('dispClientCode').value = c.code;
    document.getElementById('dispClientFirst').value = c.firstName;
    document.getElementById('dispClientLast').value = c.lastName;
    document.getElementById('hClientName').value = c.name;
    
    // Fill Match Table
    document.getElementById('match-client-pets').innerText = c.pets || 'No';
    document.getElementById('match-client-smoke').innerText = c.smoke || 'No';
    document.getElementById('match-client-drink').innerText = c.drink || 'No';
    
    checkMatching();
  }

  function onShiftCgSelect() {
    const idx = document.getElementById('shiftCgSelect').value;
    if(idx === "") return;
    const c = shiftData.caregivers[idx];
    
    document.getElementById('dispCgCode').value = c.code;
    document.getElementById('dispCgFirst').value = c.firstName;
    document.getElementById('dispCgLast').value = c.lastName;
    document.getElementById('hCgName').value = c.name;

    // Fill Match Table
    document.getElementById('match-cg-pets').innerText = c.pets || 'No'; // This is 'Pets Pref'
    document.getElementById('match-cg-smoke').innerText = c.smoke || 'No';
    document.getElementById('match-cg-drink').innerText = c.drink || 'No';
    
    checkMatching();
  }

  function checkMatching() {
    const idxC = document.getElementById('shiftClientSelect').value;
    const idxG = document.getElementById('shiftCgSelect').value;
    
    if(idxC === "" || idxG === "") return;

    const client = shiftData.clients[idxC];
    const cg = shiftData.caregivers[idxG];
    
    let isMatch = true;
    
    const compare = (cVal, gVal, id) => {
       // Normalize
       const c = (cVal || '').toLowerCase();
       const g = (gVal || '').toLowerCase();
       
       let rowMatch = true;    
       
       if (c === 'yes' && g === 'no') rowMatch = false;
       
       const cell = document.getElementById(id);
       if(rowMatch) {
         cell.innerHTML = '<i class="ph ph-check-circle text-green-500 text-xl"></i>';
       } else {
         cell.innerHTML = '<i class="ph ph-x-circle text-red-500 text-xl"></i>';
         isMatch = false;
       }
    };

    compare(client.pets, cg.pets, 'res-pets');
    compare(client.smoke, cg.smoke, 'res-smoke');
    compare(client.drink, cg.drink, 'res-drink');

    const msgBox = document.getElementById('match-message-box');
    const msgInput = document.getElementById('matchNotes');
    
    if(isMatch) {
      msgBox.className = "mt-4 p-4 rounded text-center font-bold text-sm bg-green-100 text-green-700 border border-green-200";
      msgBox.innerHTML = "<i class='ph ph-thumbs-up mr-2'></i> They are matching!";
      msgInput.value = "Matching";
    } else {
      msgBox.className = "mt-4 p-4 rounded text-center font-bold text-sm bg-red-100 text-red-700 border border-red-200";
      msgBox.innerHTML = "<i class='ph ph-warning mr-2'></i> Please search other caregiver.";
      msgInput.value = "Not Matching";
    }
  }

  function calcShiftHours() {
    const inTime = document.getElementById('clockIn').value;
    const outTime = document.getElementById('clockOut').value;
    
    if(inTime && outTime) {
      const d1 = new Date("01/01/2000 " + inTime);
      const d2 = new Date("01/01/2000 " + outTime);
      
      let diff = (d2 - d1) / 1000 / 60 / 60; // Hours
      if (diff < 0) diff += 24; // Handle overnight
      
      document.getElementById('totalHours').value = diff.toFixed(2);
      calcFinancials();
    }
  }

  function calcFinancials() {
    const rateType = document.querySelector('input[name="rateType"]:checked').value;
    const hours = parseFloat(document.getElementById('totalHours').value) || 0;
    const cRate = parseFloat(document.getElementById('clientRate').value) || 0;
    const gRate = parseFloat(document.getElementById('cgRate').value) || 0;
    
    let totalC = 0;
    let totalG = 0;

    if (rateType === 'Fixed') {
      totalC = cRate;
      totalG = gRate;
    } else {
      totalC = cRate * hours;
      totalG = gRate * hours;
    }

    document.getElementById('totalClientAmt').value = totalC.toFixed(2);
    document.getElementById('totalCgAmt').value = totalG.toFixed(2);
    document.getElementById('profit').value = (totalC - totalG).toFixed(2);
  }

  function submitShiftForm(e) {
    e.preventDefault();
    loading(true);
    const form = document.getElementById('shiftForm');
    const fd = {};
    new FormData(form).forEach((v,k) => fd[k] = v);
    
    google.script.run.withSuccessHandler(res => {
       loading(false);
       alert(res.message);
       if(res.success) {
         initShiftPage(); // Reset for next
       }
    }).saveShiftData(fd);
  }

  // --- CLIENT LOGIC ---

  function resetClientForm() {
    document.getElementById('clientForm').reset();
    document.getElementById('clientCode').value = '';
    document.getElementById('client-form-title').innerText = 'Add Client Details';
    document.getElementById('btn-client-pdf').classList.add('hidden');
    const dateEl = document.getElementById('clientActiveDate');
    if(dateEl) dateEl.valueAsDate = new Date();
  }
  
  // Updated Load Logic with Filters
  function loadClientDir(page) {
    currentPage = page;
    const search = document.getElementById('client-search').value;
    const status = document.getElementById('client-status-filter').value;
    const pay = document.getElementById('client-pay-filter').value;
    
    loading(true);
    google.script.run
      .withSuccessHandler(renderClientTable)
      .withFailureHandler(handleError)
      .getClients(page, PAGE_SIZE, search, status, pay);
  }

  function renderClientTable(data) {
     loading(false);
     const tbody = document.getElementById('client-body');
     tbody.innerHTML = '';
     totalItems = data.total;
     
     if(data.clients.length === 0) { 
       tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">No clients found.</td></tr>'; 
     } else {
       data.clients.forEach(c => {
         const tr = document.createElement('tr');
         tr.className = 'table-row';
         tr.onclick = () => openClient(c.code);
         let statusClass = c.status === 'Active' ? 'text-green-700 bg-green-50' : 'text-gray-600 bg-gray-50';
         tr.innerHTML = `
           <td class="table-cell font-mono text-xs">${c.code}</td>
           <td class="table-cell font-bold">${c.name}</td>
           <td class="table-cell"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${c.status}</span></td>
           <td class="table-cell">${c.payment}</td>
           <td class="table-cell text-xs">${c.phone}</td>
           <td class="table-cell text-xs text-gray-500">${c.email}</td>
           <td class="table-cell text-right"><i class="ph ph-caret-right text-gray-400"></i></td>
         `;
         tbody.appendChild(tr);
       });
     }
     
     // Update Pagination
     updatePagination('client', totalItems);
  }

  function openClient(code) {
    loading(true);
    google.script.run.withSuccessHandler(data => {
      loading(false);
      if(!data) return alert('Client not found');
      showPage('page-client-add');
      document.getElementById('client-form-title').innerText = 'Edit Client: ' + data.firstName;
      document.getElementById('btn-client-pdf').classList.remove('hidden');
      const form = document.getElementById('clientForm');
      Object.keys(data).forEach(key => {
        const input = form.elements[key];
        if(input) {
           if(input.type === 'checkbox') input.checked = data[key] === true || data[key] === 'true';
           else input.value = data[key];
        }
      });
    }).getClientDetails(code);
  }

  function submitClientForm(e) {
    e.preventDefault();
    loading(true);
    const form = document.getElementById('clientForm');
    const formData = {};
    new FormData(form).forEach((v,k) => formData[k] = v);
    google.script.run.withSuccessHandler(res => {
      loading(false);
      alert(res.message);
      if(res.success) showPage('page-client-dir');
    }).saveClientData(formData);
  }

  function downloadClientPdf() {
     const code = document.getElementById('clientCode').value;
     if(!code) return alert('Please save before exporting.');
     loading(true);
     google.script.run.withSuccessHandler(pdf => {
        loading(false);
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + pdf.base64;
        link.download = pdf.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
     }).exportClientToPdf(code);
  }

  // --- CAREGIVER LOGIC ---

  function resetCgForm() {
    document.getElementById('cgForm').reset();
    document.getElementById('cgCode').value = '';
    document.getElementById('cg-form-title').innerText = 'Add Caregiver Details';
    document.getElementById('btn-cg-pdf').classList.add('hidden');
    document.getElementById('bank-errors').innerHTML = '';
    const dateEl = document.getElementById('cgActiveDate');
    if(dateEl) dateEl.valueAsDate = new Date();
  }

  function validateBank() {
    const acc = document.getElementsByName('accountNum')[0].value;
    const rptAcc = document.getElementById('repeatAccount').value;
    const rout = document.getElementsByName('routingNum')[0].value;
    const rptRout = document.getElementById('repeatRouting').value;
    const errDiv = document.getElementById('bank-errors');
    errDiv.innerHTML = '';
    if(acc && rptAcc && acc !== rptAcc) errDiv.innerHTML += '<p class="text-red-500 text-xs font-bold">Account Numbers do not match.</p>';
    if(rout && rptRout && rout !== rptRout) errDiv.innerHTML += '<p class="text-red-500 text-xs font-bold">Routing Numbers do not match.</p>';
  }

  function submitCgForm(e) {
    e.preventDefault();
    const errs = document.getElementById('bank-errors').innerHTML;
    if(errs !== '') { alert('Please fix bank account errors.'); return; }
    loading(true);
    const form = document.getElementById('cgForm');
    const fd = {};
    new FormData(form).forEach((v,k) => fd[k] = v);
    google.script.run.withSuccessHandler(res => {
      loading(false);
      alert(res.message);
      if(res.success) showPage('page-cg-dir');
    }).saveCaregiverData(fd);
  }

  function loadCgDir(page) {
    currentPage = page;
    const search = document.getElementById('cg-search').value;
    const status = document.getElementById('cg-status-filter').value;
    const title = document.getElementById('cg-title-filter').value;
    
    loading(true);
    google.script.run
      .withSuccessHandler(renderCgTable)
      .withFailureHandler(handleError)
      .getCaregivers(page, PAGE_SIZE, search, status, title);
  }

  function renderCgTable(data) {
     loading(false);
     const tbody = document.getElementById('cg-body');
     tbody.innerHTML = '';
     totalItems = data.total;
     if(data.list.length === 0) { 
       tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No caregivers found.</td></tr>'; 
     } else {
       data.list.forEach(c => {
         const tr = document.createElement('tr');
         tr.className = 'table-row';
         tr.onclick = () => openCg(c.code);
         let statusClass = c.status === 'Active' ? 'text-green-700 bg-green-50' : 'text-gray-600 bg-gray-50';
         tr.innerHTML = `
           <td class="table-cell font-mono text-xs">${c.code}</td>
           <td class="table-cell font-bold">${c.name}</td>
           <td class="table-cell text-xs uppercase text-gray-500 font-bold">${c.title}</td>
           <td class="table-cell"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${c.status}</span></td>
           <td class="table-cell text-xs">${c.phone}</td>
           <td class="table-cell text-right"><i class="ph ph-caret-right text-gray-400"></i></td>
         `;
         tbody.appendChild(tr);
       });
     }
     updatePagination('cg', totalItems);
  }

function openCg(code) {
    loading(true);
    google.script.run.withSuccessHandler(data => {
      loading(false);
      if(!data) return alert('Caregiver not found');
      
      showPage('page-cg-add');
      document.getElementById('cg-form-title').innerText = 'Edit Caregiver: ' + data.firstName;
      document.getElementById('btn-cg-pdf').classList.remove('hidden'); 

      const form = document.getElementById('cgForm');
      Object.keys(data).forEach(k => {
        if(form.elements[k]) {
          if(k === 'accountNum') document.getElementById('repeatAccount').value = data[k];
          if(k === 'routingNum') document.getElementById('repeatRouting').value = data[k];
          if(form.elements[k].type === 'checkbox') form.elements[k].checked = data[k] === true;
          else form.elements[k].value = data[k];
        }
      });
    }).getCaregiverDetails(code);
  }

  function downloadCgPdf() {
     const code = document.getElementById('cgCode').value;
     if(!code) return alert('Please save before exporting.');
     
     loading(true);
     google.script.run.withSuccessHandler(pdf => {
        loading(false);
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + pdf.base64;
        link.download = pdf.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
     }).exportCaregiverToPdf(code);
  }

  // --- SHARED UTILS ---

  function updatePagination(type, total) {
    const start = (currentPage - 1) * PAGE_SIZE + 1;
    const end = Math.min(start + PAGE_SIZE - 1, total);
    const infoEl = document.getElementById(`${type}-page-info`);
    const prevBtn = document.getElementById(`${type}-btn-prev`);
    const nextBtn = document.getElementById(`${type}-btn-next`);
    
    if(infoEl) infoEl.innerText = total > 0 ? `Showing ${start}-${end} of ${total}` : 'No data';
    if(prevBtn) {
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { if(currentPage > 1) { if(type==='client') loadClientDir(currentPage-1); else loadCgDir(currentPage-1); } };
    }
    if(nextBtn) {
      nextBtn.disabled = end >= total;
      nextBtn.onclick = () => { if(end < total) { if(type==='client') loadClientDir(currentPage+1); else loadCgDir(currentPage+1); } };
    }
  }

  function loading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
  function handleError(err) { loading(false); alert('Error: ' + err); }
  
  function calcAge(dobId, ageId) {
    if(!dobId) dobId = 'dob';
    if(!ageId) ageId = 'age';
    const d = document.getElementById(dobId).value;
    if(d) document.getElementById(ageId).value = Math.abs(new Date(Date.now() - new Date(d).getTime()).getUTCFullYear() - 1970);
  }
  
  function loadStats() {
    google.script.run.withSuccessHandler(s => {
       const totalEl = document.getElementById('stat-total');
       if(totalEl) {
         totalEl.innerText = s.total;
         document.getElementById('stat-active').innerText = s.active;
         document.getElementById('stat-pending').innerText = s.pending;
       }
    }).getDashboardStats();
  }
</script>