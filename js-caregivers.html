<script>
  console.log("js-caregivers loaded");
  // -- 1. Load List --
  window.loadCaregiverList = function () {
    document.getElementById("cgTableBody").innerHTML =
      '<tr><td colspan="6" class="p-4 text-center text-gray-400">Loading list...</td></tr>';
    google.script.run
      .withSuccessHandler((data) => {
        console.log("Loaded List:", data); // Debug
        cgData = data;
        renderCgTable();
      })
      .getCaregiverList();
  };

  // -- 2. Render Table --
  function renderCgTable() {
    const search = document.getElementById("cgSearch").value.toLowerCase();
    const titleFilterEl = document.getElementById("cgFilterTitle");
    const statusFilter = document.getElementById("cgFilterStatus").value;
    const titleFilter = titleFilterEl ? titleFilterEl.value : "";

    cgFiltered = cgData.filter((item) => {
      // Only show caregivers who have been converted to Active/Inactive/etc.
      // Exclude "Applicant", "Pending", or empty statuses unless they are in the final stages.
      const validStatuses = ["Active", "Inactive", "No call", "Vacation"];
      if (!validStatuses.includes(item.status)) return false;

      const matchSearch =
        item.name.toLowerCase().includes(search) ||
        item.email.toLowerCase().includes(search) ||
        String(item.id).toLowerCase().includes(search);

      const matchTitle = titleFilter === "" || item.title === titleFilter;
      const matchStatus =
        statusFilter === "All" || item.status === statusFilter;

      return matchSearch && matchTitle && matchStatus;
    });

    const totalPages = Math.ceil(cgFiltered.length / cgRowsPerPage);
    if (cgCurrentPage > totalPages) cgCurrentPage = 1;

    const start = (cgCurrentPage - 1) * cgRowsPerPage;
    const end = start + cgRowsPerPage;
    const pageData = cgFiltered.slice(start, end);

    const tbody = document.getElementById("cgTableBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="p-8 text-center text-gray-400">No caregivers found.</td></tr>';
    } else {
      pageData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.className =
          "hover:bg-gray-50 transition-colors cursor-pointer group";

        // IMPORTANT: Pass ID exactly as string
        tr.onclick = function () {
          loadProfile(row.id);
        };

        let statusStyle = "";
        let statusClass = "px-2 py-1 rounded text-xs font-bold";

        if (row.status === "Active") {
          statusStyle = "background-color: #2ECC71; color: white;";
        } else if (row.status === "Inactive") {
          statusStyle = "background-color: #95A5A6; color: white;";
        } else if (row.status === "No Call") {
          statusStyle = "background-color: #1A5276; color: white;";
        } else if (row.status === "Vacation") {
          statusStyle = "background-color: #8E2A2A; color: white;";
        } else {
          statusClass += " bg-gray-100 text-gray-600";
        }

        tr.innerHTML = `
          <td class="p-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                ${row.name.charAt(0)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${row.name}</p>
                <p class="text-xs text-gray-400">${row.id}</p>
              </div>
            </div>
          </td>
          <td class="p-4 text-gray-600">${row.title}</td>
          <td class="p-4">
             <div class="text-xs text-gray-500">${row.email}</div>
             <div class="text-xs text-gray-400">${row.phone}</div>
          </td>
          <td class="p-4">
            <div>
              <p class="font-bold text-gray-800">${row.city}</p>
              <p class="text-xs text-gray-400">${row.zip}</p>
            </div>
          </td>
          <td class="p-4 text-xs text-gray-500">${row.lastReviewed || "--"}</td>
          <td class="p-4 text-xs text-gray-500 font-medium">${
            row.lastClientSeen || "--"
          }</td>
          <td class="p-4">
            <span class="${statusClass}" style="${statusStyle}">${
          row.status
        }</span>
          </td>
          <td class="p-4 text-right">
             <button onclick="loadProfile('${
               row.id
             }')" class="text-xs text-white px-3 py-1 rounded-full hover:opacity-90 font-bold transition-colors" style="background-color: #00BCD4;">Details</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("cgPageInfo").textContent = `Showing ${
      pageData.length > 0 ? start + 1 : 0
    }-${Math.min(end, cgFiltered.length)} of ${cgFiltered.length}`;
    document.getElementById("btnPrev").disabled = cgCurrentPage === 1;
    document.getElementById("btnNext").disabled =
      cgCurrentPage >= totalPages || totalPages === 0;
  }

  function changeCgPage(dir) {
    cgCurrentPage += dir;
    renderCgTable();
  }

  // --- EDIT PROFILE LOGIC (NEW) ---

  function openEditMode() {
    if (!currentProfileData) return;
    switchCgView("edit");
    const d = currentProfileData;

    // 1. Fill Text Inputs
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val || "";
    };

    setVal("edit-id", d["Caregiver ID"]);
    setVal("edit-username", d["Username"]);
    setVal("edit-yearsOfExperience", d["Years of Experience"]);
    setVal("edit-firstName", d["First Name"]);
    setVal("edit-lastName", d["Last Name"]);
    setVal("edit-middleName", d["Middle Int"]);
    setVal("edit-title", d["Title"]);

    if (d["DOB"]) {
      const date = new Date(d["DOB"]);
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, "0");
      const dd = String(date.getDate()).padStart(2, "0");
      setVal("edit-dob", `${yyyy}-${mm}-${dd}`);
    }

    setVal("edit-gender", d["Gender"]);
    setVal("edit-maritalStatus", d["Marital Status"]);
    setVal("edit-spouseName", d["Spouse Name"]);
    setVal("edit-ssn", d["SSN"]);
    setVal("edit-ein", d["EIN"]);
    setVal("edit-routingNum", d["Routing Number"]);
    setVal("edit-accountNum", d["Bank Account"]);
    setVal("edit-status", d["Status"]);
    setVal("edit-address", d["Address"]);
    setVal("edit-apt", d["Apt"]);
    setVal("edit-city", d["City"]);
    setVal("edit-state", d["State"]);
    setVal("edit-zip", d["Zip"]);
    setVal("edit-phone", d["Phone"]);
    setVal("edit-email", d["Email"]);

    setVal("edit-hasLicense", d["Driver License?"]);
    setVal("edit-licenseState", d["License State"]);
    setVal("edit-licenseNum", d["License #"]);
    setVal("edit-hasCar", d["Has Car?"]);
    setVal("edit-carModel", d["Car Make/Model"]);
    setVal("edit-hasInsurance", d["Has Insurance?"]);
    setVal("edit-emergencyAvail", d["Emergency Avail?"]);
    setVal("edit-liveInAvail", d["Live-in Avail?"]);
    setVal("edit-usEligible", d["US Eligible?"]);
    setVal("edit-usCitizen", d["US Citizen?"]);

    setVal("edit-emName", d["Emergency Contact"]);
    setVal("edit-emPhone", d["Emerg. Phone"]);
    setVal("edit-emRel", d["Emerg. Relation"]);
    setVal("edit-emEmail", d["Emerg. Email"]);
    setVal("edit-emAddress", d["Emerg. Address"]);
    setVal("edit-emApt", d["Emerg. Apt"]);
    setVal("edit-emCity", d["Emerg. City"]);
    setVal("edit-emState", d["Emerg. State"]);
    setVal("edit-emZip", d["Emerg. Zip"]);

    // New Sections Mapped
    setVal("edit-hsName", d["High School"]);
    setVal("edit-hsDegree", d["HS Degree"]);
    setVal("edit-colName", d["College"]);
    setVal("edit-colDegree", d["College Degree"]);
    setVal("edit-otherEdu", d["Other Edu"]);
    setVal("edit-otherDegree", d["Other Degree"]);

    // Emp 1
    setVal("edit-emp1-company", d["Emp1 Company"]);
    setVal("edit-emp1-title", d["Emp1 Title"]);
    setVal("edit-emp1-supervisor", d["Emp1 Supervisor"]);
    setVal("edit-emp1-phone", d["Emp1 Phone"]);
    setVal("edit-emp1-duties", d["Emp1 Duties"]);

    // Emp 2
    setVal("edit-emp2-company", d["Emp2 Company"]);
    setVal("edit-emp2-title", d["Emp2 Title"]);
    setVal("edit-emp2-supervisor", d["Emp2 Supervisor"]);
    setVal("edit-emp2-phone", d["Emp2 Phone"]);
    setVal("edit-emp2-duties", d["Emp2 Duties"]);

    // Emp 3
    setVal("edit-emp3-company", d["Emp3 Company"]);
    setVal("edit-emp3-title", d["Emp3 Title"]);
    setVal("edit-emp3-supervisor", d["Emp3 Supervisor"]);
    setVal("edit-emp3-phone", d["Emp3 Phone"]);
    setVal("edit-emp3-duties", d["Emp3 Duties"]);

    setVal("edit-ref1-name", d["Ref1 Name"]);
    setVal("edit-ref1-phone", d["Ref1 Phone"]);
    setVal("edit-ref1-relation", d["Ref1 Relation"]);

    setVal("edit-ref2-name", d["Ref2 Name"]);
    setVal("edit-ref2-phone", d["Ref2 Phone"]);
    setVal("edit-ref2-relation", d["Ref2 Relation"]);

    setVal("edit-criminalHistory", d["Criminal Conviction?"]);
    setVal("edit-criminalExplain", d["Conviction Details"]);

    // Preserve Signature
    setVal("edit-signName", d["Signature Name"]);

    // Vaccinations
    let covidVal = d["Covid Vaccine"] || "No";
    let covidDose = "";
    if (covidVal.includes("Yes")) {
      if (covidVal.includes("One Dose")) covidDose = "One Dose";
      if (covidVal.includes("Two Dose")) covidDose = "Two Dose";
      covidVal = "Yes";
    }
    setVal("edit-covidVaccine", covidVal);
    setVal("edit-covidDoses", covidDose);
    setVal("edit-fluVaccine", d["Flu Vaccine"] || "No");
    toggleEditCovidDose();

    // 2. Checkboxes
    const checkBoxes = (name, str) => {
      const arr = str ? str.split(",").map((s) => s.trim()) : [];
      document.querySelectorAll(`input[name="${name}"]`).forEach((cb) => {
        cb.checked = arr.includes(cb.value);
      });
    };

    checkBoxes("hoursAvail", d["Hours Avail"]);
    checkBoxes("scheduleDays", d["Schedule Desired"]);
    checkBoxes("timesAvail", d["Times Avail"]);
    checkBoxes("certs", d["Certifications"]);
    checkBoxes("skills", d["Skills Checklist"]);
    checkBoxes("languages", d["Languages"]);
  }

  function cancelEdit() {
    switchCgView("profile");
  }

  function toggleEditCovidDose() {
    const val = document.getElementById("edit-covidVaccine").value;
    const div = document.getElementById("edit-covidDoseDiv");
    if (val === "Yes") {
      div.classList.remove("hidden");
    } else {
      div.classList.add("hidden");
      document.getElementById("edit-covidDoses").value = "";
    }
  }

  function toggleEmAddress() {
    const checkbox = document.getElementById("emSameAsAddress");
    if (!checkbox) return; // Safety check if element doesn't exist in this view

    const isChecked = checkbox.checked;
    if (isChecked) {
      const addrEl = document.getElementById("app-address");
      const cityEl = document.getElementById("app-city");
      const stateEl = document.getElementById("app-state");
      const zipEl = document.getElementById("app-zip");

      // Only proceed if source elements exist
      if (addrEl && cityEl && stateEl && zipEl) {
        const addr = addrEl.value;
        const city = cityEl.value;
        const state = stateEl.value;
        const zip = zipEl.value;

        const fullAddress = [addr, city, state, zip].filter(Boolean).join(", ");
        const targetEl = document.getElementById("app-emAddress");
        if (targetEl) targetEl.value = fullAddress;
      }
    } else {
      const targetEl = document.getElementById("app-emAddress");
      if (targetEl) targetEl.value = "";
    }
  }

  function toggleEditEmAddress() {
    const isChecked = document.getElementById("edit-emSameAsAddress").checked;
    if (isChecked) {
      document.getElementById("edit-emAddress").value =
        document.getElementById("edit-address").value;
      document.getElementById("edit-emApt").value =
        document.getElementById("edit-apt").value;
      document.getElementById("edit-emCity").value =
        document.getElementById("edit-city").value;
      document.getElementById("edit-emState").value =
        document.getElementById("edit-state").value;
      document.getElementById("edit-emZip").value =
        document.getElementById("edit-zip").value;
    } else {
      document.getElementById("edit-emAddress").value = "";
      document.getElementById("edit-emApt").value = "";
      document.getElementById("edit-emCity").value = "";
      document.getElementById("edit-emState").value = "";
      document.getElementById("edit-emZip").value = "";
    }
  }

  function submitEditProfile(e) {
    e.preventDefault();
    const btn = document.getElementById("saveProfileBtn");
    btn.textContent = "Saving...";
    btn.disabled = true;

    const form = document.getElementById("editProfileForm");
    const obj = {};
    const formData = new FormData(form);

    // Checkboxes
    const getChecks = (name) =>
      Array.from(
        document.querySelectorAll(`input[name="${name}"]:checked`)
      ).map((c) => c.value);

    for (let [key, value] of formData.entries()) {
      obj[key] = value;
    }

    obj.skills = getChecks("skills");
    obj.certs = getChecks("certs");
    obj.languages = getChecks("languages");
    obj.hoursAvail = getChecks("hoursAvail");
    obj.scheduleDays = getChecks("scheduleDays");
    obj.timesAvail = getChecks("timesAvail");

    // SPECIAL MAPPING for SheetController compat
    // The controller expects objects for these, so we mock them to match the string value
    // SPECIAL MAPPING for SheetController compat
    obj.emp1 = {
      company: obj["emp1[company]"],
      title: obj["emp1[title]"],
      supervisor: obj["emp1[supervisor]"],
      phone: obj["emp1[phone]"],
      duties: obj["emp1[duties]"],
    };
    obj.emp2 = {
      company: obj["emp2[company]"],
      title: obj["emp2[title]"],
      supervisor: obj["emp2[supervisor]"],
      phone: obj["emp2[phone]"],
      duties: obj["emp2[duties]"],
    };
    obj.emp3 = {
      company: obj["emp3[company]"],
      title: obj["emp3[title]"],
      supervisor: obj["emp3[supervisor]"],
      phone: obj["emp3[phone]"],
      duties: obj["emp3[duties]"],
    };

    obj.ref1 = {
      name: obj["ref1[name]"],
      phone: obj["ref1[phone]"],
      relation: obj["ref1[relation]"],
    };
    obj.ref2 = {
      name: obj["ref2[name]"],
      phone: obj["ref2[phone]"],
      relation: obj["ref2[relation]"],
    };

    google.script.run
      .withSuccessHandler((res) => {
        btn.textContent = "Save Changes";
        btn.disabled = false;
        if (res.success) {
          Swal.fire("Success", "Profile Updated", "success");
          loadProfile(currentProfileId);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .submitFullApplication(obj);
  }

  // --- STAGE LOGIC ---
  function updateStageUI(stageNum, status, textId, btnId, iconId, label) {
    const icon = document.getElementById(iconId);
    const btn = document.getElementById(btnId);
    const text = document.getElementById(textId);

    if (!icon) return;

    if (
      status === "Yes" ||
      status === "Application Completed" ||
      status === "Done"
    ) {
      // SUCCESS
      icon.className =
        "w-12 h-12 rounded-full bg-[#65c027] text-white flex items-center justify-center text-xl font-bold border-4 border-white transition-colors shadow-lg";
      icon.innerHTML = '<i class="ph ph-check"></i>';
      if (btn) {
        btn.textContent = "Passed";
        btn.disabled = true;
        btn.className =
          "mt-1 text-xs px-2 py-1 rounded bg-green-50 text-green-600 font-bold";
      }
      if (text) {
        text.textContent = "Completed";
        text.className = "text-xs text-green-600 font-bold";
      }
    } else if (status === "No") {
      // FAILED / NO
      icon.className =
        "w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-xl font-bold border-4 border-white transition-colors";
      icon.innerHTML = '<i class="ph ph-x"></i>';
      if (btn) {
        btn.textContent = "Failed";
        btn.disabled = false;
        btn.className =
          "mt-1 text-xs px-2 py-1 rounded bg-red-50 text-red-600 font-bold hover:bg-red-100 cursor-pointer";
      }
    } else if (status === "Missing") {
      // MISSING
      icon.className =
        "w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center text-xl font-bold border-4 border-white transition-colors shadow-lg";
      icon.innerHTML = '<i class="ph ph-warning"></i>';
      if (text) {
        text.textContent = "Missing (> 1 Week)";
        text.className = "text-xs text-red-500 font-bold";
      }
    } else {
      // PENDING
      if (btn) {
        btn.textContent = label;
        btn.disabled = false;
        btn.className =
          "mt-1 text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 transition";
      }
      icon.className =
        "w-12 h-12 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-xl font-bold border-4 border-white transition-colors";
      icon.innerHTML =
        stageNum === 2
          ? '<i class="ph ph-chats-circle"></i>'
          : stageNum === 3
          ? '<i class="ph ph-shield-check"></i>'
          : stageNum === 4
          ? '<i class="ph ph-briefcase"></i>'
          : stageNum;
    }
  }

  function advanceStage(stageNum) {
    if (!currentProfileId) return;

    let title = "";
    let field = "";

    if (stageNum === 2) {
      title = "Interview Passed?";
      field = "Interview";
    }
    if (stageNum === 3) {
      title = "Background Check Passed?";
      field = "Background";
    }
    if (stageNum === 4) {
      title = "Activate Caregiver?";
      field = "Active";
    }

    // POPUP FOR YES / NO
    Swal.fire({
      title: title,
      icon: "question",
      showDenyButton: true,
      confirmButtonText: "Yes",
      denyButtonText: "No",
      confirmButtonColor: "#65c027",
      denyButtonColor: "#d33",
    }).then((result) => {
      if (result.isDismissed) return; // Clicked outside

      let val = result.isConfirmed ? "Yes" : "No";

      // Special logic for Activation
      if (stageNum === 4) {
        val = result.isConfirmed ? "Active" : "Inactive";
      }

      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            loadProfile(currentProfileId);
            if (stageNum === 4 && val === "Active") {
              Swal.fire("Success", "Caregiver is now Active!", "success");
            }
          } else {
            Swal.fire("Error", res.message, "error");
          }
        })
        .updateCaregiverStage(currentProfileId, field, val);
    });
  }

  // -- 3. Load Profile --
  function openProfile(id) {
    loadProfile(id);
  }

  function loadProfile(id) {
    currentProfileId = id;

    switchCgView("profile");
    document.getElementById("profileLoading").classList.remove("hidden");
    document.getElementById("profileContent").classList.add("hidden");

    google.script.run
      .withSuccessHandler((data) => {
        if (!data) {
          Swal.fire("Error", "Caregiver details not found.", "error");
          switchCgView("list");
          return;
        }

        currentProfileData = data; // SAVE DATA FOR EDIT MODE

        // CRITICAL FIX: Safety Check Set Function
        const set = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val || "--";
        };

        set(
          "p-name",
          data["First Name"] +
            " " +
            data["Middle Int"] +
            " " +
            data["Last Name"]
        );
        set("p-initials", (data["First Name"] || "U").charAt(0));
        set("p-title", data["Title"]);
        set("p-id", data["Caregiver ID"]);
        set("p-last-client", data["Last Client Seen"]);
        set(
          "p-started-date",
          data["Started Date"]
            ? new Date(data["Started Date"]).toLocaleDateString()
            : "--"
        );
        set(
          "p-last-reviewed",
          data["Last Reviewed"]
            ? new Date(data["Last Reviewed"]).toLocaleDateString()
            : "--"
        );

        const pipelinePanel = document.getElementById("pipeline-panel");
        if (data["Status"] === "Active") {
          if (pipelinePanel) pipelinePanel.classList.add("hidden");
          // SHOW EDIT BUTTON IF ACTIVE
          document
            .getElementById("btn-edit-profile")
            .classList.remove("hidden");
        } else {
          if (pipelinePanel) pipelinePanel.classList.remove("hidden");
        }

        const badge = document.getElementById("p-status-badge");
        if (badge) {
          badge.textContent = data["Status"];

          let statusStyle = "";
          let statusClass = "px-3 py-1 rounded-full text-xs font-bold";

          if (data["Status"] === "Active") {
            statusStyle = "background-color: #2ECC71; color: white;";
          } else if (data["Status"] === "Inactive") {
            statusStyle = "background-color: #95A5A6; color: white;";
          } else if (data["Status"] === "No Call") {
            statusStyle = "background-color: #1A5276; color: white;";
          } else if (data["Status"] === "Vacation") {
            statusStyle = "background-color: #8E2A2A; color: white;";
          } else {
            statusClass += " bg-gray-100 text-gray-600";
          }

          badge.className = statusClass;
          badge.setAttribute("style", statusStyle);
        }

        const emailBtn = document.getElementById("p-email-btn");
        if (emailBtn) emailBtn.href = "mailto:" + data["Email"];

        set("p-username", data["Username"]);
        set("p-yearsOfExperience", data["Years of Experience"]);
        set("p-email", data["Email"]);
        set("p-phone", data["Phone"]);
        set("p-ssn", data["SSN"]);
        set("p-ein", data["EIN"]);

        set("p-address", data["Address"]);
        set("p-apt", data["Apt"]);
        set("p-city", data["City"]);
        set("p-state", data["State"]);
        set("p-zip", data["Zip"]);

        // DOB with Age & Icon
        let dobHtml = "--";
        if (data["DOB"]) {
          const dobDate = new Date(data["DOB"]);
          if (!isNaN(dobDate.getTime())) {
            const diff = Date.now() - dobDate.getTime();
            const ageDate = new Date(diff);
            const age = Math.abs(ageDate.getUTCFullYear() - 1970);
            dobHtml = `<span>${data["DOB"]}</span> <span class="text-gray-500">(${age})</span> <i class="ph ph-cake text-pink-400 text-lg"></i>`;
          } else {
            dobHtml = data["DOB"];
          }
        }
        const dobEl = document.getElementById("p-dob");
        if (dobEl) dobEl.innerHTML = dobHtml;

        set("p-gender", data["Gender"]);
        set(
          "p-marital",
          `${data["Marital Status"] || "--"} ${
            data["Spouse Name"] ? "(" + data["Spouse Name"] + ")" : ""
          }`
        );
        set("p-ssn", data["SSN"]);

        // Payment Info
        const payMethod = data["Payment Method"] || "Not Set";
        set("p-pay-method", payMethod);

        const bankDetailsDiv = document.getElementById("p-bank-details");
        const checkDetailsDiv = document.getElementById("p-check-details");

        if (bankDetailsDiv) {
          if (["Direct Deposit", "Bank Deposit"].includes(payMethod)) {
            bankDetailsDiv.classList.remove("hidden");
            set("p-bank-name", data["Bank Name"]);
            set("p-holder-name", data["Account Holder Name"]);
            set(
              "p-holder-type",
              data["Holder Type"] ? `(${data["Holder Type"]})` : ""
            );
            // Mask Account Number for security
            const accNum = String(data["Bank Account"] || "");
            set(
              "p-account-num",
              accNum.length > 4 ? `****${accNum.slice(-4)}` : accNum
            );
            set(
              "p-routing-num",
              data["Routing Number"] ? `Routing: ${data["Routing Number"]}` : ""
            );
            set("p-account-type", data["Account Type"]);
          } else {
            bankDetailsDiv.classList.add("hidden");
          }
        }

        if (checkDetailsDiv) {
          if (payMethod === "Check") {
            checkDetailsDiv.classList.remove("hidden");
            const idLink = document.getElementById("p-check-id");
            const addrLink = document.getElementById("p-check-addr");

            if (data["Check ID Proof"]) {
              idLink.href = data["Check ID Proof"];
              idLink.classList.remove("hidden");
            } else {
              idLink.classList.add("hidden");
            }

            if (data["Check Address Proof"]) {
              addrLink.href = data["Check Address Proof"];
              addrLink.classList.remove("hidden");
            } else {
              addrLink.classList.add("hidden");
            }
          } else {
            checkDetailsDiv.classList.add("hidden");
          }
        }

        const digitalDetailsDiv = document.getElementById("p-digital-details");
        if (digitalDetailsDiv) {
          if (["Zelle", "Apple Pay"].includes(payMethod)) {
            digitalDetailsDiv.classList.remove("hidden");
            set("p-digital-name", data["Digital Name"]);
            set("p-digital-phone", data["Digital Phone"]);
            set("p-digital-email", data["Digital Email"]);
          } else {
            digitalDetailsDiv.classList.add("hidden");
          }
        }

        set("p-has-license", data["Driver License?"]);
        set("p-license-state", data["License State"]);
        set("p-license-num", data["License #"]);

        set("p-has-car", data["Has Car?"]);
        set("p-car-model", data["Car Make/Model"]);
        set("p-has-insurance", data["Has Insurance?"]);
        set(
          "p-us-eligible",
          `US Eligible: ${data["US Eligible?"]} | US Citizen: ${data["US Citizen?"]}`
        );
        // NEW Reference Population
        set("p-ref1-name", data["Ref1 Name"]);
        set("p-ref1-phone", data["Ref1 Phone"]);
        set("p-ref1-relation", data["Ref1 Relation"]);
        set("p-ref2-name", data["Ref2 Name"]);
        set("p-ref2-phone", data["Ref2 Phone"]);
        set("p-ref2-relation", data["Ref2 Relation"]);

        set("p-emergency-name", data["Emergency Contact"]);
        set("p-emergency-contact", data["Emerg. Phone"]);
        set("p-emergency-email", data["Emerg. Email"]);
        set("p-emergency-address", data["Emerg. Address"]);
        set("p-emergency-apt", data["Emerg. Apt"]);
        set("p-emergency-city", data["Emerg. City"]);
        set("p-emergency-state", data["Emerg. State"]);
        set("p-emergency-zip", data["Emerg. Zip"]);

        set(
          "p-criminal-conviction",
          `Criminal Conviction: ${data["Criminal Conviction?"]} | Conviction Details: ${data["Conviction Details"]}`
        );

        // Stages
        let appStatus = data["App Status"];
        if (appStatus !== "Application Completed") {
          const created = new Date(data["Created At"]);
          const now = new Date();
          const diffDays = (now - created) / (1000 * 60 * 60 * 24);
          if (diffDays > 7) appStatus = "Missing";
        }
        updateStageUI(1, appStatus, "stage-text-1", null, "stage-icon-1", "");
        updateStageUI(
          2,
          data["Interview Status"],
          null,
          "stage-btn-2",
          "stage-icon-2",
          "Update"
        );
        updateStageUI(
          3,
          data["Background Check"],
          null,
          "stage-btn-3",
          "stage-icon-3",
          "Update"
        );

        // Last stage button logic
        const activeState =
          data["Status"] === "Active"
            ? "Done"
            : data["Status"] === "Inactive"
            ? "No"
            : "Pending";
        updateStageUI(
          4,
          activeState,
          null,
          "stage-btn-4",
          "stage-icon-4",
          "Activate"
        );

        const makeTags = (containerId, str) => {
          const div = document.getElementById(containerId);
          if (!div) return;
          div.innerHTML = "";
          if (!str) return;
          str
            .toString()
            .split(",")
            .forEach((s) => {
              const span = document.createElement("span");
              span.className =
                "bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded border border-gray-200";
              span.textContent = s.trim();
              div.appendChild(span);
            });
        };
        makeTags("p-certs", data["Certifications"]);
        makeTags("p-days", data["Schedule Desired"]);
        set("p-skills", data["Skills Checklist"]);
        set("p-langs", data["Languages"]);
        set("p-covid", data["Covid Vaccine"]);
        set("p-flu", data["Flu Vaccine"]);
        set("p-hs-name", data["High School"]);
        set("p-hs-degree", data["HS Degree"]);

        set("p-col-name", data["College"]);
        set("p-col-degree", data["College Degree"]);

        set("p-other-name", data["Other Edu"]);
        set("p-other-degree", data["Other Degree"]);
        // Employer 1
        set("p-emp1-company", data["Emp1 Company"]);
        set("p-emp1-title", data["Emp1 Title"]);
        set("p-emp1-supervisor", data["Emp1 Supervisor"]);
        set("p-emp1-phone", data["Emp1 Phone"]);
        set("p-emp1-duties", data["Emp1 Duties"]);

        // Employer 2
        set("p-emp2-company", data["Emp2 Company"]);
        set("p-emp2-title", data["Emp2 Title"]);
        set("p-emp2-supervisor", data["Emp2 Supervisor"]);
        set("p-emp2-phone", data["Emp2 Phone"]);
        set("p-emp2-duties", data["Emp2 Duties"]);

        // Employer 3
        set("p-emp3-company", data["Emp3 Company"]);
        set("p-emp3-title", data["Emp3 Title"]);
        set("p-emp3-supervisor", data["Emp3 Supervisor"]);
        set("p-emp3-phone", data["Emp3 Phone"]);
        set("p-emp3-duties", data["Emp3 Duties"]);
        set("p-hours", data["Hours Avail"]);
        set("p-times", data["Times Avail"]);
        set("p-emergency-avail", data["Emergency Avail?"]);
        set("p-live-in-avail", data["Live-in Avail?"]);
        set("p-emergency-name", data["Emergency Contact"]);
        set(
          "p-emergency-contact",
          `${data["Emerg. Relation"]} - ${data["Emerg. Phone"]}`
        );
        set("p-emergency-email", data["Emerg. Email"]);
        set("p-emergency-address", data["Emerg. Address"]);

        // Signature Details
        set("p-signName", data["Signature Name"]);
        set(
          "p-signDate",
          data["Signature Date"]
            ? new Date(data["Signature Date"]).toLocaleDateString()
            : "--"
        );

        // Render Documents
        const docContainer = document.getElementById("p-documents-container");
        const docList = document.getElementById("p-documents");
        docList.innerHTML = "";
        let hasDocs = false;

        if (data["Contract Link"]) {
          hasDocs = true;
          docList.innerHTML += `<a href="${data["Contract Link"]}" target="_blank" class="flex items-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 text-sm text-gray-700 transition-colors">
            <i class="ph ph-file-text text-blue-500 text-lg"></i>
            <span class="font-medium">Independent Contractor Agreement</span>
            <i class="ph ph-arrow-square-out ml-auto text-gray-400"></i>
          </a>`;
        }
        if (data["W9 Link"]) {
          hasDocs = true;
          docList.innerHTML += `<a href="${data["W9 Link"]}" target="_blank" class="flex items-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 text-sm text-gray-700 transition-colors">
            <i class="ph ph-file-text text-green-500 text-lg"></i>
            <span class="font-medium">W-9 Form</span>
            <i class="ph ph-arrow-square-out ml-auto text-gray-400"></i>
          </a>`;
        }
        if (data["Background Link"]) {
          hasDocs = true;
          docList.innerHTML += `<a href="${data["Background Link"]}" target="_blank" class="flex items-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 rounded border border-gray-200 text-sm text-gray-700 transition-colors">
            <i class="ph ph-file-text text-orange-500 text-lg"></i>
            <span class="font-medium">Background Check Request</span>
            <i class="ph ph-arrow-square-out ml-auto text-gray-400"></i>
          </a>`;
        }

        if (hasDocs) {
          docContainer.classList.remove("hidden");
        } else {
          docContainer.classList.add("hidden");
        }

        document.getElementById("profileLoading").classList.add("hidden");
        document.getElementById("profileContent").classList.remove("hidden");
      })
      .getCaregiverDetails(id);
  }

  function submitForm(e) {
    e.preventDefault();
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const form = document.getElementById("caregiverForm");
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => (data[key] = value));

    google.script.run
      .withSuccessHandler((res) => {
        btn.disabled = false;
        btn.textContent = "Create & Send";
        if (res.success) {
          Swal.fire("Success", "Caregiver Added", "success");
          form.reset();
          switchCgView("list");
          if (window.loadCaregiverList) window.loadCaregiverList();
        } else {
          Swal.fire("Error", res.message, "error");
        }
      })
      .handleCaregiverSubmission(data);
  }

  // --- Phone Masking ---
  function setupPhoneMasks() {
    const ids = [
      "edit-phone",
      "edit-emPhone",
      "edit-emp1-phone",
      "edit-emp2-phone",
      "edit-emp3-phone",
      "edit-ref1-phone",
      "edit-ref2-phone",
    ];

    ids.forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", (e) => {
          let val = e.target.value.replace(/\D/g, "");
          if (val.length > 10) val = val.substring(0, 10);
          if (val.length > 6) {
            val = val.replace(/^(\d{3})(\d{3})(\d+)/, "($1) $2-$3");
          } else if (val.length > 3) {
            val = val.replace(/^(\d{3})(\d+)/, "($1) $2");
          }
          e.target.value = val;
        });
      }
    });
  }

  // Initialize masks
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupPhoneMasks);
  } else {
    setupPhoneMasks();
  }

  // --- Archive Caregiver Functions ---

  function openArchiveCaregiverModal() {
    document.getElementById("archiveCaregiverModal").classList.remove("hidden");
    document.getElementById("cgArchiveReason").value = "";
    document.getElementById("cgArchiveNote").value = "";
    toggleCgArchiveOtherInput();
  }

  function closeArchiveCaregiverModal() {
    document.getElementById("archiveCaregiverModal").classList.add("hidden");
  }

  function toggleCgArchiveOtherInput() {
    const reason = document.getElementById("cgArchiveReason").value;
    const otherContainer = document.getElementById("cgArchiveOtherContainer");
    if (reason === "Other") {
      otherContainer.classList.remove("hidden");
    } else {
      otherContainer.classList.add("hidden");
    }
  }

  function submitArchiveCaregiver() {
    const reason = document.getElementById("cgArchiveReason").value;
    const note = document.getElementById("cgArchiveNote").value.trim();

    if (!reason) {
      Swal.fire("Error", "Please select a reason.", "error");
      return;
    }

    let finalReason = reason;
    if (reason === "Other") {
      if (!note) {
        Swal.fire(
          "Error",
          "Please provide a note for 'Other' reason.",
          "error"
        );
        return;
      }
      finalReason = `Other: ${note}`;
    } else if (note) {
      finalReason = `${reason} - ${note}`;
    }

    const caregiverId = document.getElementById("p-id").textContent;
    if (!caregiverId || caregiverId === "--") {
      Swal.fire("Error", "No Caregiver ID found.", "error");
      return;
    }

    const submitBtn = document.querySelector(
      "#archiveCaregiverModal button.bg-red-600"
    );
    const originalText = submitBtn.innerText;
    submitBtn.disabled = true;
    submitBtn.innerText = "Archiving...";

    google.script.run
      .withSuccessHandler((res) => {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
        closeArchiveCaregiverModal();
        if (res.success) {
          Swal.fire(
            "Success",
            "Caregiver moved to archive successfully.",
            "success"
          ).then(() => {
            switchCgView("list");
            loadCaregiverList();
          });
        } else {
          Swal.fire(
            "Error",
            res.message || "Failed to archive caregiver.",
            "error"
          );
        }
      })
      .withFailureHandler((err) => {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
        console.error(err);
        Swal.fire(
          "Error",
          "An unexpected error occurred: " + err.message,
          "error"
        );
      })
      .archiveCaregiver(caregiverId, finalReason);
  }
</script>
