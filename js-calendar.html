<script>
  // --- CAREGIVER CALENDAR LOGIC ---
  let currentCalendarDate = new Date();
  let currentMiniMonthDate = new Date();
  let calendarViewMode = "week";

  const DAY_MS = 24 * 60 * 60 * 1000;

  function loadCaregiverCalendar() {
    updateCalendarViewToggle();
    renderActiveCalendar();
    renderMiniMonthCalendar();
  }

  function setCalendarView(view) {
    calendarViewMode = view;
    if (view === "week" || view === "biweekly") {
      currentCalendarDate = getStartOfWeek(currentCalendarDate);
    }
    if (view === "month") {
      currentMiniMonthDate = new Date(currentCalendarDate);
      renderMiniMonthCalendar();
    }
    updateCalendarViewToggle();
    renderActiveCalendar();
  }

  function changePeriod(offset) {
    const workingDate = new Date(currentCalendarDate);

    if (calendarViewMode === "day") {
      workingDate.setDate(workingDate.getDate() + offset);
      currentCalendarDate = workingDate;
    } else if (calendarViewMode === "week") {
      const start = getStartOfWeek(workingDate);
      start.setDate(start.getDate() + offset * 7);
      currentCalendarDate = start;
    } else if (calendarViewMode === "biweekly") {
      const start = getStartOfWeek(workingDate);
      start.setDate(start.getDate() + offset * 14);
      currentCalendarDate = start;
    } else if (calendarViewMode === "month") {
      workingDate.setMonth(workingDate.getMonth() + offset);
      currentCalendarDate = workingDate;
      currentMiniMonthDate = new Date(workingDate);
      renderMiniMonthCalendar();
    }

    renderActiveCalendar();
  }

  // Backward compatibility with existing calls
  function changeWeek(offset) {
    changePeriod(offset);
  }

  function changeMiniMonth(offset) {
    currentMiniMonthDate.setMonth(currentMiniMonthDate.getMonth() + offset);
    renderMiniMonthCalendar();
  }

  function renderActiveCalendar() {
    if (calendarViewMode === "day") {
      renderDayCalendar();
    } else if (calendarViewMode === "week") {
      renderWeekCalendar();
    } else if (calendarViewMode === "biweekly") {
      renderBiweeklyCalendar();
    } else {
      renderMonthCalendar();
    }
  }

  function getStartOfWeek(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() - d.getDay());
    return d;
  }

  function toISODate(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    return d.toISOString().split("T")[0];
  }

  function isSameDate(a, b) {
    return a && b && a.toDateString() === b.toDateString();
  }

  function updateCalendarViewToggle() {
    const buttons = document.querySelectorAll(
      "#calendarViewToggle .calendar-view-btn"
    );
    buttons.forEach((btn) => {
      const isActive = btn.dataset.view === calendarViewMode;
      btn.classList.toggle("bg-[#65c027]", isActive);
      btn.classList.toggle("text-white", isActive);
      btn.classList.toggle("shadow", isActive);
      btn.classList.toggle("text-gray-600", !isActive);
    });
  }

  function createShiftCard(shift) {
    const cg = cgData.find((c) => c.id === shift.caregiverId);
    const cl = clData.find((c) => c.id === shift.clientId);
    const cgName = cg ? cg.name : shift.caregiverId;
    const clName = cl ? cl.firstName + " " + cl.lastName : shift.clientId;

    const card = document.createElement("div");
    card.className =
      "bg-white p-2 rounded border border-l-4 border-l-[#65c027] shadow-sm text-xs hover:shadow-md transition cursor-pointer";
    card.innerHTML = `
      <div class="font-bold text-gray-700 truncate">${clName}</div>
      <div class="text-gray-500 truncate">${cgName}</div>
      <div class="mt-1 flex justify-between text-[10px] text-gray-400">
        <span>${shift.clockIn} - ${shift.clockOut}</span>
      </div>
    `;
    return card;
  }

  function renderDayCalendar() {
    const grid = document.getElementById("weekGrid");
    grid.className = "grid grid-cols-7 flex-1 overflow-y-auto";
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    const day = new Date(currentCalendarDate);
    day.setHours(0, 0, 0, 0);
    const label = day.toLocaleDateString("en-US", {
      weekday: "long",
      month: "short",
      day: "numeric",
      year: "numeric",
    });
    document.getElementById("currentWeekLabel").textContent = label;

    const dateStr = toISODate(day);

    google.script.run
      .withSuccessHandler((shifts) => {
        grid.innerHTML = "";

        const isToday = isSameDate(day, new Date());
        const col = document.createElement("div");
        col.className = `col-span-7 min-h-[420px] flex flex-col border border-gray-100 rounded-lg ${
          isToday ? "bg-green-50 border-green-300" : "bg-white"
        }`;
        col.innerHTML = `
          <div class="p-3 text-center border-b border-gray-100 bg-white/80">
            <div class="text-sm font-semibold text-gray-600">${day.toLocaleDateString(
              "en-US",
              { weekday: "long" }
            )}</div>
            <span class="text-2xl font-bold text-gray-800">${day.getDate()}</span>
          </div>
          <div class="flex-1 p-3 space-y-2" id="day-${dateStr}"></div>
        `;

        const container = col.querySelector(`#day-${dateStr}`);
        const dayShifts = shifts.filter((s) => s.date === dateStr);
        dayShifts.forEach((s) => container.appendChild(createShiftCard(s)));

        grid.appendChild(col);
      })
      .getShifts(dateStr, dateStr);
  }

  function renderWeekCalendar() {
    const grid = document.getElementById("weekGrid");
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    const currentWeekStart = getStartOfWeek(new Date());
    const isCurrentWeek = isSameDate(startOfWeek, currentWeekStart);

    const options = { month: "short", day: "numeric" };
    const label = `${startOfWeek.toLocaleDateString(
      "en-US",
      options
    )} - ${endOfWeek.toLocaleDateString("en-US", {
      ...options,
      year: "numeric",
    })}`;
    document.getElementById("currentWeekLabel").textContent = label;

    const startStr = toISODate(startOfWeek);
    const endStr = toISODate(endOfWeek);

    grid.className = "grid grid-cols-7 flex-1 overflow-y-auto auto-rows-fr";

    google.script.run
      .withSuccessHandler((shifts) => {
        grid.innerHTML = "";

        // Generate 7 columns
        for (let i = 0; i < 7; i++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + i);
          const dateStr = toISODate(currentDay);
          const isToday = isSameDate(new Date(), currentDay);
          const columnHighlight = isToday
            ? "bg-green-50 border-green-300"
            : isCurrentWeek
            ? "bg-gray-50"
            : "bg-white";

          const col = document.createElement("div");
          col.className = `border border-gray-100 min-h-[400px] flex flex-col ${columnHighlight}`;

          // Date Header
          col.innerHTML = `
            <div class="p-2 text-center border-b border-gray-100">
              <div class="text-xs font-semibold text-gray-500">${currentDay.toLocaleDateString(
                "en-US",
                { weekday: "short" }
              )}</div>
              <span class="text-lg font-bold block text-gray-800">${currentDay.getDate()}</span>
            </div>
            <div class="flex-1 p-2 space-y-2" id="day-${dateStr}"></div>
          `;
          grid.appendChild(col);

          // Add Shifts
          const dayShifts = shifts.filter((s) => s.date === dateStr);
          const container = col.querySelector(`#day-${dateStr}`);

          dayShifts.forEach((s) => container.appendChild(createShiftCard(s)));
        }
      })
      .getShifts(startStr, endStr);
  }

  function renderBiweeklyCalendar() {
    const grid = document.getElementById("weekGrid");
    grid.className = "grid grid-cols-7 flex-1 overflow-y-auto auto-rows-fr";
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    const start = getStartOfWeek(currentCalendarDate);
    const end = new Date(start);
    end.setDate(start.getDate() + 13);

    const labelOptions = { month: "short", day: "numeric" };
    const label = `${start.toLocaleDateString(
      "en-US",
      labelOptions
    )} - ${end.toLocaleDateString("en-US", {
      ...labelOptions,
      year: "numeric",
    })}`;
    document.getElementById("currentWeekLabel").textContent = label;

    const startStr = toISODate(start);
    const endStr = toISODate(end);
    const currentWeekStart = getStartOfWeek(new Date());
    const currentWeekEnd = new Date(currentWeekStart);
    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

    google.script.run
      .withSuccessHandler((shifts) => {
        grid.innerHTML = "";

        for (let i = 0; i < 14; i++) {
          const currentDay = new Date(start);
          currentDay.setDate(start.getDate() + i);
          const dateStr = toISODate(currentDay);

          const isToday = isSameDate(new Date(), currentDay);
          const inCurrentWeek =
            currentDay >= currentWeekStart && currentDay <= currentWeekEnd;
          const columnHighlight = isToday
            ? "bg-green-50 border-green-300"
            : inCurrentWeek
            ? "bg-gray-50"
            : "bg-white";

          const col = document.createElement("div");
          col.className = `border border-gray-100 min-h-[320px] flex flex-col ${columnHighlight}`;
          col.innerHTML = `
            <div class="p-2 text-center border-b border-gray-100">
              <div class="text-xs font-semibold text-gray-500">${currentDay.toLocaleDateString(
                "en-US",
                { weekday: "short" }
              )}</div>
              <span class="text-lg font-bold block text-gray-800">${currentDay.getDate()}</span>
            </div>
            <div class="flex-1 p-2 space-y-2" id="day-${dateStr}"></div>
          `;
          grid.appendChild(col);

          const dayShifts = shifts.filter((s) => s.date === dateStr);
          const container = col.querySelector(`#day-${dateStr}`);
          dayShifts.forEach((s) => container.appendChild(createShiftCard(s)));
        }
      })
      .getShifts(startStr, endStr);
  }

  function renderMonthCalendar() {
    const grid = document.getElementById("weekGrid");
    grid.className = "grid grid-cols-7 flex-1 overflow-y-auto auto-rows-fr";
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    document.getElementById("currentWeekLabel").textContent =
      firstDay.toLocaleDateString("en-US", { month: "long", year: "numeric" });

    const startGrid = getStartOfWeek(firstDay);
    const endGrid = getStartOfWeek(lastDay);
    endGrid.setDate(endGrid.getDate() + 6);

    const startStr = toISODate(firstDay);
    const endStr = toISODate(lastDay);

    const today = new Date();
    const currentWeekStart = getStartOfWeek(today);
    const currentWeekEnd = new Date(currentWeekStart);
    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

    google.script.run
      .withSuccessHandler((shifts) => {
        grid.innerHTML = "";

        const shiftMap = shifts.reduce((acc, s) => {
          acc[s.date] = acc[s.date] || [];
          acc[s.date].push(s);
          return acc;
        }, {});

        const totalDays = Math.round((endGrid - startGrid) / DAY_MS) + 1;

        for (let i = 0; i < totalDays; i++) {
          const currentDay = new Date(startGrid);
          currentDay.setDate(startGrid.getDate() + i);
          const dateStr = toISODate(currentDay);

          const isToday = isSameDate(today, currentDay);
          const inCurrentWeek =
            currentDay >= currentWeekStart && currentDay <= currentWeekEnd;
          const inCurrentMonth = currentDay.getMonth() === month;

          let background = inCurrentMonth ? "bg-white" : "bg-gray-50";
          if (inCurrentWeek) {
            background = "bg-gray-100";
          }
          if (isToday) {
            background = "bg-green-50 border-green-300";
          }

          const cell = document.createElement("div");
          cell.className = `border border-gray-100 min-h-[140px] flex flex-col ${background}`;
          cell.innerHTML = `
            <div class="p-2 border-b border-gray-100 flex items-center justify-between">
              <span class="text-sm font-semibold ${
                inCurrentMonth ? "text-gray-800" : "text-gray-400"
              }">${currentDay.getDate()}</span>
              <span class="text-[11px] text-gray-400">${currentDay.toLocaleDateString(
                "en-US",
                { weekday: "short" }
              )}</span>
            </div>
            <div class="flex-1 p-2 space-y-2 overflow-y-auto" id="day-${dateStr}"></div>
          `;

          const dayShifts = shiftMap[dateStr] || [];
          const container = cell.querySelector(`#day-${dateStr}`);
          dayShifts.forEach((s) => container.appendChild(createShiftCard(s)));

          grid.appendChild(cell);
        }
      })
      .getShifts(startStr, endStr);
  }

  function renderMiniMonthCalendar() {
    const grid = document.getElementById("miniMonthGrid");
    grid.innerHTML = "";

    const year = currentMiniMonthDate.getFullYear();
    const month = currentMiniMonthDate.getMonth();

    document.getElementById("miniMonthLabel").textContent =
      currentMiniMonthDate.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric",
      });

    const today = new Date();
    const currentWeekStart = getStartOfWeek(today);
    const currentWeekEnd = new Date(currentWeekStart);
    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Empty cells for start padding
    for (let i = 0; i < firstDay.getDay(); i++) {
      grid.appendChild(document.createElement("div"));
    }

    // Days
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const d = new Date(year, month, i);
      const isToday = isSameDate(today, d);
      const inCurrentWeek = d >= currentWeekStart && d <= currentWeekEnd;

      const cell = document.createElement("div");
      cell.className = `p-1 rounded-full cursor-pointer hover:bg-gray-100 ${
        isToday
          ? "bg-[#65c027] text-white font-bold border border-[#65c027]"
          : inCurrentWeek
          ? "bg-gray-200 text-gray-800 font-semibold"
          : "text-gray-700"
      }`;
      cell.textContent = i;
      cell.onclick = () => {
        currentCalendarDate = new Date(year, month, i);
        renderActiveCalendar();
      };
      grid.appendChild(cell);
    }
  }
</script>
