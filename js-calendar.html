<script>
  // --- CAREGIVER CALENDAR LOGIC ---
  let currentCalendarDate = new Date();
  let currentMiniMonthDate = new Date();
  let calendarViewMode = "week";
  let calendarPerspective = "caregiver"; // 'caregiver' or 'client'
  let selectedPersonId = "all";
  let caregiverColors = {};

  const DAY_MS = 24 * 60 * 60 * 1000;
  let currentModalShift = null;

  function loadCaregiverCalendar() {
    // Ensure caregiver and client data are loaded
    if (cgData.length === 0 || clData.length === 0) {
      // Load both in parallel
      let cgLoaded = false;
      let clLoaded = false;

      const checkBothLoaded = () => {
        if (cgLoaded && clLoaded) {
          updateCalendarViewToggle();
          renderPersonList();
          updatePersonDropdown();
          renderActiveCalendar();
          renderMiniMonthCalendar();
        }
      };

      google.script.run
        .withSuccessHandler((data) => {
          cgData = data;
          cgLoaded = true;
          checkBothLoaded();
        })
        .getCaregiverList();

      google.script.run
        .withSuccessHandler((data) => {
          clData = data;
          clLoaded = true;
          checkBothLoaded();
        })
        .getClientList();
    } else {
      // Data already loaded, just render
      updateCalendarViewToggle();
      renderPersonList();
      updatePersonDropdown();
      renderActiveCalendar();
      renderMiniMonthCalendar();
    }
  }

  function getCaregiverColor(id) {
    if (!id) return "#e5e7eb"; // gray-200 default
    if (!caregiverColors[id]) {
      // Generate a consistent color based on ID string
      let hash = 0;
      for (let i = 0; i < id.length; i++) {
        hash = id.charCodeAt(i) + ((hash << 5) - hash);
      }
      // HSL: clear to read colors, avoid too bright/dark
      const hue = Math.abs(hash % 360);
      caregiverColors[id] = `hsl(${hue}, 70%, 80%)`;
    }
    return caregiverColors[id];
  }

  function renderPersonList() {
    const listContainer = document.getElementById("caregiverList");
    const titleElement = document.getElementById("sidePanelTitle");
    listContainer.innerHTML = "";

    const isCaregiver = calendarPerspective === "caregiver";
    titleElement.textContent = isCaregiver ? "Caregivers" : "Clients";

    // "All" option
    const allItem = document.createElement("div");
    allItem.className = `flex items-center gap-2 p-2 rounded cursor-pointer transition-colors ${
      selectedPersonId === "all"
        ? "bg-blue-50 border border-blue-200"
        : "hover:bg-gray-50 border border-transparent"
    }`;
    allItem.onclick = () => selectPerson("all");
    allItem.innerHTML = `
        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
        <span class="text-sm font-medium text-gray-700">All ${
          isCaregiver ? "Caregivers" : "Clients"
        }</span>
    `;
    listContainer.appendChild(allItem);

    const data = isCaregiver ? cgData : clData;

    if (data && data.length > 0) {
      data.forEach((p) => {
        const color = isCaregiver
          ? getCaregiverColor(p.id)
          : getCaregiverColor(p.id); // Or generate client colors? Use same for now.
        const isSelected = selectedPersonId === p.id;

        const name = isCaregiver
          ? p.name
          : `${p.firstName || ""} ${p.lastName || ""}`.trim();

        const item = document.createElement("div");
        item.className = `flex items-center gap-2 p-2 rounded cursor-pointer transition-colors ${
          isSelected
            ? "bg-gray-100 border border-gray-300"
            : "hover:bg-gray-50 border border-transparent"
        }`;
        item.onclick = () => selectPerson(p.id);
        item.innerHTML = `
                <div class="w-3 h-3 rounded-full border border-gray-300" style="background-color: ${color}"></div>
                <span class="text-sm text-gray-700 truncate">${name}</span>
            `;
        listContainer.appendChild(item);
      });
    } else {
      listContainer.innerHTML += `<div class="text-xs text-gray-400 text-center mt-2">No ${
        isCaregiver ? "caregivers" : "clients"
      } found</div>`;
    }
  }

  function updatePersonDropdown() {
    const selector = document.getElementById("personSelector");
    if (!selector) return;

    const isCaregiver = calendarPerspective === "caregiver";
    selector.innerHTML = `<option value="all">All ${
      isCaregiver ? "Caregivers" : "Clients"
    }</option>`;

    const data = isCaregiver ? cgData : clData;
    if (data && data.length > 0) {
      data.forEach((p) => {
        const name = isCaregiver
          ? p.name
          : `${p.firstName || ""} ${p.lastName || ""}`.trim();
        const option = document.createElement("option");
        option.value = p.id;
        option.textContent = name;
        if (selectedPersonId === p.id) option.selected = true;
        selector.appendChild(option);
      });
    }
  }

  function switchPerspective() {
    calendarPerspective = document.getElementById("calendarPerspective").value;
    selectedPersonId = "all";
    renderPersonList();
    updatePersonDropdown();
    renderActiveCalendar();
  }

  function selectPerson(id) {
    selectedPersonId = id;
    const selector = document.getElementById("personSelector");
    if (selector) selector.value = id;
    renderPersonList();
    renderActiveCalendar();
  }

  function setCalendarView(view) {
    calendarViewMode = view;
    if (view === "week" || view === "biweekly") {
      currentCalendarDate = getStartOfWeek(currentCalendarDate);
    }
    if (view === "month") {
      currentMiniMonthDate = new Date(currentCalendarDate);
      renderMiniMonthCalendar();
    }
    updateCalendarViewToggle();
    renderActiveCalendar();
  }

  function changePeriod(offset) {
    const workingDate = new Date(currentCalendarDate);

    if (calendarViewMode === "day") {
      workingDate.setDate(workingDate.getDate() + offset);
      currentCalendarDate = workingDate;
    } else if (calendarViewMode === "week") {
      const start = getStartOfWeek(workingDate);
      start.setDate(start.getDate() + offset * 7);
      currentCalendarDate = start;
    } else if (calendarViewMode === "biweekly") {
      const start = getStartOfWeek(workingDate);
      start.setDate(start.getDate() + offset * 14);
      currentCalendarDate = start;
    } else if (calendarViewMode === "month") {
      workingDate.setMonth(workingDate.getMonth() + offset);
      currentCalendarDate = workingDate;
      currentMiniMonthDate = new Date(workingDate);
      renderMiniMonthCalendar();
    }

    renderActiveCalendar();
  }

  // Backward compatibility with existing calls
  function changeWeek(offset) {
    changePeriod(offset);
  }

  function changeMiniMonth(offset) {
    currentMiniMonthDate.setMonth(currentMiniMonthDate.getMonth() + offset);
    renderMiniMonthCalendar();
  }

  function renderActiveCalendar() {
    if (calendarViewMode === "day") {
      renderDayCalendar();
    } else if (calendarViewMode === "week") {
      renderWeekCalendar();
    } else if (calendarViewMode === "biweekly") {
      renderBiweeklyCalendar();
    } else {
      renderMonthCalendar();
    }
  }

  function getStartOfWeek(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() - d.getDay());
    return d;
  }

  function toISODate(date) {
    const d = new Date(date);
    const yr = d.getFullYear();
    const mo = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${yr}-${mo}-${da}`;
  }

  function isSameDate(a, b) {
    return a && b && a.toDateString() === b.toDateString();
  }

  function isShiftOnDate(shift, dateStr) {
    if (shift.date === dateStr) return true;
    if (shift.endDate && shift.endDate >= dateStr && shift.date <= dateStr)
      return true;
    return false;
  }

  function updateCalendarViewToggle() {
    const buttons = document.querySelectorAll(
      "#calendarViewToggle .calendar-view-btn",
    );
    buttons.forEach((btn) => {
      const isActive = btn.dataset.view === calendarViewMode;
      btn.classList.toggle("bg-[#65c027]", isActive);
      btn.classList.toggle("text-white", isActive);
      btn.classList.toggle("shadow", isActive);
      btn.classList.toggle("text-gray-600", !isActive);
    });
  }

  function createShiftCard(shift) {
    const cg = cgData.find((c) => c.id === shift.caregiverId);
    const cl = clData.find((c) => c.id === shift.clientId);

    // Better fallback names
    const cgName = cg ? cg.name : `CG-${shift.caregiverId || "Unknown"}`;
    const clName = cl
      ? `${cl.firstName || ""} ${cl.lastName || ""}`.trim()
      : `Client-${shift.clientId || "Unknown"}`;

    const color = getCaregiverColor(shift.caregiverId);

    // Format time display
    const timeDisplay =
      shift.clockIn && shift.clockOut
        ? `${shift.clockIn} - ${shift.clockOut}`
        : "Time TBD";

    const dateRangeDisplay = shift.endDate
      ? `${shift.date} to ${shift.endDate}`
      : `${shift.date}`;

    // Add suffixes based on perspective
    let displayClName = clName;
    let displayCgName = cgName;

    if (calendarPerspective === "client") {
      displayClName = `${clName} (CL)`;
    } else if (calendarPerspective === "caregiver") {
      displayCgName = `${cgName} (CG)`;
    }

    const card = document.createElement("div");
    card.className =
      "p-2 rounded border shadow-sm text-xs hover:shadow-md transition cursor-pointer mb-1";
    // Apply background color dynamically
    card.style.backgroundColor = color;
    card.style.borderColor = "rgba(0,0,0,0.1)";

    // Add click handler to show shift details
    card.onclick = () => {
      openShiftDetailsModal(shift);
    };

    const totalHoursDisplay = calculateTotalHours(
      shift.clockIn,
      shift.clockOut,
    );

    card.innerHTML = `
      <div class="font-bold text-gray-800 truncate" title="${displayClName}">${displayClName}</div>
      <div class="text-gray-700 truncate font-medium" title="${displayCgName}">${displayCgName}</div>
      <div class="mt-1 flex flex-col text-[10px] text-gray-600 font-semibold border-t border-black/10 pt-1">
        <span>${timeDisplay}</span>
        <span class="opacity-80">${totalHoursDisplay}</span>
      </div>
    `;
    return card;
  }

  // --- TIME GRID HELPERS ---
  const PIXELS_PER_HOUR = 60;
  const PIXELS_PER_HOUR_WEEK = 32;

  function parseTime(timeStr) {
    if (!timeStr) return null;
    // ensure string
    const s = String(timeStr);
    const parts = s.split(":");
    if (parts.length < 2) return null;
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
  }

  function calculateTotalHours(startStr, endStr) {
    const start = parseTime(startStr);
    const end = parseTime(endStr);
    if (start === null || end === null) return "";
    let diff = end - start;
    if (diff < 0) diff += 1440;
    const hours = diff / 60;
    return hours.toFixed(2).replace(/\.?0+$/, "") + " hrs";
  }

  function layoutShifts(shifts) {
    if (!shifts || shifts.length === 0) return [];

    // Sort by start time
    const sorted = shifts
      .map((s) => ({ ...s }))
      .sort((a, b) => {
        const startA = parseTime(a.clockIn) || 0;
        const startB = parseTime(b.clockIn) || 0;
        return startA - startB;
      });

    // Simple overlapping column logic
    const packers = [];

    sorted.forEach((shift) => {
      const start = parseTime(shift.clockIn) || 0;
      const end = parseTime(shift.clockOut) || start + 60; // default 1h

      let colIdx = -1;
      // Find first column where this fits
      for (let i = 0; i < packers.length; i++) {
        if (packers[i] <= start) {
          colIdx = i;
          break;
        }
      }

      if (colIdx === -1) {
        colIdx = packers.length;
        packers.push(end);
      } else {
        packers[colIdx] = end;
      }

      shift._col = colIdx;
    });

    return sorted.map((s) => ({
      ...s,
      left: s._col * 15, // 15% indent per overlap level
      width: Math.max(30, 95 - s._col * 15), // shrink width but keep min 30%
      zIndex: s._col + 10,
    }));
  }

  function createTimeShiftCard(shift, pph = PIXELS_PER_HOUR) {
    const cg = cgData.find((c) => c.id === shift.caregiverId);
    const cl = clData.find((c) => c.id === shift.clientId);
    const cgName = cg ? cg.name : `${shift.caregiverId || "CG"}`;
    const clName = cl
      ? `${cl.firstName || ""} ${cl.lastName || ""}`.trim()
      : "Client";

    const color = getCaregiverColor(shift.caregiverId);

    const start = parseTime(shift.clockIn);
    const end = parseTime(shift.clockOut);

    // If no valid time, use old card format
    if (start === null || end === null) return createShiftCard(shift);

    const isWeek = calendarViewMode === "week";
    const top = (start / 60) * pph;
    const duration = (end - start) / 60;

    // Add suffixes based on perspective
    let displayName = clName;
    if (calendarPerspective === "client") {
      displayName = `${clName} (CL)`;
    } else if (calendarPerspective === "caregiver") {
      displayName = `${cgName} (CG)`;
    }

    const div = document.createElement("div");

    if (isWeek) {
      // Flow layout for Week View
      div.className =
        "relative rounded border-l-4 shadow-sm p-1.5 cursor-pointer hover:shadow-md transition-all flex flex-col justify-center overflow-hidden w-full shrink-0 mb-1";
      div.style.height = "52px"; // Increased height as requested
      div.style.backgroundColor = color;
      div.style.borderLeftColor = "rgba(0,0,0,0.3)";
      div.style.color = "#1f2937";

      div.innerHTML = `
        <div class="font-bold text-[10px] truncate leading-tight">${displayName}</div>
        <div class="text-[9px] truncate opacity-80 leading-tight">${shift.clockIn} - ${shift.clockOut}</div>
        <div class="text-[8px] truncate opacity-60 mt-0.5">${calculateTotalHours(
          shift.clockIn,
          shift.clockOut,
        )}</div>
      `;
    } else {
      // Absolute positioning for Day View
      const height = Math.max(duration * pph, 30);
      div.className =
        "absolute rounded border-l-4 shadow-sm p-1 cursor-pointer hover:z-50 hover:shadow-md transition-all flex flex-col justify-start overflow-hidden";
      div.style.top = `${top}px`;
      div.style.height = `${height}px`;
      div.style.backgroundColor = color;
      div.style.borderLeftColor = "rgba(0,0,0,0.3)";
      div.style.left = `${shift.left}%`;
      div.style.width = `${shift.width}%`;
      div.style.zIndex = shift.zIndex;
      div.style.color = "#1f2937";

      div.innerHTML = `
        <div class="font-bold text-xs truncate">${displayName}</div>
        <div class="text-[10px] truncate opacity-80">${shift.clockIn} - ${shift.clockOut}</div>
        <div class="text-[8px] truncate opacity-70 mt-0.5">${calculateTotalHours(
          shift.clockIn,
          shift.clockOut,
        )}</div>
      `;
    }

    div.onclick = (e) => {
      e.stopPropagation();
      openShiftDetailsModal(shift);
    };
    return div;
  }

  function renderDayCalendar() {
    const grid = document.getElementById("weekGrid");
    // Hide static header for day view
    if (grid.previousElementSibling)
      grid.previousElementSibling.style.display = "none";

    grid.className = "flex flex-col h-full bg-white relative overflow-hidden";

    const day = new Date(currentCalendarDate);
    const label = day.toLocaleDateString("en-US", {
      weekday: "long",
      month: "long",
      day: "numeric",
      year: "numeric",
    });
    document.getElementById("currentWeekLabel").textContent = label;

    grid.innerHTML =
      '<div id="calendar-loading" class="absolute inset-0 flex items-center justify-center text-gray-400 z-[60] bg-white bg-opacity-80">Loading...</div>';

    // Header
    const headerRow = document.createElement("div");
    headerRow.className =
      "border-b border-gray-200 bg-gray-50 p-2 text-center flex-none";
    headerRow.innerHTML = `
        <div class="text-xs uppercase text-gray-500 font-bold">${day.toLocaleDateString(
          "en-US",
          { weekday: "long" },
        )}</div>
        <div class="text-2xl font-bold text-gray-800">${day.getDate()}</div>
    `;
    grid.appendChild(headerRow);

    // Scrollable Timeline
    const scrollContainer = document.createElement("div");
    scrollContainer.className = "flex-1 overflow-y-auto relative";

    const container = document.createElement("div");
    container.className = "relative min-h-[1440px] border-l border-gray-100";
    container.style.height = `${24 * PIXELS_PER_HOUR}px`;

    // Hour markers
    for (let i = 0; i < 24; i++) {
      const row = document.createElement("div");
      row.className =
        "absolute w-full border-t border-gray-100 text-xs text-gray-300 pl-2 pointer-events-none";
      row.style.top = `${i * PIXELS_PER_HOUR}px`;
      row.innerHTML = `<span class="-mt-2 block">${i}:00</span>`;
      container.appendChild(row);
    }

    scrollContainer.appendChild(container);
    grid.appendChild(scrollContainer);

    const dateStr = toISODate(day);

    google.script.run
      .withSuccessHandler((shifts) => {
        const dayShifts = (shifts || []).filter((s) => {
          if (!isShiftOnDate(s, dateStr)) return false;

          // Filter by perspective type (must have relevant person assigned)
          if (calendarPerspective === "caregiver" && !s.caregiverId)
            return false;
          if (calendarPerspective === "client" && !s.clientId) return false;

          if (selectedPersonId !== "all") {
            if (
              calendarPerspective === "caregiver" &&
              s.caregiverId !== selectedPersonId
            )
              return false;
            if (
              calendarPerspective === "client" &&
              s.clientId !== selectedPersonId
            )
              return false;
          }
          return true;
        });

        const laidOut = layoutShifts(dayShifts);

        // Remove loading overlay
        const loader = document.getElementById("calendar-loading");
        if (loader) loader.remove();

        laidOut.forEach((s) => {
          if (!s.clockIn || !s.clockOut) {
            // Render flat card at top?
            // For simplified UI, let's put them in a dedicated container at top of `container`?
            // Or just don't handle them perfectly now, fallback to generic card appended (flow layout)
          } else {
            container.appendChild(createTimeShiftCard(s));
          }
        });

        scrollContainer.scrollTop = 8 * PIXELS_PER_HOUR;
      })
      .withFailureHandler((error) => {
        console.error("Error loading shifts:", error);
        const loader = document.getElementById("calendar-loading");
        if (loader) {
          loader.textContent = "Error loading data";
          loader.classList.add("text-red-500");
        }
      })
      .getShifts(dateStr, dateStr);
  }

  function renderWeekCalendar() {
    const grid = document.getElementById("weekGrid");
    if (grid.previousElementSibling)
      grid.previousElementSibling.style.display = "none";

    grid.className = "flex flex-col h-full bg-white relative overflow-hidden";

    // Label
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    const options = { month: "short", day: "numeric" };
    const label = `${startOfWeek.toLocaleDateString(
      "en-US",
      options,
    )} - ${endOfWeek.toLocaleDateString("en-US", {
      ...options,
      year: "numeric",
    })}`;
    document.getElementById("currentWeekLabel").textContent = label;

    grid.innerHTML =
      '<div id="calendar-loading" class="absolute inset-0 flex items-center justify-center text-gray-400 z-[60] bg-white bg-opacity-80">Loading...</div>';

    // Header Row
    const headerRow = document.createElement("div");
    headerRow.className =
      "grid grid-cols-7 border-b border-gray-200 bg-gray-50 flex-none";

    for (let i = 0; i < 7; i++) {
      const d = new Date(startOfWeek);
      d.setDate(d.getDate() + i);
      const isToday = isSameDate(d, new Date());

      const th = document.createElement("div");
      th.className = `p-1 text-center ${
        isToday ? "text-[#65c027] bg-green-50/20" : "text-gray-600"
      }`;
      th.innerHTML = `
           <div class="text-[10px] uppercase font-bold text-gray-400">${d.toLocaleDateString(
             "en-US",
             { weekday: "short" },
           )}</div>
           <div class="text-sm font-bold">${d.getDate()}</div>
        `;
      headerRow.appendChild(th);
    }
    grid.appendChild(headerRow);

    // Scroll Area
    const scrollContainer = document.createElement("div");
    scrollContainer.className = "flex-1 overflow-y-auto relative";
    scrollContainer.id = "week-scroll-container";

    const bodyFlex = document.createElement("div");
    bodyFlex.className = "grid grid-cols-7 min-h-full bg-gray-50/30";

    // Columns
    const dayCols = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(startOfWeek);
      d.setDate(d.getDate() + i);
      const dateStr = toISODate(d);
      const isToday = isSameDate(d, new Date());

      const colDiv = document.createElement("div");
      colDiv.className = `relative h-full border-r border-gray-100 flex flex-col p-1 gap-1 ${
        isToday ? "bg-green-50/10" : ""
      }`;
      colDiv.dataset.date = dateStr;

      bodyFlex.appendChild(colDiv);
      dayCols.push(colDiv);
    }

    scrollContainer.appendChild(bodyFlex);
    grid.appendChild(scrollContainer);

    const startStr = toISODate(startOfWeek);
    const endStr = toISODate(endOfWeek);

    google.script.run
      .withSuccessHandler((shifts) => {
        shifts = shifts || [];

        // Remove loading overlay
        const loader = document.getElementById("calendar-loading");
        if (loader) loader.remove();

        dayCols.forEach((col) => {
          const dateStr = col.dataset.date;
          const myShifts = shifts.filter((s) => {
            if (!isShiftOnDate(s, dateStr)) return false;

            // Filter by perspective type
            if (calendarPerspective === "caregiver" && !s.caregiverId)
              return false;
            if (calendarPerspective === "client" && !s.clientId) return false;

            if (selectedPersonId !== "all") {
              if (
                calendarPerspective === "caregiver" &&
                s.caregiverId !== selectedPersonId
              )
                return false;
              if (
                calendarPerspective === "client" &&
                s.clientId !== selectedPersonId
              )
                return false;
            }
            return true;
          });
          const laidOut = layoutShifts(myShifts);
          laidOut.forEach((s) => {
            const card = createTimeShiftCard(s, PIXELS_PER_HOUR_WEEK);
            col.appendChild(card);
          });
        });
        scrollContainer.scrollTop = 0;
      })
      .withFailureHandler((error) => {
        console.error("Error loading shifts:", error);
        const loader = document.getElementById("calendar-loading");
        if (loader) {
          loader.textContent = "Error loading data";
          loader.classList.add("text-red-500");
        }
      })
      .getShifts(startStr, endStr);
  }

  function renderBiweeklyCalendar() {
    const grid = document.getElementById("weekGrid");
    if (grid.previousElementSibling)
      grid.previousElementSibling.style.display = "grid";

    grid.className = "grid grid-cols-7 flex-1 overflow-y-auto auto-rows-fr";
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    const start = getStartOfWeek(currentCalendarDate);
    const end = new Date(start);
    end.setDate(start.getDate() + 13);

    const labelOptions = { month: "short", day: "numeric" };
    const label = `${start.toLocaleDateString(
      "en-US",
      labelOptions,
    )} - ${end.toLocaleDateString("en-US", {
      ...labelOptions,
      year: "numeric",
    })}`;
    document.getElementById("currentWeekLabel").textContent = label;

    const startStr = toISODate(start);
    const endStr = toISODate(end);
    const currentWeekStart = getStartOfWeek(new Date());
    const currentWeekEnd = new Date(currentWeekStart);
    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

    google.script.run
      .withSuccessHandler((shifts) => {
        shifts = shifts || [];
        grid.innerHTML = "";

        for (let i = 0; i < 14; i++) {
          const currentDay = new Date(start);
          currentDay.setDate(start.getDate() + i);
          const dateStr = toISODate(currentDay);

          const isToday = isSameDate(new Date(), currentDay);
          const inCurrentWeek =
            currentDay >= currentWeekStart && currentDay <= currentWeekEnd;
          const columnHighlight = isToday
            ? "bg-green-50 border-green-300"
            : inCurrentWeek
              ? "bg-gray-50"
              : "bg-white";

          const col = document.createElement("div");
          col.className = `border border-gray-100 min-h-[320px] flex flex-col ${columnHighlight}`;
          col.innerHTML = `
            <div class="p-2 text-center border-b border-gray-100">
              <div class="text-xs font-semibold text-gray-500">${currentDay.toLocaleDateString(
                "en-US",
                { weekday: "short" },
              )}</div>
              <span class="text-lg font-bold block text-gray-800">${currentDay.getDate()}</span>
            </div>
            <div class="flex-1 p-2 space-y-2" id="day-${dateStr}"></div>
          `;
          grid.appendChild(col);

          const dayShifts = shifts.filter((s) => {
            if (!isShiftOnDate(s, dateStr)) return false;

            // Filter by perspective type
            if (calendarPerspective === "caregiver" && !s.caregiverId)
              return false;
            if (calendarPerspective === "client" && !s.clientId) return false;

            if (selectedPersonId !== "all") {
              if (
                calendarPerspective === "caregiver" &&
                s.caregiverId !== selectedPersonId
              )
                return false;
              if (
                calendarPerspective === "client" &&
                s.clientId !== selectedPersonId
              )
                return false;
            }
            return true;
          });
          const container = col.querySelector(`#day-${dateStr}`);
          if (dayShifts.length > 0) {
            dayShifts.forEach((s) => container.appendChild(createShiftCard(s)));
          }
        }
      })
      .withFailureHandler((error) => {
        console.error("Error loading shifts:", error);
        grid.innerHTML =
          '<div class="col-span-7 text-center p-4 text-red-500">Error loading shifts. Please try again.</div>';
      })
      .getShifts(startStr, endStr);
  }

  function renderMonthCalendar() {
    const grid = document.getElementById("weekGrid");
    if (grid.previousElementSibling)
      grid.previousElementSibling.style.display = "grid";

    grid.className = "grid grid-cols-7 flex-1 overflow-y-auto auto-rows-fr";
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    document.getElementById("currentWeekLabel").textContent =
      firstDay.toLocaleDateString("en-US", { month: "long", year: "numeric" });

    const startGrid = getStartOfWeek(firstDay);
    const endGrid = getStartOfWeek(lastDay);
    endGrid.setDate(endGrid.getDate() + 6);

    const startStr = toISODate(firstDay);
    const endStr = toISODate(lastDay);

    const today = new Date();
    const currentWeekStart = getStartOfWeek(today);
    const currentWeekEnd = new Date(currentWeekStart);
    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

    google.script.run
      .withSuccessHandler((shifts) => {
        shifts = shifts || [];
        grid.innerHTML = "";

        const shiftMap = {};
        shifts.forEach((s) => {
          if (!s.endDate || s.endDate === s.date) {
            shiftMap[s.date] = shiftMap[s.date] || [];
            shiftMap[s.date].push(s);
          } else {
            // Multi-day expansion
            const partsStart = s.date.split("-");
            const partsEnd = s.endDate.split("-");
            if (partsStart.length === 3 && partsEnd.length === 3) {
              const current = new Date(
                partsStart[0],
                partsStart[1] - 1,
                partsStart[2],
              );
              const end = new Date(partsEnd[0], partsEnd[1] - 1, partsEnd[2]);

              let safe = 0;
              while (current <= end && safe < 365) {
                const dStr = toISODate(current);
                shiftMap[dStr] = shiftMap[dStr] || [];
                shiftMap[dStr].push(s);
                current.setDate(current.getDate() + 1);
                safe++;
              }
            } else {
              // Fallback
              shiftMap[s.date] = shiftMap[s.date] || [];
              shiftMap[s.date].push(s);
            }
          }
        });

        const totalDays = Math.round((endGrid - startGrid) / DAY_MS) + 1;

        for (let i = 0; i < totalDays; i++) {
          const currentDay = new Date(startGrid);
          currentDay.setDate(startGrid.getDate() + i);
          const dateStr = toISODate(currentDay);

          const isToday = isSameDate(today, currentDay);
          const inCurrentWeek =
            currentDay >= currentWeekStart && currentDay <= currentWeekEnd;
          const inCurrentMonth = currentDay.getMonth() === month;

          let background = inCurrentMonth ? "bg-white" : "bg-gray-50";
          if (inCurrentWeek) {
            background = "bg-gray-100";
          }
          if (isToday) {
            background = "bg-green-50 border-green-300";
          }

          const cell = document.createElement("div");
          cell.className = `border border-gray-100 min-h-[140px] flex flex-col ${background}`;
          cell.innerHTML = `
            <div class="p-2 border-b border-gray-100 flex items-center justify-between">
              <span class="text-sm font-semibold ${
                inCurrentMonth ? "text-gray-800" : "text-gray-400"
              }">${currentDay.getDate()}</span>
              <span class="text-[11px] text-gray-400">${currentDay.toLocaleDateString(
                "en-US",
                { weekday: "short" },
              )}</span>
            </div>
            <div class="flex-1 p-2 space-y-2 overflow-y-auto" id="day-${dateStr}"></div>
          `;

          const dayShifts = (shiftMap[dateStr] || []).filter((s) => {
            // Filter by perspective type
            if (calendarPerspective === "caregiver" && !s.caregiverId)
              return false;
            if (calendarPerspective === "client" && !s.clientId) return false;

            if (selectedPersonId !== "all") {
              if (
                calendarPerspective === "caregiver" &&
                s.caregiverId !== selectedPersonId
              )
                return false;
              if (
                calendarPerspective === "client" &&
                s.clientId !== selectedPersonId
              )
                return false;
            }
            return true;
          });
          const container = cell.querySelector(`#day-${dateStr}`);
          if (dayShifts.length > 0) {
            dayShifts.forEach((s) => container.appendChild(createShiftCard(s)));
          }

          grid.appendChild(cell);
        }
      })
      .withFailureHandler((error) => {
        console.error("Error loading shifts:", error);
        grid.innerHTML =
          '<div class="col-span-7 text-center p-4 text-red-500">Error loading shifts. Please try again.</div>';
      })
      .getShifts(startStr, endStr);
  }

  function renderMiniMonthCalendar() {
    const grid = document.getElementById("miniMonthGrid");
    grid.innerHTML = "";

    const year = currentMiniMonthDate.getFullYear();
    const month = currentMiniMonthDate.getMonth();

    document.getElementById("miniMonthLabel").textContent =
      currentMiniMonthDate.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric",
      });

    const today = new Date();
    const currentWeekStart = getStartOfWeek(today);
    const currentWeekEnd = new Date(currentWeekStart);
    currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Empty cells for start padding
    for (let i = 0; i < firstDay.getDay(); i++) {
      grid.appendChild(document.createElement("div"));
    }

    // Days
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const d = new Date(year, month, i);
      const isToday = isSameDate(today, d);
      const inCurrentWeek = d >= currentWeekStart && d <= currentWeekEnd;

      const cell = document.createElement("div");
      cell.className = `p-1 rounded-full cursor-pointer hover:bg-gray-100 ${
        isToday
          ? "bg-[#65c027] text-white font-bold border border-[#65c027]"
          : inCurrentWeek
            ? "bg-gray-200 text-gray-800 font-semibold"
            : "text-gray-700"
      }`;
      cell.textContent = i;
      cell.onclick = () => {
        currentCalendarDate = new Date(year, month, i);
        renderActiveCalendar();
      };
      grid.appendChild(cell);
    }
  }

  function openShiftDetailsModal(shift) {
    const modal = document.getElementById("shiftDetailsModal");
    const content = document.getElementById("shiftDetailsContent");
    if (!modal || !content) return;

    const cg = cgData.find((c) => c.id === shift.caregiverId);
    const cl = clData.find((c) => c.id === shift.clientId);
    const cgName = cg ? cg.name : shift.caregiverId;
    const clName = cl
      ? `${cl.firstName || ""} ${cl.lastName || ""}`.trim()
      : shift.clientId;

    currentModalShift = shift; // Store for actions

    content.innerHTML = `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase">Client</label>
                <div class="text-sm font-bold text-gray-800">${clName}</div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase">Caregiver</label>
                <div class="text-sm font-bold text-gray-800">${cgName}</div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
             <div>
                <label class="block text-xs font-medium text-gray-500 uppercase">Start Date</label>
                <div class="text-sm font-semibold text-gray-700">${
                  shift.date || "-"
                }</div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase">End Date</label>
                <div class="text-sm font-semibold text-gray-700">${
                  shift.endDate || shift.date || "-"
                }</div>
            </div>
             <div>
                <label class="block text-xs font-medium text-gray-500 uppercase">Clock In</label>
                <div class="text-sm font-semibold text-gray-700">${
                  shift.clockIn || "-"
                }</div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase">Clock Out</label>
                <div class="text-sm font-semibold text-gray-700">${
                  shift.clockOut || "-"
                }</div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="bg-blue-50 p-2 rounded border border-blue-100">
                <div class="text-blue-600 font-bold mb-1">Billing Type</div>
                <div>${shift.billingType || "-"}</div>
            </div>
            <div class="bg-green-50 p-2 rounded border border-green-100">
                <div class="text-green-600 font-bold mb-1">Service Type</div>
                <div>${shift.serviceType || "-"}</div>
            </div>
            <div class="bg-purple-50 p-2 rounded border border-purple-100">
                <div class="text-purple-600 font-bold mb-1">Shift Type</div>
                <div>${shift.shiftType || "-"}</div>
            </div>
        </div>

        <div class="border-t pt-3 mt-2">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Financials</h4>
             <div class="grid grid-cols-2 gap-4 text-xs">
                <div>
                    <span class="text-gray-500">Rate (Client):</span>
                    <span class="font-bold text-gray-800">$${
                      shift.clientRate || "0.00"
                    }</span>
                </div>
                  <div>
                    <span class="text-gray-500">Total (Client):</span>
                     <span class="font-bold text-blue-700">$${
                       shift.totalClientPrice || "0.00"
                     }</span>
                </div>
                <div>
                    <span class="text-gray-500">Rate (Caregiver):</span>
                    <span class="font-bold text-gray-800">$${
                      shift.caregiverRate || "0.00"
                    }</span>
                </div>
                 <div>
                    <span class="text-gray-500">Total (Caregiver):</span>
                     <span class="font-bold text-green-700">$${
                       shift.totalCaregiverPrice || "0.00"
                     }</span>
                </div>
                 <div>
                    <span class="text-gray-500">Hours:</span>
                    <span class="font-bold text-gray-800">${
                      shift.hours || "0"
                    }</span>
                </div>
             </div>
        </div>
        
        ${
          shift.notes
            ? `
        <div class="border-t pt-3 mt-2">
             <label class="block text-xs font-medium text-gray-500 uppercase">Notes</label>
             <div class="text-sm text-gray-600 bg-yellow-50 p-2 rounded border border-yellow-100 mt-1">${shift.notes}</div>
        </div>
        `
            : ""
        }

      </div>
      </div>
      <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
        <div class="flex gap-2">
            <button
            onclick="deleteShiftFromModal()"
            class="px-3 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg font-medium flex items-center gap-2 border border-red-200 transition"
            >
            <i class="ph ph-trash"></i> Delete
            </button>
             <button
            onclick="editShiftFromModal()"
            class="px-3 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg font-medium flex items-center gap-2 border border-blue-200 transition"
            >
            <i class="ph ph-pencil-simple"></i> Edit
            </button>
        </div>        
      </div>
    `;

    modal.classList.remove("hidden");
  }

  function editShiftFromModal() {
    if (!currentModalShift) return;
    closeShiftDetailsModal();
    // Assumes loadShiftForEdit is available globally (from js-shifts.html)
    if (typeof loadShiftForEdit === "function") {
      loadShiftForEdit(currentModalShift);
    } else {
      console.error("loadShiftForEdit not found");
    }
  }

  function deleteShiftFromModal() {
    if (!currentModalShift) return;

    Swal.fire({
      title: "Delete Shift?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        // Show loading state?
        // Simple way for now

        google.script.run
          .withSuccessHandler(() => {
            Swal.fire("Deleted!", "The shift has been deleted.", "success");
            closeShiftDetailsModal();
            renderActiveCalendar(); // Refresh calendar
          })
          .withFailureHandler((err) => {
            Swal.fire("Error", "Failed to delete: " + err.message, "error");
          })
          .deleteShift(currentModalShift.id);
      }
    });
  }

  function closeShiftDetailsModal() {
    const modal = document.getElementById("shiftDetailsModal");
    if (modal) modal.classList.add("hidden");
  }

  function downloadPDF() {
    const calendarView = document.querySelector("#view-caregiver-calendar");
    if (!calendarView) return;

    // Show loading alert
    Swal.fire({
      title: "Preparing PDF...",
      text: "Please wait while we generate your calendar document.",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    // Create a container for the PDF content
    const element = document.createElement("div");
    element.className = "bg-white p-8 font-sans";
    element.style.width = "1100px"; // Fixed width for better A4 landscape scaling

    // Add Logo/Header
    const labelDate = document.getElementById("currentWeekLabel").textContent;
    const perspectiveName =
      calendarPerspective === "caregiver" ? "Caregiver" : "Client";
    const personName =
      selectedPersonId === "all"
        ? `All ${perspectiveName}s`
        : document.querySelector("#personSelector option:checked")
            ?.textContent || perspectiveName;

    const header = document.createElement("div");
    header.className =
      "flex items-center justify-between mb-8 pb-4 border-b-2 border-[#65c027]";
    header.innerHTML = `
      <div class="flex items-center gap-2 text-[#65c027] font-bold text-3xl">
        <i class="ph ph-heart-beat text-4xl"></i>
        <div class="flex flex-col">
          <span>Allevia Senior Care</span>
          <span class="text-xs text-gray-400 font-normal uppercase tracking-widest">Premium Care Management</span>
        </div>
      </div>
      <div class="text-right">
        <h2 class="text-2xl font-bold text-gray-800">${labelDate}</h2>
        <p class="text-lg font-semibold text-[#65c027]">${personName} Schedule</p>
        <p class="text-xs text-gray-400 mt-1">Generated on: ${new Date().toLocaleString()}</p>
      </div>
    `;
    element.appendChild(header);

    // Clone the main calendar section (weekly grid)
    const calendarMain = document
      .querySelector("#view-caregiver-calendar .flex-1.flex.flex-col")
      .cloneNode(true);

    // Remove the interactive header (selectors, buttons) from the clone
    const interactiveHeader = calendarMain.querySelector(
      ".flex.items-center.justify-between.mb-4",
    );
    if (interactiveHeader) interactiveHeader.remove();

    // Clean up the grid for print
    const grid = calendarMain.querySelector("#weekGrid");
    if (grid) {
      grid.style.height = "auto";
      grid.style.overflow = "visible";
      grid.style.display = "grid";
      grid.classList.remove("overflow-y-auto");

      // Handle the scroll container if it exists (for Day/Week views)
      const scrollContainer = grid.querySelector("#week-scroll-container");
      if (scrollContainer) {
        scrollContainer.style.height = "auto";
        scrollContainer.style.overflow = "visible";
        scrollContainer.classList.remove("overflow-y-auto");

        const bodyFlex = scrollContainer.querySelector(".grid");
        if (bodyFlex) {
          bodyFlex.style.minHeight = "auto";
        }
      }
    }

    element.appendChild(calendarMain);

    // Add a footer
    const footer = document.createElement("div");
    footer.className =
      "mt-8 pt-4 border-t border-gray-100 text-center text-xs text-gray-400";
    footer.innerHTML = `
      <p>&copy; ${new Date().getFullYear()} Allevia Senior Care. All rights reserved.</p>
    `;
    element.appendChild(footer);

    // Add temporary to body to ensure styles apply
    element.style.position = "absolute";
    element.style.left = "-9999px";
    element.style.top = "0";
    document.body.appendChild(element);

    // Options for html2pdf
    const opt = {
      margin: 10,
      filename: `Allevia_Schedule_${labelDate.replace(/[^a-z0-9]/gi, "_")}.pdf`,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        letterRendering: true,
        logging: false,
      },
      jsPDF: { unit: "mm", format: "a4", orientation: "landscape" },
    };

    // Run html2pdf
    html2pdf()
      .set(opt)
      .from(element)
      .save()
      .then(() => {
        document.body.removeChild(element);
        Swal.close();
      })
      .catch((err) => {
        console.error("PDF Error:", err);
        document.body.removeChild(element);
        Swal.fire("Error", "Failed to generate PDF: " + err.message, "error");
      });
  }
</script>
