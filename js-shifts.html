<script>
  function loadShiftView() {
    // Load Clients
    const clientSelect = document.getElementById("shiftClient");
    clientSelect.innerHTML = '<option value="">Loading...</option>';
    google.script.run
      .withSuccessHandler((data) => {
        let html = '<option value="">Select Client...</option>';
        data
          .filter(
            (item) =>
              item.stage === "Convert Clients" && item.status === "Active",
          )
          .forEach((item) => {
            html += `<option value="${item.id}">${item.name}</option>`;
          });
        clientSelect.innerHTML = html;
        // If we are editing, we might need to set the value after loading
        if (window._pendingShiftEdit) {
          clientSelect.value = window._pendingShiftEdit.clientId;
        }
      })
      .getClientList();

    // Load Caregivers
    const cgSelect = document.getElementById("shiftCaregiver");
    cgSelect.innerHTML = '<option value="">Loading...</option>';
    google.script.run
      .withSuccessHandler((data) => {
        let html = '<option value="">Select Caregiver...</option>';
        data
          .filter((item) => item.status === "Active")
          .forEach((item) => {
            html += `<option value="${item.id}">${item.name}</option>`;
          });
        cgSelect.innerHTML = html;
        if (window._pendingShiftEdit) {
          cgSelect.value = window._pendingShiftEdit.caregiverId;
          delete window._pendingShiftEdit; // Clear after use
        }
      })
      .getCaregiverList();

    // Reset form state slightly
    resetShiftFormState();
  }

  function resetShiftFormState() {
    document.getElementById("shiftForm").reset();
    document.getElementById("shiftId").value = "";
    document.getElementById("btnSaveShift").innerHTML =
      '<i class="ph ph-check-circle text-lg"></i> Save Shift';
    document.querySelector("h2").textContent = "Add New Shift";

    // Show repeat options again if hid
    const repeatSection = document
      .querySelector('input[name="repeat"]')
      .closest(".mb-6");
    if (repeatSection) repeatSection.style.display = "block";

    calculateShiftCosts();
  }

  function loadShiftForEdit(shift) {
    // Navigate to view
    appNavigate("shifts");

    // Store for select mapping if data isn't loaded yet
    window._pendingShiftEdit = shift;

    // Populate fields
    document.getElementById("shiftId").value = shift.id;
    document.getElementById("shiftClient").value = shift.clientId;
    document.getElementById("shiftCaregiver").value = shift.caregiverId;
    document.querySelector('input[name="startDate"]').value = shift.date;
    document.querySelector('input[name="endDate"]').value =
      shift.endDate || shift.date;
    document.getElementById("clockIn").value = shift.clockIn;
    document.getElementById("clockOut").value = shift.clockOut;

    document.getElementById("billingType").value = shift.billingType;
    document.querySelector('select[name="serviceType"]').value =
      shift.serviceType;
    document.querySelector('select[name="shiftType"]').value = shift.shiftType;

    document.getElementById("clientRate").value = shift.clientRate;
    document.getElementById("caregiverRate").value = shift.caregiverRate;
    document.querySelector('textarea[name="notes"]').value = shift.notes || "";

    // Update UI state
    document.getElementById("btnSaveShift").innerHTML =
      '<i class="ph ph-check-circle text-lg"></i> Update Shift';
    document.querySelector("h2").textContent = "Edit Shift";

    // Hide repeat options for edit mode (simpler MVP)
    const repeatSection = document
      .querySelector('input[name="repeat"]')
      .closest(".mb-6");
    if (repeatSection) repeatSection.style.display = "none";

    // Recalculate derived
    calculateShiftHours();
    calculateShiftCosts();
  }

  function calculateShiftHours() {
    const clockIn = document.getElementById("clockIn").value;
    const clockOut = document.getElementById("clockOut").value;
    const hoursInput = document.getElementById("shiftHours");

    if (clockIn && clockOut) {
      const start = new Date(`1970-01-01T${clockIn}:00`);
      const end = new Date(`1970-01-01T${clockOut}:00`);

      let diff = (end - start) / 1000 / 60 / 60; // hours
      if (diff < 0) diff += 24; // Handle overnight

      hoursInput.value = diff.toFixed(2);
      calculateShiftCosts(); // Recalculate costs when hours change
    }
  }

  function calculateShiftCosts() {
    const billingType = document.getElementById("billingType").value;
    const hours = parseFloat(document.getElementById("shiftHours").value) || 0;
    const clientRate =
      parseFloat(document.getElementById("clientRate").value) || 0;
    const caregiverRate =
      parseFloat(document.getElementById("caregiverRate").value) || 0;

    // Calculate Agency & Softcare Share
    // Logic: (Client Rate - Caregiver Rate) split 80% Agency, 20% Softcare
    const margin = Math.max(0, clientRate - caregiverRate);
    const agency = margin * 0.8;
    const softcare = margin * 0.2;

    document.getElementById("agencyShare").value = agency.toFixed(2);
    document.getElementById("softcareShare").value = softcare.toFixed(2);

    // Calculate Totals
    let totalClient = 0;
    let totalCaregiver = 0;
    let totalAgency = 0;
    let totalSoftcare = 0;

    if (billingType === "Hourly") {
      totalClient = clientRate * hours;
      totalCaregiver = caregiverRate * hours;
      totalAgency = agency * hours;
      totalSoftcare = softcare * hours;
    } else {
      // Fixed Rate
      totalClient = clientRate;
      totalCaregiver = caregiverRate;
      totalAgency = agency;
      totalSoftcare = softcare;
    }

    document.getElementById("totalClientPrice").value =
      "$" + totalClient.toFixed(2);
    document.getElementById("totalCaregiverPrice").value =
      "$" + totalCaregiver.toFixed(2);
    document.getElementById("totalAgencyPrice").value =
      "$" + totalAgency.toFixed(2);
    document.getElementById("totalSoftcarePrice").value =
      "$" + totalSoftcare.toFixed(2);
  }

  function submitShift(e) {
    e.preventDefault();
    const btn = document.getElementById("btnSaveShift");
    const originalText = btn.innerHTML;

    const form = document.getElementById("shiftForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Add calculated values
    data.agencyShare = document.getElementById("agencyShare").value;
    data.softcareShare = document.getElementById("softcareShare").value;
    data.totalClientPrice = document
      .getElementById("totalClientPrice")
      .value.replace("$", "");
    data.totalCaregiverPrice = document
      .getElementById("totalCaregiverPrice")
      .value.replace("$", "");
    data.totalAgencyPrice = document
      .getElementById("totalAgencyPrice")
      .value.replace("$", "");
    data.totalSoftcarePrice = document
      .getElementById("totalSoftcarePrice")
      .value.replace("$", "");

    btn.disabled = true;
    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Saving...';

    const isUpdate = !!data.shiftId;
    const handler = isUpdate ? "updateShift" : "saveShift";

    google.script.run
      .withSuccessHandler(() => {
        Swal.fire(
          "Success",
          isUpdate
            ? "Shift updated successfully!"
            : "Shift saved successfully!",
          "success",
        );
        if (isUpdate) {
          // Return to calendar? Or just reset?
          // Often better to stay or offer to go back.
          // For now, let's reset to add mode.
          resetShiftFormState();
        } else {
          resetShiftFormState();
        }

        btn.disabled = false;
        btn.innerHTML = originalText;
      })
      .withFailureHandler((err) => {
        Swal.fire(
          "Error",
          `Failed to ${isUpdate ? "update" : "save"} shift: ` + err.message,
          "error",
        );
        btn.disabled = false;
        btn.innerHTML = originalText;
      })
      [handler](data);
  }
</script>
